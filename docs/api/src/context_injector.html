<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>src.context_injector API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../src.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;src</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#ContextInjector">ContextInjector</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ContextInjector.__init__">ContextInjector</a>
                        </li>
                        <li>
                                <a class="variable" href="#ContextInjector.max_context_size">max_context_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#ContextInjector.include_raw_data">include_raw_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#ContextInjector.context_format">context_format</a>
                        </li>
                        <li>
                                <a class="function" href="#ContextInjector.prepare_security_context">prepare_security_context</a>
                        </li>
                        <li>
                                <a class="function" href="#ContextInjector.prepare_attack_report_context">prepare_attack_report_context</a>
                        </li>
                        <li>
                                <a class="function" href="#ContextInjector.prepare_query_context">prepare_query_context</a>
                        </li>
                        <li>
                                <a class="function" href="#ContextInjector.inject_context_for_chatgpt">inject_context_for_chatgpt</a>
                        </li>
                        <li>
                                <a class="function" href="#ContextInjector.create_mcp_context_injection">create_mcp_context_injection</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../src.html">src</a><wbr>.context_injector    </h1>

                        <div class="docstring"><p>Context injector for preparing data for ChatGPT context injection.</p>

<p>This module provides utilities for preparing and formatting security data
for injection into ChatGPT conversations. It handles various data types
including security events, threat intelligence, attack reports, and query
results, formatting them appropriately for AI consumption.</p>

<p>Features:</p>

<ul>
<li>Security context preparation and formatting</li>
<li>Attack report context injection</li>
<li>Query result formatting</li>
<li>MCP-compatible context injection</li>
<li>Multiple output formats (structured, summary, raw)</li>
<li>ChatGPT-optimized formatting</li>
</ul>

<p>Example:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>from <a href="">src.context_injector</a> import ContextInjector
      injector = ContextInjector()
      context = injector.prepare_security_context(events, threat_intel)
      formatted = injector.inject_context_for_chatgpt(context)</p>
    </blockquote>
  </blockquote>
</blockquote>
</div>

                        <input id="mod-context_injector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-context_injector-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Context injector for preparing data for ChatGPT context injection.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">This module provides utilities for preparing and formatting security data</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">for injection into ChatGPT conversations. It handles various data types</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">including security events, threat intelligence, attack reports, and query</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">results, formatting them appropriately for AI consumption.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">Features:</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">- Security context preparation and formatting</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">- Attack report context injection</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">- Query result formatting</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">- MCP-compatible context injection</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">- Multiple output formats (structured, summary, raw)</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">- ChatGPT-optimized formatting</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">Example:</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    &gt;&gt;&gt; from src.context_injector import ContextInjector</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    &gt;&gt;&gt; injector = ContextInjector()</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    &gt;&gt;&gt; context = injector.prepare_security_context(events, threat_intel)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">    &gt;&gt;&gt; formatted = injector.inject_context_for_chatgpt(context)</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">datetime</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">structlog</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="c1"># Load environment variables</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ContextInjector</span><span class="p">:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare and inject security context for ChatGPT analysis.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    This class provides methods to prepare and format various types of</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    security data for injection into ChatGPT conversations. It supports</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    multiple output formats and optimizes data for AI consumption.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    Attributes:</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        max_context_size: Maximum context size in characters</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        include_raw_data: Whether to include raw data in context</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        context_format: Output format (structured, summary, or raw)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    Example:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        &gt;&gt;&gt; injector = ContextInjector()</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        &gt;&gt;&gt; context = injector.prepare_security_context(events)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        &gt;&gt;&gt; formatted = injector.inject_context_for_chatgpt(context)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ContextInjector.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        Loads configuration from environment variables for context</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        formatting preferences and size limits.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_context_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAX_CONTEXT_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">))</span>  <span class="c1"># characters</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;INCLUDE_RAW_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>            <span class="s2">&quot;CONTEXT_FORMAT&quot;</span><span class="p">,</span> <span class="s2">&quot;structured&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="p">)</span>  <span class="c1"># structured, summary, or raw</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_security_context</span><span class="p">(</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare security context for injection.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        Creates a comprehensive security context from events, threat</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">        intelligence, and summary data, formatted according to the</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        configured context format preference.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">        Args:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">            events: List of security event dictionaries</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">            summary: Optional summary data</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        Returns:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">            Dictionary containing formatted security context</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;security_analysis&quot;</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="p">}</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="c1"># Add events based on format preference</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># raw</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>                <span class="n">events</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="c1"># Add threat intelligence</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;threat_intelligence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_threat_intelligence</span><span class="p">(</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>                <span class="n">threat_intelligence</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="c1"># Add summary if provided</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="c1"># Add metadata</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_metadata</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">threat_intelligence</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="c1"># Add analysis hints</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_analysis_hints</span><span class="p">(</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">events</span><span class="p">,</span> <span class="n">threat_intelligence</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_attack_report_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare attack report context for injection.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="sd">        Formats an attack report for injection into ChatGPT conversations,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        including metadata and confidence information.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        Args:</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">            report: Attack report dictionary</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a><span class="sd">        Returns:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="sd">            Dictionary containing formatted attack report context</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;attack_report&quot;</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>                <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_attack_report</span><span class="p">(</span><span class="n">report</span><span class="p">),</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                    <span class="s2">&quot;report_id&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;report_id&quot;</span><span class="p">),</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence_level&quot;</span><span class="p">),</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                <span class="p">},</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="p">},</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="p">}</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_query_context</span><span class="p">(</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>        <span class="n">query_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare query context for injection.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">        Formats query results and parameters for injection into ChatGPT</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        conversations, including metadata about the query execution.</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        Args:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">            query_type: Type of query that was executed</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">            parameters: Query parameters that were used</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">            results: Query results to format</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">        Returns:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">            Dictionary containing formatted query context</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;query_results&quot;</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>                <span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="n">query_type</span><span class="p">,</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_results</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="s2">&quot;result_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>                    <span class="s2">&quot;query_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>                    <span class="s2">&quot;result_format&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span><span class="p">,</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>                <span class="p">},</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="p">},</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="p">}</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">inject_context_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format context for ChatGPT consumption.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        Converts a context dictionary into a string format optimized</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">        for ChatGPT consumption, handling different context types</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">        appropriately.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        Args:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">            context: Context dictionary to format</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">        Returns:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="c1"># Convert context to a readable format for ChatGPT</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;security_analysis&quot;</span><span class="p">:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_security_context_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;attack_report&quot;</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_attack_report_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;query_results&quot;</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_results_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mcp_context_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create MCP-compatible context injection.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        Formats context data for use with the Model Context Protocol (MCP),</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        including proper metadata and version information.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        Args:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            context: Context dictionary to format</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        Returns:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">            Dictionary formatted for MCP protocol</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="c1"># Format for MCP protocol</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="n">mcp_context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;context_injection&quot;</span><span class="p">,</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">],</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_context_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;dshield-elastic-mcp&quot;</span><span class="p">,</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;structured_text&quot;</span><span class="p">,</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="p">},</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="p">}</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="k">return</span> <span class="n">mcp_context</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_structure_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Structure events for better analysis.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        Converts raw event data into a structured format optimized</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        for analysis, organizing network information and metadata.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        Args:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">            events: List of raw event dictionaries</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">        Returns:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">            List of structured event dictionaries</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">structured_events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="n">structured_event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">),</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">),</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">),</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                <span class="s2">&quot;network_info&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                    <span class="s2">&quot;source_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">),</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                    <span class="s2">&quot;destination_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">),</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                    <span class="s2">&quot;source_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_port&quot;</span><span class="p">),</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                    <span class="s2">&quot;destination_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_port&quot;</span><span class="p">),</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                    <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">),</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                <span class="p">},</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="p">}</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>            <span class="c1"># Add raw data if enabled</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="ow">and</span> <span class="s2">&quot;raw_data&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">structured_event</span><span class="p">[</span><span class="s2">&quot;raw_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;raw_data&quot;</span><span class="p">]</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>            <span class="n">structured_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structured_event</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="k">return</span> <span class="n">structured_events</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a summary of events instead of full details.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">        Generates a summary of events including counts by severity,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        category, and unique IP addresses for efficient context injection.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        Args:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">            events: List of event dictionaries to summarize</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a><span class="sd">        Returns:</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">            Dictionary containing event summary</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No events found&quot;</span><span class="p">}</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>        <span class="c1"># Count by severity</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="n">severity_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>            <span class="n">severity</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="n">severity_counts</span><span class="p">[</span><span class="n">severity</span><span class="p">]</span> <span class="o">=</span> <span class="n">severity_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="c1"># Count by category</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="n">category_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="n">category</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">category_counts</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="c1"># Extract unique IPs</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="n">source_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="n">destination_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                <span class="n">source_ip</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;source_ip&quot;</span><span class="p">]</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_ip</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>                    <span class="n">source_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_ip</span><span class="p">))</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                    <span class="n">source_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_ip</span><span class="p">))</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="n">destination_ip</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                    <span class="n">destination_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">))</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>                    <span class="n">destination_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">))</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="c1"># Get sample events (first 5)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="n">sample_events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="s2">&quot;total_events&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="s2">&quot;severity_distribution&quot;</span><span class="p">:</span> <span class="n">severity_counts</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="s2">&quot;category_distribution&quot;</span><span class="p">:</span> <span class="n">category_counts</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="s2">&quot;unique_source_ips&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_ips</span><span class="p">),</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="s2">&quot;unique_destination_ips&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">destination_ips</span><span class="p">),</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="s2">&quot;sample_events&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">sample_events</span><span class="p">),</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="p">}</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean events by removing sensitive or unnecessary data.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">        Removes sensitive fields and unnecessary metadata from events</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">        while preserving essential information for analysis.</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        Args:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">            events: List of event dictionaries to clean</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="sd">        Returns:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a><span class="sd">            List of cleaned event dictionaries</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="n">cleaned_events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="n">cleaned_event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">),</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">),</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">),</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                <span class="s2">&quot;source_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">),</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                <span class="s2">&quot;destination_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">),</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                <span class="s2">&quot;source_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_port&quot;</span><span class="p">),</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                <span class="s2">&quot;destination_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_port&quot;</span><span class="p">),</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">),</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="p">}</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="c1"># Remove None values</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="n">cleaned_event</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cleaned_event</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="n">cleaned_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_event</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="k">return</span> <span class="n">cleaned_events</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_threat_intelligence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process threat intelligence data for context injection.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        Formats threat intelligence data for inclusion in context,</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        organizing it by IP address and threat level.</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">        Args:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">            threat_intelligence: Raw threat intelligence data</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">        Returns:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">            Processed threat intelligence dictionary</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">processed_ti</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="s2">&quot;total_ips&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_intelligence</span><span class="p">),</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="s2">&quot;high_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="s2">&quot;medium_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="s2">&quot;low_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="s2">&quot;unknown_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="p">}</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ti_data</span> <span class="ow">in</span> <span class="n">threat_intelligence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ti_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                <span class="n">threat_level</span> <span class="o">=</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threat_level&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>                <span class="n">ip_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>                    <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>                    <span class="s2">&quot;reputation_score&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">),</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;country&quot;</span><span class="p">),</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>                    <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;asn&quot;</span><span class="p">),</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>                    <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;organization&quot;</span><span class="p">),</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>                    <span class="s2">&quot;attack_types&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attack_types&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                <span class="p">}</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>                <span class="k">if</span> <span class="n">threat_level</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="k">elif</span> <span class="n">threat_level</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;medium_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="k">elif</span> <span class="n">threat_level</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;low_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;unknown_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="k">return</span> <span class="n">processed_ti</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_metadata</span><span class="p">(</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate metadata for the context.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="sd">        Creates metadata including time ranges, data sources, and</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a><span class="sd">        processing information for the context.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a><span class="sd">        Args:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">            events: List of events to analyze</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="sd">        Returns:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a><span class="sd">            Dictionary containing context metadata</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="s2">&quot;event_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            <span class="s2">&quot;time_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_time_range</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="s2">&quot;data_sources&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_data_sources</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="s2">&quot;threat_intelligence_available&quot;</span><span class="p">:</span> <span class="n">threat_intelligence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_intelligence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="p">}</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;threat_intelligence_ips&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_intelligence</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="k">return</span> <span class="n">metadata</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_analysis_hints</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate analysis hints for ChatGPT.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        Creates a list of analysis hints and suggestions based on</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">        the events and threat intelligence data.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        Args:</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">            events: List of events to analyze</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        Returns:</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">            List of analysis hints and suggestions</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="n">hints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="c1"># Analyze event patterns</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="n">high_severity_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">]</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="k">if</span> <span class="n">high_severity_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">high_severity_count</span><span class="si">}</span><span class="s2"> high/critical severity events requiring immediate attention&quot;</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="c1"># Check for threat intelligence hits</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="n">high_risk_ti</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>                <span class="mi">1</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>                <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">threat_intelligence</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threat_level&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="k">if</span> <span class="n">high_risk_ti</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                    <span class="sa">f</span><span class="s2">&quot;Identified </span><span class="si">{</span><span class="n">high_risk_ti</span><span class="si">}</span><span class="s2"> IP addresses with high threat intelligence scores&quot;</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="c1"># Check for attack patterns</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="n">attack_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_attack_patterns</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">attack_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> events matching </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2"> pattern&quot;</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="c1"># Add general analysis guidance</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="s2">&quot;Consider correlating events with threat intelligence for comprehensive analysis&quot;</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Look for patterns in source IPs, ports, and protocols&quot;</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Assess the potential impact and recommend mitigation strategies&quot;</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="k">return</span> <span class="n">hints</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_attack_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format attack report for context injection.</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">        Formats an attack report for inclusion in context, organizing</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">        it into sections for executive summary, details, and recommendations.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">        Args:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">            report: Raw attack report dictionary</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">        Returns:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">            Formatted attack report dictionary</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="n">formatted_report</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">),</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="s2">&quot;key_findings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>                <span class="s2">&quot;total_events&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_events&quot;</span><span class="p">),</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>                <span class="s2">&quot;unique_ips&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unique_ips&quot;</span><span class="p">),</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>                <span class="s2">&quot;high_risk_ips&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>                <span class="s2">&quot;attack_vectors&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attack_vectors&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>                <span class="s2">&quot;impact_assessment&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impact_assessment&quot;</span><span class="p">),</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="p">},</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recommendations&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="s2">&quot;mitigation_actions&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mitigation_actions&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="p">}</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="k">return</span> <span class="n">formatted_report</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format query results for context injection.</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">        Formats query results for inclusion in context, ensuring</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">        they are properly structured and readable.</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">        Args:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">            results: Raw query results list</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="sd">        Returns:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">            Formatted query results list</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_summarize_events</span><span class="p">(</span><span class="n">results</span><span class="p">)]</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_events</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_security_context_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format security context specifically for ChatGPT.</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a><span class="sd">        Converts security context data into a text format optimized</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a><span class="sd">        for ChatGPT consumption, including structured sections and</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a><span class="sd">        analysis guidance.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a><span class="sd">        Args:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a><span class="sd">            data: Security context data dictionary</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a><span class="sd">        Returns:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>        <span class="c1"># Add summary if available</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="n">summary</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== SECURITY SUMMARY ===&quot;</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Events: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Range: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_range_hours&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="si">}</span><span class="s2"> hours&quot;</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High Risk Events: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_risk_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="c1"># Add events</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="n">events</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;total_events&quot;</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                <span class="c1"># Summary format</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== EVENT SUMMARY ===&quot;</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Events: </span><span class="si">{</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;total_events&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                    <span class="sa">f</span><span class="s2">&quot;Severity Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                <span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                    <span class="sa">f</span><span class="s2">&quot;Category Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                <span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                <span class="k">if</span> <span class="s2">&quot;sample_events&quot;</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== SAMPLE EVENTS ===&quot;</span><span class="p">)</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">[</span><span class="s2">&quot;sample_events&quot;</span><span class="p">]:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                            <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No description&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                        <span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>                <span class="c1"># Full events format</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== SECURITY EVENTS ===&quot;</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Event: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Severity: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Description: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No description&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">):</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Source IP: </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;source_ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">):</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Destination IP: </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;destination_ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="c1"># Add threat intelligence</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="k">if</span> <span class="s2">&quot;threat_intelligence&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="n">ti</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;threat_intelligence&quot;</span><span class="p">]</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== THREAT INTELLIGENCE ===&quot;</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total IPs: </span><span class="si">{</span><span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High Risk IPs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_risk_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Medium Risk IPs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medium_risk_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>            <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">):</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;High Risk IPs:&quot;</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                <span class="k">for</span> <span class="n">ip_info</span> <span class="ow">in</span> <span class="n">ti</span><span class="p">[</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">]:</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>                        <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">ip_info</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Score: </span><span class="si">{</span><span class="n">ip_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reputation_score&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>                    <span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="c1"># Add analysis hints</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="k">if</span> <span class="s2">&quot;analysis_hints&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== ANALYSIS HINTS ===&quot;</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="k">for</span> <span class="n">hint</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;analysis_hints&quot;</span><span class="p">]:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">hint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_attack_report_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format attack report specifically for ChatGPT.</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a><span class="sd">        Converts attack report data into a text format optimized</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a><span class="sd">        for ChatGPT consumption, including executive summary and</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a><span class="sd">        detailed analysis sections.</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a><span class="sd">        Args:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">            data: Attack report data dictionary</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a><span class="sd">        Returns:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>        <span class="n">report</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">]</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== ATTACK REPORT ===&quot;</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Executive Summary:&quot;</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;No summary available&quot;</span><span class="p">))</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="c1"># Key findings</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>        <span class="n">findings</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_findings&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Key Findings:&quot;</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total Events: </span><span class="si">{</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Unique IPs: </span><span class="si">{</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unique_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- High Risk IPs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_risk_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Attack Vectors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attack_vectors&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Impact: </span><span class="si">{</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;impact_assessment&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="c1"># Recommendations</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recommendations&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="k">if</span> <span class="n">recommendations</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Recommendations:&quot;</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="c1"># Mitigation actions</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="n">actions</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mitigation_actions&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Immediate Actions:&quot;</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_query_results_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format query results specifically for ChatGPT.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a><span class="sd">        Converts query results data into a text format optimized</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a><span class="sd">        for ChatGPT consumption, including query parameters and</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a><span class="sd">        result summaries.</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="sd">        Args:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">            data: Query results data dictionary</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">        Returns:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== QUERY RESULTS (</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) ===&quot;</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result Count: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;total_events&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>            <span class="c1"># Summary format</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Event Summary:&quot;</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total Events: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_events&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>                <span class="sa">f</span><span class="s2">&quot;- Severity Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>            <span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>                <span class="sa">f</span><span class="s2">&quot;- Category Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>            <span class="p">)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>            <span class="c1"># Full results format</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Limit to first 10</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Severity: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Description: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No description&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract time range from events.</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a><span class="sd">        Determines the earliest and latest timestamps from a list</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a><span class="sd">        of events to establish the time range.</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a><span class="sd">        Args:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a><span class="sd">            events: List of event dictionaries</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a><span class="sd">        Returns:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="sd">            Dictionary with &#39;start&#39; and &#39;end&#39; timestamps</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>            <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;isoformat&quot;</span><span class="p">):</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="k">if</span> <span class="n">timestamps</span><span class="p">:</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestamps</span><span class="p">),</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestamps</span><span class="p">),</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>            <span class="p">}</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract data sources from events.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">        Identifies the unique data sources (indices) from which</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">        the events were retrieved.</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a><span class="sd">        Args:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="sd">            events: List of event dictionaries</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="sd">        Returns:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">            List of unique data source names</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>        <span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>            <span class="k">if</span> <span class="s2">&quot;indices&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>                <span class="n">indices</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>                            <span class="n">sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>                            <span class="n">sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>                    <span class="n">sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_attack_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect attack patterns in events.</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a><span class="sd">        Analyzes events to identify common attack patterns and</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a><span class="sd">        their frequencies.</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a><span class="sd">        Args:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a><span class="sd">            events: List of event dictionaries</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a><span class="sd">        Returns:</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a><span class="sd">            Dictionary mapping attack patterns to their counts</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>            <span class="s2">&quot;brute_force&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>            <span class="s2">&quot;port_scan&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>            <span class="s2">&quot;sql_injection&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>            <span class="s2">&quot;xss&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>            <span class="s2">&quot;ddos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>            <span class="s2">&quot;malware&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>            <span class="s2">&quot;phishing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>            <span class="s2">&quot;reconnaissance&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>        <span class="p">}</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>            <span class="c1"># Robustly handle both strings and lists for description and event_type</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>            <span class="n">description_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">description_raw</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">description_raw</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>            <span class="n">event_type_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_type_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>                <span class="n">event_type</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">event_type_raw</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>                <span class="n">event_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event_type_raw</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;brute&quot;</span><span class="p">,</span> <span class="s2">&quot;auth&quot;</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>            <span class="p">):</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;brute_force&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;nmap&quot;</span><span class="p">]</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>            <span class="p">):</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;port_scan&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sql&quot;</span><span class="p">,</span> <span class="s2">&quot;injection&quot;</span><span class="p">]</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>            <span class="p">):</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;sql_injection&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;xss&quot;</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span><span class="p">]</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>            <span class="p">):</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;xss&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ddos&quot;</span><span class="p">,</span> <span class="s2">&quot;flood&quot;</span><span class="p">]</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>            <span class="p">):</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;ddos&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;malware&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">]</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>            <span class="p">):</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;malware&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;phishing&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">]</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>            <span class="p">):</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;phishing&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;recon&quot;</span><span class="p">,</span> <span class="s2">&quot;enumeration&quot;</span><span class="p">]</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>            <span class="p">):</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;reconnaissance&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<input id="logger-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="logger-view-value"></label><span class="default_value">&lt;BoundLoggerLazyProxy(logger=None, wrapper_class=None, processors=None, context_class=None, initial_values={}, logger_factory_args=(&#39;<a href="">src.context_injector</a>&#39;,))&gt;</span>


    </div>
    <a class="headerlink" href="#logger"></a>



                </section>
                <section id="ContextInjector">
                            <input id="ContextInjector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">

    <span class="def">class</span>
    <span class="name">ContextInjector</span>:

                <label class="view-source-button" for="ContextInjector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector-39"><a href="#ContextInjector-39"><span class="linenos"> 39</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ContextInjector</span><span class="p">:</span>
</span><span id="ContextInjector-40"><a href="#ContextInjector-40"><span class="linenos"> 40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare and inject security context for ChatGPT analysis.</span>
</span><span id="ContextInjector-41"><a href="#ContextInjector-41"><span class="linenos"> 41</span></a>
</span><span id="ContextInjector-42"><a href="#ContextInjector-42"><span class="linenos"> 42</span></a><span class="sd">    This class provides methods to prepare and format various types of</span>
</span><span id="ContextInjector-43"><a href="#ContextInjector-43"><span class="linenos"> 43</span></a><span class="sd">    security data for injection into ChatGPT conversations. It supports</span>
</span><span id="ContextInjector-44"><a href="#ContextInjector-44"><span class="linenos"> 44</span></a><span class="sd">    multiple output formats and optimizes data for AI consumption.</span>
</span><span id="ContextInjector-45"><a href="#ContextInjector-45"><span class="linenos"> 45</span></a>
</span><span id="ContextInjector-46"><a href="#ContextInjector-46"><span class="linenos"> 46</span></a><span class="sd">    Attributes:</span>
</span><span id="ContextInjector-47"><a href="#ContextInjector-47"><span class="linenos"> 47</span></a><span class="sd">        max_context_size: Maximum context size in characters</span>
</span><span id="ContextInjector-48"><a href="#ContextInjector-48"><span class="linenos"> 48</span></a><span class="sd">        include_raw_data: Whether to include raw data in context</span>
</span><span id="ContextInjector-49"><a href="#ContextInjector-49"><span class="linenos"> 49</span></a><span class="sd">        context_format: Output format (structured, summary, or raw)</span>
</span><span id="ContextInjector-50"><a href="#ContextInjector-50"><span class="linenos"> 50</span></a>
</span><span id="ContextInjector-51"><a href="#ContextInjector-51"><span class="linenos"> 51</span></a><span class="sd">    Example:</span>
</span><span id="ContextInjector-52"><a href="#ContextInjector-52"><span class="linenos"> 52</span></a><span class="sd">        &gt;&gt;&gt; injector = ContextInjector()</span>
</span><span id="ContextInjector-53"><a href="#ContextInjector-53"><span class="linenos"> 53</span></a><span class="sd">        &gt;&gt;&gt; context = injector.prepare_security_context(events)</span>
</span><span id="ContextInjector-54"><a href="#ContextInjector-54"><span class="linenos"> 54</span></a><span class="sd">        &gt;&gt;&gt; formatted = injector.inject_context_for_chatgpt(context)</span>
</span><span id="ContextInjector-55"><a href="#ContextInjector-55"><span class="linenos"> 55</span></a>
</span><span id="ContextInjector-56"><a href="#ContextInjector-56"><span class="linenos"> 56</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ContextInjector-57"><a href="#ContextInjector-57"><span class="linenos"> 57</span></a>
</span><span id="ContextInjector-58"><a href="#ContextInjector-58"><span class="linenos"> 58</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ContextInjector-59"><a href="#ContextInjector-59"><span class="linenos"> 59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ContextInjector.</span>
</span><span id="ContextInjector-60"><a href="#ContextInjector-60"><span class="linenos"> 60</span></a>
</span><span id="ContextInjector-61"><a href="#ContextInjector-61"><span class="linenos"> 61</span></a><span class="sd">        Loads configuration from environment variables for context</span>
</span><span id="ContextInjector-62"><a href="#ContextInjector-62"><span class="linenos"> 62</span></a><span class="sd">        formatting preferences and size limits.</span>
</span><span id="ContextInjector-63"><a href="#ContextInjector-63"><span class="linenos"> 63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-64"><a href="#ContextInjector-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_context_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAX_CONTEXT_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">))</span>  <span class="c1"># characters</span>
</span><span id="ContextInjector-65"><a href="#ContextInjector-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;INCLUDE_RAW_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
</span><span id="ContextInjector-66"><a href="#ContextInjector-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
</span><span id="ContextInjector-67"><a href="#ContextInjector-67"><span class="linenos"> 67</span></a>            <span class="s2">&quot;CONTEXT_FORMAT&quot;</span><span class="p">,</span> <span class="s2">&quot;structured&quot;</span>
</span><span id="ContextInjector-68"><a href="#ContextInjector-68"><span class="linenos"> 68</span></a>        <span class="p">)</span>  <span class="c1"># structured, summary, or raw</span>
</span><span id="ContextInjector-69"><a href="#ContextInjector-69"><span class="linenos"> 69</span></a>
</span><span id="ContextInjector-70"><a href="#ContextInjector-70"><span class="linenos"> 70</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_security_context</span><span class="p">(</span>
</span><span id="ContextInjector-71"><a href="#ContextInjector-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ContextInjector-72"><a href="#ContextInjector-72"><span class="linenos"> 72</span></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="ContextInjector-73"><a href="#ContextInjector-73"><span class="linenos"> 73</span></a>        <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ContextInjector-74"><a href="#ContextInjector-74"><span class="linenos"> 74</span></a>        <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ContextInjector-75"><a href="#ContextInjector-75"><span class="linenos"> 75</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-76"><a href="#ContextInjector-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare security context for injection.</span>
</span><span id="ContextInjector-77"><a href="#ContextInjector-77"><span class="linenos"> 77</span></a>
</span><span id="ContextInjector-78"><a href="#ContextInjector-78"><span class="linenos"> 78</span></a><span class="sd">        Creates a comprehensive security context from events, threat</span>
</span><span id="ContextInjector-79"><a href="#ContextInjector-79"><span class="linenos"> 79</span></a><span class="sd">        intelligence, and summary data, formatted according to the</span>
</span><span id="ContextInjector-80"><a href="#ContextInjector-80"><span class="linenos"> 80</span></a><span class="sd">        configured context format preference.</span>
</span><span id="ContextInjector-81"><a href="#ContextInjector-81"><span class="linenos"> 81</span></a>
</span><span id="ContextInjector-82"><a href="#ContextInjector-82"><span class="linenos"> 82</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-83"><a href="#ContextInjector-83"><span class="linenos"> 83</span></a><span class="sd">            events: List of security event dictionaries</span>
</span><span id="ContextInjector-84"><a href="#ContextInjector-84"><span class="linenos"> 84</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="ContextInjector-85"><a href="#ContextInjector-85"><span class="linenos"> 85</span></a><span class="sd">            summary: Optional summary data</span>
</span><span id="ContextInjector-86"><a href="#ContextInjector-86"><span class="linenos"> 86</span></a>
</span><span id="ContextInjector-87"><a href="#ContextInjector-87"><span class="linenos"> 87</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-88"><a href="#ContextInjector-88"><span class="linenos"> 88</span></a><span class="sd">            Dictionary containing formatted security context</span>
</span><span id="ContextInjector-89"><a href="#ContextInjector-89"><span class="linenos"> 89</span></a>
</span><span id="ContextInjector-90"><a href="#ContextInjector-90"><span class="linenos"> 90</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-91"><a href="#ContextInjector-91"><span class="linenos"> 91</span></a>        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-92"><a href="#ContextInjector-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector-93"><a href="#ContextInjector-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;security_analysis&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-94"><a href="#ContextInjector-94"><span class="linenos"> 94</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="ContextInjector-95"><a href="#ContextInjector-95"><span class="linenos"> 95</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-96"><a href="#ContextInjector-96"><span class="linenos"> 96</span></a>
</span><span id="ContextInjector-97"><a href="#ContextInjector-97"><span class="linenos"> 97</span></a>        <span class="c1"># Add events based on format preference</span>
</span><span id="ContextInjector-98"><a href="#ContextInjector-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-99"><a href="#ContextInjector-99"><span class="linenos"> 99</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector-100"><a href="#ContextInjector-100"><span class="linenos">100</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-101"><a href="#ContextInjector-101"><span class="linenos">101</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector-102"><a href="#ContextInjector-102"><span class="linenos">102</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># raw</span>
</span><span id="ContextInjector-103"><a href="#ContextInjector-103"><span class="linenos">103</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ContextInjector-104"><a href="#ContextInjector-104"><span class="linenos">104</span></a>                <span class="n">events</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector-105"><a href="#ContextInjector-105"><span class="linenos">105</span></a>            <span class="p">)</span>
</span><span id="ContextInjector-106"><a href="#ContextInjector-106"><span class="linenos">106</span></a>
</span><span id="ContextInjector-107"><a href="#ContextInjector-107"><span class="linenos">107</span></a>        <span class="c1"># Add threat intelligence</span>
</span><span id="ContextInjector-108"><a href="#ContextInjector-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="ContextInjector-109"><a href="#ContextInjector-109"><span class="linenos">109</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;threat_intelligence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_threat_intelligence</span><span class="p">(</span>
</span><span id="ContextInjector-110"><a href="#ContextInjector-110"><span class="linenos">110</span></a>                <span class="n">threat_intelligence</span>
</span><span id="ContextInjector-111"><a href="#ContextInjector-111"><span class="linenos">111</span></a>            <span class="p">)</span>
</span><span id="ContextInjector-112"><a href="#ContextInjector-112"><span class="linenos">112</span></a>
</span><span id="ContextInjector-113"><a href="#ContextInjector-113"><span class="linenos">113</span></a>        <span class="c1"># Add summary if provided</span>
</span><span id="ContextInjector-114"><a href="#ContextInjector-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
</span><span id="ContextInjector-115"><a href="#ContextInjector-115"><span class="linenos">115</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span>
</span><span id="ContextInjector-116"><a href="#ContextInjector-116"><span class="linenos">116</span></a>
</span><span id="ContextInjector-117"><a href="#ContextInjector-117"><span class="linenos">117</span></a>        <span class="c1"># Add metadata</span>
</span><span id="ContextInjector-118"><a href="#ContextInjector-118"><span class="linenos">118</span></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_metadata</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">threat_intelligence</span><span class="p">)</span>
</span><span id="ContextInjector-119"><a href="#ContextInjector-119"><span class="linenos">119</span></a>
</span><span id="ContextInjector-120"><a href="#ContextInjector-120"><span class="linenos">120</span></a>        <span class="c1"># Add analysis hints</span>
</span><span id="ContextInjector-121"><a href="#ContextInjector-121"><span class="linenos">121</span></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_analysis_hints</span><span class="p">(</span>
</span><span id="ContextInjector-122"><a href="#ContextInjector-122"><span class="linenos">122</span></a>            <span class="n">events</span><span class="p">,</span> <span class="n">threat_intelligence</span>
</span><span id="ContextInjector-123"><a href="#ContextInjector-123"><span class="linenos">123</span></a>        <span class="p">)</span>
</span><span id="ContextInjector-124"><a href="#ContextInjector-124"><span class="linenos">124</span></a>
</span><span id="ContextInjector-125"><a href="#ContextInjector-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="ContextInjector-126"><a href="#ContextInjector-126"><span class="linenos">126</span></a>
</span><span id="ContextInjector-127"><a href="#ContextInjector-127"><span class="linenos">127</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_attack_report_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-128"><a href="#ContextInjector-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare attack report context for injection.</span>
</span><span id="ContextInjector-129"><a href="#ContextInjector-129"><span class="linenos">129</span></a>
</span><span id="ContextInjector-130"><a href="#ContextInjector-130"><span class="linenos">130</span></a><span class="sd">        Formats an attack report for injection into ChatGPT conversations,</span>
</span><span id="ContextInjector-131"><a href="#ContextInjector-131"><span class="linenos">131</span></a><span class="sd">        including metadata and confidence information.</span>
</span><span id="ContextInjector-132"><a href="#ContextInjector-132"><span class="linenos">132</span></a>
</span><span id="ContextInjector-133"><a href="#ContextInjector-133"><span class="linenos">133</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-134"><a href="#ContextInjector-134"><span class="linenos">134</span></a><span class="sd">            report: Attack report dictionary</span>
</span><span id="ContextInjector-135"><a href="#ContextInjector-135"><span class="linenos">135</span></a>
</span><span id="ContextInjector-136"><a href="#ContextInjector-136"><span class="linenos">136</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-137"><a href="#ContextInjector-137"><span class="linenos">137</span></a><span class="sd">            Dictionary containing formatted attack report context</span>
</span><span id="ContextInjector-138"><a href="#ContextInjector-138"><span class="linenos">138</span></a>
</span><span id="ContextInjector-139"><a href="#ContextInjector-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-140"><a href="#ContextInjector-140"><span class="linenos">140</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-141"><a href="#ContextInjector-141"><span class="linenos">141</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector-142"><a href="#ContextInjector-142"><span class="linenos">142</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;attack_report&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-143"><a href="#ContextInjector-143"><span class="linenos">143</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-144"><a href="#ContextInjector-144"><span class="linenos">144</span></a>                <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_attack_report</span><span class="p">(</span><span class="n">report</span><span class="p">),</span>
</span><span id="ContextInjector-145"><a href="#ContextInjector-145"><span class="linenos">145</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-146"><a href="#ContextInjector-146"><span class="linenos">146</span></a>                    <span class="s2">&quot;report_id&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;report_id&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-147"><a href="#ContextInjector-147"><span class="linenos">147</span></a>                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence_level&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-148"><a href="#ContextInjector-148"><span class="linenos">148</span></a>                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector-149"><a href="#ContextInjector-149"><span class="linenos">149</span></a>                <span class="p">},</span>
</span><span id="ContextInjector-150"><a href="#ContextInjector-150"><span class="linenos">150</span></a>            <span class="p">},</span>
</span><span id="ContextInjector-151"><a href="#ContextInjector-151"><span class="linenos">151</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-152"><a href="#ContextInjector-152"><span class="linenos">152</span></a>
</span><span id="ContextInjector-153"><a href="#ContextInjector-153"><span class="linenos">153</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="ContextInjector-154"><a href="#ContextInjector-154"><span class="linenos">154</span></a>
</span><span id="ContextInjector-155"><a href="#ContextInjector-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_query_context</span><span class="p">(</span>
</span><span id="ContextInjector-156"><a href="#ContextInjector-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ContextInjector-157"><a href="#ContextInjector-157"><span class="linenos">157</span></a>        <span class="n">query_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="ContextInjector-158"><a href="#ContextInjector-158"><span class="linenos">158</span></a>        <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="ContextInjector-159"><a href="#ContextInjector-159"><span class="linenos">159</span></a>        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="ContextInjector-160"><a href="#ContextInjector-160"><span class="linenos">160</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-161"><a href="#ContextInjector-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare query context for injection.</span>
</span><span id="ContextInjector-162"><a href="#ContextInjector-162"><span class="linenos">162</span></a>
</span><span id="ContextInjector-163"><a href="#ContextInjector-163"><span class="linenos">163</span></a><span class="sd">        Formats query results and parameters for injection into ChatGPT</span>
</span><span id="ContextInjector-164"><a href="#ContextInjector-164"><span class="linenos">164</span></a><span class="sd">        conversations, including metadata about the query execution.</span>
</span><span id="ContextInjector-165"><a href="#ContextInjector-165"><span class="linenos">165</span></a>
</span><span id="ContextInjector-166"><a href="#ContextInjector-166"><span class="linenos">166</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-167"><a href="#ContextInjector-167"><span class="linenos">167</span></a><span class="sd">            query_type: Type of query that was executed</span>
</span><span id="ContextInjector-168"><a href="#ContextInjector-168"><span class="linenos">168</span></a><span class="sd">            parameters: Query parameters that were used</span>
</span><span id="ContextInjector-169"><a href="#ContextInjector-169"><span class="linenos">169</span></a><span class="sd">            results: Query results to format</span>
</span><span id="ContextInjector-170"><a href="#ContextInjector-170"><span class="linenos">170</span></a>
</span><span id="ContextInjector-171"><a href="#ContextInjector-171"><span class="linenos">171</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-172"><a href="#ContextInjector-172"><span class="linenos">172</span></a><span class="sd">            Dictionary containing formatted query context</span>
</span><span id="ContextInjector-173"><a href="#ContextInjector-173"><span class="linenos">173</span></a>
</span><span id="ContextInjector-174"><a href="#ContextInjector-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-175"><a href="#ContextInjector-175"><span class="linenos">175</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-176"><a href="#ContextInjector-176"><span class="linenos">176</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector-177"><a href="#ContextInjector-177"><span class="linenos">177</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;query_results&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-178"><a href="#ContextInjector-178"><span class="linenos">178</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-179"><a href="#ContextInjector-179"><span class="linenos">179</span></a>                <span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="n">query_type</span><span class="p">,</span>
</span><span id="ContextInjector-180"><a href="#ContextInjector-180"><span class="linenos">180</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
</span><span id="ContextInjector-181"><a href="#ContextInjector-181"><span class="linenos">181</span></a>                <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_results</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span><span id="ContextInjector-182"><a href="#ContextInjector-182"><span class="linenos">182</span></a>                <span class="s2">&quot;result_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span><span id="ContextInjector-183"><a href="#ContextInjector-183"><span class="linenos">183</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-184"><a href="#ContextInjector-184"><span class="linenos">184</span></a>                    <span class="s2">&quot;query_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector-185"><a href="#ContextInjector-185"><span class="linenos">185</span></a>                    <span class="s2">&quot;result_format&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span><span class="p">,</span>
</span><span id="ContextInjector-186"><a href="#ContextInjector-186"><span class="linenos">186</span></a>                <span class="p">},</span>
</span><span id="ContextInjector-187"><a href="#ContextInjector-187"><span class="linenos">187</span></a>            <span class="p">},</span>
</span><span id="ContextInjector-188"><a href="#ContextInjector-188"><span class="linenos">188</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-189"><a href="#ContextInjector-189"><span class="linenos">189</span></a>
</span><span id="ContextInjector-190"><a href="#ContextInjector-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="n">context</span>
</span><span id="ContextInjector-191"><a href="#ContextInjector-191"><span class="linenos">191</span></a>
</span><span id="ContextInjector-192"><a href="#ContextInjector-192"><span class="linenos">192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">inject_context_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ContextInjector-193"><a href="#ContextInjector-193"><span class="linenos">193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format context for ChatGPT consumption.</span>
</span><span id="ContextInjector-194"><a href="#ContextInjector-194"><span class="linenos">194</span></a>
</span><span id="ContextInjector-195"><a href="#ContextInjector-195"><span class="linenos">195</span></a><span class="sd">        Converts a context dictionary into a string format optimized</span>
</span><span id="ContextInjector-196"><a href="#ContextInjector-196"><span class="linenos">196</span></a><span class="sd">        for ChatGPT consumption, handling different context types</span>
</span><span id="ContextInjector-197"><a href="#ContextInjector-197"><span class="linenos">197</span></a><span class="sd">        appropriately.</span>
</span><span id="ContextInjector-198"><a href="#ContextInjector-198"><span class="linenos">198</span></a>
</span><span id="ContextInjector-199"><a href="#ContextInjector-199"><span class="linenos">199</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-200"><a href="#ContextInjector-200"><span class="linenos">200</span></a><span class="sd">            context: Context dictionary to format</span>
</span><span id="ContextInjector-201"><a href="#ContextInjector-201"><span class="linenos">201</span></a>
</span><span id="ContextInjector-202"><a href="#ContextInjector-202"><span class="linenos">202</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-203"><a href="#ContextInjector-203"><span class="linenos">203</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="ContextInjector-204"><a href="#ContextInjector-204"><span class="linenos">204</span></a>
</span><span id="ContextInjector-205"><a href="#ContextInjector-205"><span class="linenos">205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-206"><a href="#ContextInjector-206"><span class="linenos">206</span></a>        <span class="c1"># Convert context to a readable format for ChatGPT</span>
</span><span id="ContextInjector-207"><a href="#ContextInjector-207"><span class="linenos">207</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;security_analysis&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-208"><a href="#ContextInjector-208"><span class="linenos">208</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_security_context_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="ContextInjector-209"><a href="#ContextInjector-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;attack_report&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-210"><a href="#ContextInjector-210"><span class="linenos">210</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_attack_report_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="ContextInjector-211"><a href="#ContextInjector-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;query_results&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-212"><a href="#ContextInjector-212"><span class="linenos">212</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_results_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="ContextInjector-213"><a href="#ContextInjector-213"><span class="linenos">213</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ContextInjector-214"><a href="#ContextInjector-214"><span class="linenos">214</span></a>
</span><span id="ContextInjector-215"><a href="#ContextInjector-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mcp_context_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-216"><a href="#ContextInjector-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create MCP-compatible context injection.</span>
</span><span id="ContextInjector-217"><a href="#ContextInjector-217"><span class="linenos">217</span></a>
</span><span id="ContextInjector-218"><a href="#ContextInjector-218"><span class="linenos">218</span></a><span class="sd">        Formats context data for use with the Model Context Protocol (MCP),</span>
</span><span id="ContextInjector-219"><a href="#ContextInjector-219"><span class="linenos">219</span></a><span class="sd">        including proper metadata and version information.</span>
</span><span id="ContextInjector-220"><a href="#ContextInjector-220"><span class="linenos">220</span></a>
</span><span id="ContextInjector-221"><a href="#ContextInjector-221"><span class="linenos">221</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-222"><a href="#ContextInjector-222"><span class="linenos">222</span></a><span class="sd">            context: Context dictionary to format</span>
</span><span id="ContextInjector-223"><a href="#ContextInjector-223"><span class="linenos">223</span></a>
</span><span id="ContextInjector-224"><a href="#ContextInjector-224"><span class="linenos">224</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-225"><a href="#ContextInjector-225"><span class="linenos">225</span></a><span class="sd">            Dictionary formatted for MCP protocol</span>
</span><span id="ContextInjector-226"><a href="#ContextInjector-226"><span class="linenos">226</span></a>
</span><span id="ContextInjector-227"><a href="#ContextInjector-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-228"><a href="#ContextInjector-228"><span class="linenos">228</span></a>        <span class="c1"># Format for MCP protocol</span>
</span><span id="ContextInjector-229"><a href="#ContextInjector-229"><span class="linenos">229</span></a>        <span class="n">mcp_context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-230"><a href="#ContextInjector-230"><span class="linenos">230</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;context_injection&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-231"><a href="#ContextInjector-231"><span class="linenos">231</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
</span><span id="ContextInjector-232"><a href="#ContextInjector-232"><span class="linenos">232</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">],</span>
</span><span id="ContextInjector-233"><a href="#ContextInjector-233"><span class="linenos">233</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_context_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span><span id="ContextInjector-234"><a href="#ContextInjector-234"><span class="linenos">234</span></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-235"><a href="#ContextInjector-235"><span class="linenos">235</span></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;dshield-elastic-mcp&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-236"><a href="#ContextInjector-236"><span class="linenos">236</span></a>                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-237"><a href="#ContextInjector-237"><span class="linenos">237</span></a>                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;structured_text&quot;</span><span class="p">,</span>
</span><span id="ContextInjector-238"><a href="#ContextInjector-238"><span class="linenos">238</span></a>            <span class="p">},</span>
</span><span id="ContextInjector-239"><a href="#ContextInjector-239"><span class="linenos">239</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-240"><a href="#ContextInjector-240"><span class="linenos">240</span></a>
</span><span id="ContextInjector-241"><a href="#ContextInjector-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="n">mcp_context</span>
</span><span id="ContextInjector-242"><a href="#ContextInjector-242"><span class="linenos">242</span></a>
</span><span id="ContextInjector-243"><a href="#ContextInjector-243"><span class="linenos">243</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_structure_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="ContextInjector-244"><a href="#ContextInjector-244"><span class="linenos">244</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Structure events for better analysis.</span>
</span><span id="ContextInjector-245"><a href="#ContextInjector-245"><span class="linenos">245</span></a>
</span><span id="ContextInjector-246"><a href="#ContextInjector-246"><span class="linenos">246</span></a><span class="sd">        Converts raw event data into a structured format optimized</span>
</span><span id="ContextInjector-247"><a href="#ContextInjector-247"><span class="linenos">247</span></a><span class="sd">        for analysis, organizing network information and metadata.</span>
</span><span id="ContextInjector-248"><a href="#ContextInjector-248"><span class="linenos">248</span></a>
</span><span id="ContextInjector-249"><a href="#ContextInjector-249"><span class="linenos">249</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-250"><a href="#ContextInjector-250"><span class="linenos">250</span></a><span class="sd">            events: List of raw event dictionaries</span>
</span><span id="ContextInjector-251"><a href="#ContextInjector-251"><span class="linenos">251</span></a>
</span><span id="ContextInjector-252"><a href="#ContextInjector-252"><span class="linenos">252</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-253"><a href="#ContextInjector-253"><span class="linenos">253</span></a><span class="sd">            List of structured event dictionaries</span>
</span><span id="ContextInjector-254"><a href="#ContextInjector-254"><span class="linenos">254</span></a>
</span><span id="ContextInjector-255"><a href="#ContextInjector-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-256"><a href="#ContextInjector-256"><span class="linenos">256</span></a>        <span class="n">structured_events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-257"><a href="#ContextInjector-257"><span class="linenos">257</span></a>
</span><span id="ContextInjector-258"><a href="#ContextInjector-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-259"><a href="#ContextInjector-259"><span class="linenos">259</span></a>            <span class="n">structured_event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-260"><a href="#ContextInjector-260"><span class="linenos">260</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-261"><a href="#ContextInjector-261"><span class="linenos">261</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-262"><a href="#ContextInjector-262"><span class="linenos">262</span></a>                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-263"><a href="#ContextInjector-263"><span class="linenos">263</span></a>                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-264"><a href="#ContextInjector-264"><span class="linenos">264</span></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-265"><a href="#ContextInjector-265"><span class="linenos">265</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-266"><a href="#ContextInjector-266"><span class="linenos">266</span></a>                <span class="s2">&quot;network_info&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-267"><a href="#ContextInjector-267"><span class="linenos">267</span></a>                    <span class="s2">&quot;source_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-268"><a href="#ContextInjector-268"><span class="linenos">268</span></a>                    <span class="s2">&quot;destination_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-269"><a href="#ContextInjector-269"><span class="linenos">269</span></a>                    <span class="s2">&quot;source_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_port&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-270"><a href="#ContextInjector-270"><span class="linenos">270</span></a>                    <span class="s2">&quot;destination_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_port&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-271"><a href="#ContextInjector-271"><span class="linenos">271</span></a>                    <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-272"><a href="#ContextInjector-272"><span class="linenos">272</span></a>                <span class="p">},</span>
</span><span id="ContextInjector-273"><a href="#ContextInjector-273"><span class="linenos">273</span></a>            <span class="p">}</span>
</span><span id="ContextInjector-274"><a href="#ContextInjector-274"><span class="linenos">274</span></a>
</span><span id="ContextInjector-275"><a href="#ContextInjector-275"><span class="linenos">275</span></a>            <span class="c1"># Add raw data if enabled</span>
</span><span id="ContextInjector-276"><a href="#ContextInjector-276"><span class="linenos">276</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="ow">and</span> <span class="s2">&quot;raw_data&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="ContextInjector-277"><a href="#ContextInjector-277"><span class="linenos">277</span></a>                <span class="n">structured_event</span><span class="p">[</span><span class="s2">&quot;raw_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;raw_data&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-278"><a href="#ContextInjector-278"><span class="linenos">278</span></a>
</span><span id="ContextInjector-279"><a href="#ContextInjector-279"><span class="linenos">279</span></a>            <span class="n">structured_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structured_event</span><span class="p">)</span>
</span><span id="ContextInjector-280"><a href="#ContextInjector-280"><span class="linenos">280</span></a>
</span><span id="ContextInjector-281"><a href="#ContextInjector-281"><span class="linenos">281</span></a>        <span class="k">return</span> <span class="n">structured_events</span>
</span><span id="ContextInjector-282"><a href="#ContextInjector-282"><span class="linenos">282</span></a>
</span><span id="ContextInjector-283"><a href="#ContextInjector-283"><span class="linenos">283</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-284"><a href="#ContextInjector-284"><span class="linenos">284</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a summary of events instead of full details.</span>
</span><span id="ContextInjector-285"><a href="#ContextInjector-285"><span class="linenos">285</span></a>
</span><span id="ContextInjector-286"><a href="#ContextInjector-286"><span class="linenos">286</span></a><span class="sd">        Generates a summary of events including counts by severity,</span>
</span><span id="ContextInjector-287"><a href="#ContextInjector-287"><span class="linenos">287</span></a><span class="sd">        category, and unique IP addresses for efficient context injection.</span>
</span><span id="ContextInjector-288"><a href="#ContextInjector-288"><span class="linenos">288</span></a>
</span><span id="ContextInjector-289"><a href="#ContextInjector-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-290"><a href="#ContextInjector-290"><span class="linenos">290</span></a><span class="sd">            events: List of event dictionaries to summarize</span>
</span><span id="ContextInjector-291"><a href="#ContextInjector-291"><span class="linenos">291</span></a>
</span><span id="ContextInjector-292"><a href="#ContextInjector-292"><span class="linenos">292</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-293"><a href="#ContextInjector-293"><span class="linenos">293</span></a><span class="sd">            Dictionary containing event summary</span>
</span><span id="ContextInjector-294"><a href="#ContextInjector-294"><span class="linenos">294</span></a>
</span><span id="ContextInjector-295"><a href="#ContextInjector-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-296"><a href="#ContextInjector-296"><span class="linenos">296</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-297"><a href="#ContextInjector-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No events found&quot;</span><span class="p">}</span>
</span><span id="ContextInjector-298"><a href="#ContextInjector-298"><span class="linenos">298</span></a>
</span><span id="ContextInjector-299"><a href="#ContextInjector-299"><span class="linenos">299</span></a>        <span class="c1"># Count by severity</span>
</span><span id="ContextInjector-300"><a href="#ContextInjector-300"><span class="linenos">300</span></a>        <span class="n">severity_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ContextInjector-301"><a href="#ContextInjector-301"><span class="linenos">301</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-302"><a href="#ContextInjector-302"><span class="linenos">302</span></a>            <span class="n">severity</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-303"><a href="#ContextInjector-303"><span class="linenos">303</span></a>            <span class="n">severity_counts</span><span class="p">[</span><span class="n">severity</span><span class="p">]</span> <span class="o">=</span> <span class="n">severity_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ContextInjector-304"><a href="#ContextInjector-304"><span class="linenos">304</span></a>
</span><span id="ContextInjector-305"><a href="#ContextInjector-305"><span class="linenos">305</span></a>        <span class="c1"># Count by category</span>
</span><span id="ContextInjector-306"><a href="#ContextInjector-306"><span class="linenos">306</span></a>        <span class="n">category_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ContextInjector-307"><a href="#ContextInjector-307"><span class="linenos">307</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-308"><a href="#ContextInjector-308"><span class="linenos">308</span></a>            <span class="n">category</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-309"><a href="#ContextInjector-309"><span class="linenos">309</span></a>            <span class="n">category_counts</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ContextInjector-310"><a href="#ContextInjector-310"><span class="linenos">310</span></a>
</span><span id="ContextInjector-311"><a href="#ContextInjector-311"><span class="linenos">311</span></a>        <span class="c1"># Extract unique IPs</span>
</span><span id="ContextInjector-312"><a href="#ContextInjector-312"><span class="linenos">312</span></a>        <span class="n">source_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ContextInjector-313"><a href="#ContextInjector-313"><span class="linenos">313</span></a>        <span class="n">destination_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ContextInjector-314"><a href="#ContextInjector-314"><span class="linenos">314</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-315"><a href="#ContextInjector-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">):</span>
</span><span id="ContextInjector-316"><a href="#ContextInjector-316"><span class="linenos">316</span></a>                <span class="n">source_ip</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;source_ip&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-317"><a href="#ContextInjector-317"><span class="linenos">317</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_ip</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ContextInjector-318"><a href="#ContextInjector-318"><span class="linenos">318</span></a>                    <span class="n">source_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_ip</span><span class="p">))</span>
</span><span id="ContextInjector-319"><a href="#ContextInjector-319"><span class="linenos">319</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-320"><a href="#ContextInjector-320"><span class="linenos">320</span></a>                    <span class="n">source_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_ip</span><span class="p">))</span>
</span><span id="ContextInjector-321"><a href="#ContextInjector-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">):</span>
</span><span id="ContextInjector-322"><a href="#ContextInjector-322"><span class="linenos">322</span></a>                <span class="n">destination_ip</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-323"><a href="#ContextInjector-323"><span class="linenos">323</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ContextInjector-324"><a href="#ContextInjector-324"><span class="linenos">324</span></a>                    <span class="n">destination_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">))</span>
</span><span id="ContextInjector-325"><a href="#ContextInjector-325"><span class="linenos">325</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-326"><a href="#ContextInjector-326"><span class="linenos">326</span></a>                    <span class="n">destination_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">))</span>
</span><span id="ContextInjector-327"><a href="#ContextInjector-327"><span class="linenos">327</span></a>
</span><span id="ContextInjector-328"><a href="#ContextInjector-328"><span class="linenos">328</span></a>        <span class="c1"># Get sample events (first 5)</span>
</span><span id="ContextInjector-329"><a href="#ContextInjector-329"><span class="linenos">329</span></a>        <span class="n">sample_events</span> <span class="o">=</span> <span class="n">events</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span><span id="ContextInjector-330"><a href="#ContextInjector-330"><span class="linenos">330</span></a>
</span><span id="ContextInjector-331"><a href="#ContextInjector-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="ContextInjector-332"><a href="#ContextInjector-332"><span class="linenos">332</span></a>            <span class="s2">&quot;total_events&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="ContextInjector-333"><a href="#ContextInjector-333"><span class="linenos">333</span></a>            <span class="s2">&quot;severity_distribution&quot;</span><span class="p">:</span> <span class="n">severity_counts</span><span class="p">,</span>
</span><span id="ContextInjector-334"><a href="#ContextInjector-334"><span class="linenos">334</span></a>            <span class="s2">&quot;category_distribution&quot;</span><span class="p">:</span> <span class="n">category_counts</span><span class="p">,</span>
</span><span id="ContextInjector-335"><a href="#ContextInjector-335"><span class="linenos">335</span></a>            <span class="s2">&quot;unique_source_ips&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_ips</span><span class="p">),</span>
</span><span id="ContextInjector-336"><a href="#ContextInjector-336"><span class="linenos">336</span></a>            <span class="s2">&quot;unique_destination_ips&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">destination_ips</span><span class="p">),</span>
</span><span id="ContextInjector-337"><a href="#ContextInjector-337"><span class="linenos">337</span></a>            <span class="s2">&quot;sample_events&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">sample_events</span><span class="p">),</span>
</span><span id="ContextInjector-338"><a href="#ContextInjector-338"><span class="linenos">338</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-339"><a href="#ContextInjector-339"><span class="linenos">339</span></a>
</span><span id="ContextInjector-340"><a href="#ContextInjector-340"><span class="linenos">340</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="ContextInjector-341"><a href="#ContextInjector-341"><span class="linenos">341</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean events by removing sensitive or unnecessary data.</span>
</span><span id="ContextInjector-342"><a href="#ContextInjector-342"><span class="linenos">342</span></a>
</span><span id="ContextInjector-343"><a href="#ContextInjector-343"><span class="linenos">343</span></a><span class="sd">        Removes sensitive fields and unnecessary metadata from events</span>
</span><span id="ContextInjector-344"><a href="#ContextInjector-344"><span class="linenos">344</span></a><span class="sd">        while preserving essential information for analysis.</span>
</span><span id="ContextInjector-345"><a href="#ContextInjector-345"><span class="linenos">345</span></a>
</span><span id="ContextInjector-346"><a href="#ContextInjector-346"><span class="linenos">346</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-347"><a href="#ContextInjector-347"><span class="linenos">347</span></a><span class="sd">            events: List of event dictionaries to clean</span>
</span><span id="ContextInjector-348"><a href="#ContextInjector-348"><span class="linenos">348</span></a>
</span><span id="ContextInjector-349"><a href="#ContextInjector-349"><span class="linenos">349</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-350"><a href="#ContextInjector-350"><span class="linenos">350</span></a><span class="sd">            List of cleaned event dictionaries</span>
</span><span id="ContextInjector-351"><a href="#ContextInjector-351"><span class="linenos">351</span></a>
</span><span id="ContextInjector-352"><a href="#ContextInjector-352"><span class="linenos">352</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-353"><a href="#ContextInjector-353"><span class="linenos">353</span></a>        <span class="n">cleaned_events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-354"><a href="#ContextInjector-354"><span class="linenos">354</span></a>
</span><span id="ContextInjector-355"><a href="#ContextInjector-355"><span class="linenos">355</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-356"><a href="#ContextInjector-356"><span class="linenos">356</span></a>            <span class="n">cleaned_event</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-357"><a href="#ContextInjector-357"><span class="linenos">357</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-358"><a href="#ContextInjector-358"><span class="linenos">358</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-359"><a href="#ContextInjector-359"><span class="linenos">359</span></a>                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-360"><a href="#ContextInjector-360"><span class="linenos">360</span></a>                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-361"><a href="#ContextInjector-361"><span class="linenos">361</span></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-362"><a href="#ContextInjector-362"><span class="linenos">362</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-363"><a href="#ContextInjector-363"><span class="linenos">363</span></a>                <span class="s2">&quot;source_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-364"><a href="#ContextInjector-364"><span class="linenos">364</span></a>                <span class="s2">&quot;destination_ip&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-365"><a href="#ContextInjector-365"><span class="linenos">365</span></a>                <span class="s2">&quot;source_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_port&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-366"><a href="#ContextInjector-366"><span class="linenos">366</span></a>                <span class="s2">&quot;destination_port&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_port&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-367"><a href="#ContextInjector-367"><span class="linenos">367</span></a>                <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-368"><a href="#ContextInjector-368"><span class="linenos">368</span></a>            <span class="p">}</span>
</span><span id="ContextInjector-369"><a href="#ContextInjector-369"><span class="linenos">369</span></a>
</span><span id="ContextInjector-370"><a href="#ContextInjector-370"><span class="linenos">370</span></a>            <span class="c1"># Remove None values</span>
</span><span id="ContextInjector-371"><a href="#ContextInjector-371"><span class="linenos">371</span></a>            <span class="n">cleaned_event</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cleaned_event</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
</span><span id="ContextInjector-372"><a href="#ContextInjector-372"><span class="linenos">372</span></a>            <span class="n">cleaned_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_event</span><span class="p">)</span>
</span><span id="ContextInjector-373"><a href="#ContextInjector-373"><span class="linenos">373</span></a>
</span><span id="ContextInjector-374"><a href="#ContextInjector-374"><span class="linenos">374</span></a>        <span class="k">return</span> <span class="n">cleaned_events</span>
</span><span id="ContextInjector-375"><a href="#ContextInjector-375"><span class="linenos">375</span></a>
</span><span id="ContextInjector-376"><a href="#ContextInjector-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_threat_intelligence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-377"><a href="#ContextInjector-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process threat intelligence data for context injection.</span>
</span><span id="ContextInjector-378"><a href="#ContextInjector-378"><span class="linenos">378</span></a>
</span><span id="ContextInjector-379"><a href="#ContextInjector-379"><span class="linenos">379</span></a><span class="sd">        Formats threat intelligence data for inclusion in context,</span>
</span><span id="ContextInjector-380"><a href="#ContextInjector-380"><span class="linenos">380</span></a><span class="sd">        organizing it by IP address and threat level.</span>
</span><span id="ContextInjector-381"><a href="#ContextInjector-381"><span class="linenos">381</span></a>
</span><span id="ContextInjector-382"><a href="#ContextInjector-382"><span class="linenos">382</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-383"><a href="#ContextInjector-383"><span class="linenos">383</span></a><span class="sd">            threat_intelligence: Raw threat intelligence data</span>
</span><span id="ContextInjector-384"><a href="#ContextInjector-384"><span class="linenos">384</span></a>
</span><span id="ContextInjector-385"><a href="#ContextInjector-385"><span class="linenos">385</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-386"><a href="#ContextInjector-386"><span class="linenos">386</span></a><span class="sd">            Processed threat intelligence dictionary</span>
</span><span id="ContextInjector-387"><a href="#ContextInjector-387"><span class="linenos">387</span></a>
</span><span id="ContextInjector-388"><a href="#ContextInjector-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-389"><a href="#ContextInjector-389"><span class="linenos">389</span></a>        <span class="n">processed_ti</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-390"><a href="#ContextInjector-390"><span class="linenos">390</span></a>            <span class="s2">&quot;total_ips&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_intelligence</span><span class="p">),</span>
</span><span id="ContextInjector-391"><a href="#ContextInjector-391"><span class="linenos">391</span></a>            <span class="s2">&quot;high_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="ContextInjector-392"><a href="#ContextInjector-392"><span class="linenos">392</span></a>            <span class="s2">&quot;medium_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="ContextInjector-393"><a href="#ContextInjector-393"><span class="linenos">393</span></a>            <span class="s2">&quot;low_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="ContextInjector-394"><a href="#ContextInjector-394"><span class="linenos">394</span></a>            <span class="s2">&quot;unknown_risk_ips&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="ContextInjector-395"><a href="#ContextInjector-395"><span class="linenos">395</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-396"><a href="#ContextInjector-396"><span class="linenos">396</span></a>
</span><span id="ContextInjector-397"><a href="#ContextInjector-397"><span class="linenos">397</span></a>        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ti_data</span> <span class="ow">in</span> <span class="n">threat_intelligence</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ContextInjector-398"><a href="#ContextInjector-398"><span class="linenos">398</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ti_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ContextInjector-399"><a href="#ContextInjector-399"><span class="linenos">399</span></a>                <span class="n">threat_level</span> <span class="o">=</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threat_level&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-400"><a href="#ContextInjector-400"><span class="linenos">400</span></a>                <span class="n">ip_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-401"><a href="#ContextInjector-401"><span class="linenos">401</span></a>                    <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
</span><span id="ContextInjector-402"><a href="#ContextInjector-402"><span class="linenos">402</span></a>                    <span class="s2">&quot;reputation_score&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-403"><a href="#ContextInjector-403"><span class="linenos">403</span></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;country&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-404"><a href="#ContextInjector-404"><span class="linenos">404</span></a>                    <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;asn&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-405"><a href="#ContextInjector-405"><span class="linenos">405</span></a>                    <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;organization&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-406"><a href="#ContextInjector-406"><span class="linenos">406</span></a>                    <span class="s2">&quot;attack_types&quot;</span><span class="p">:</span> <span class="n">ti_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attack_types&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector-407"><a href="#ContextInjector-407"><span class="linenos">407</span></a>                <span class="p">}</span>
</span><span id="ContextInjector-408"><a href="#ContextInjector-408"><span class="linenos">408</span></a>
</span><span id="ContextInjector-409"><a href="#ContextInjector-409"><span class="linenos">409</span></a>                <span class="k">if</span> <span class="n">threat_level</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-410"><a href="#ContextInjector-410"><span class="linenos">410</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="ContextInjector-411"><a href="#ContextInjector-411"><span class="linenos">411</span></a>                <span class="k">elif</span> <span class="n">threat_level</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-412"><a href="#ContextInjector-412"><span class="linenos">412</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;medium_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="ContextInjector-413"><a href="#ContextInjector-413"><span class="linenos">413</span></a>                <span class="k">elif</span> <span class="n">threat_level</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-414"><a href="#ContextInjector-414"><span class="linenos">414</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;low_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="ContextInjector-415"><a href="#ContextInjector-415"><span class="linenos">415</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-416"><a href="#ContextInjector-416"><span class="linenos">416</span></a>                    <span class="n">processed_ti</span><span class="p">[</span><span class="s2">&quot;unknown_risk_ips&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_info</span><span class="p">)</span>
</span><span id="ContextInjector-417"><a href="#ContextInjector-417"><span class="linenos">417</span></a>
</span><span id="ContextInjector-418"><a href="#ContextInjector-418"><span class="linenos">418</span></a>        <span class="k">return</span> <span class="n">processed_ti</span>
</span><span id="ContextInjector-419"><a href="#ContextInjector-419"><span class="linenos">419</span></a>
</span><span id="ContextInjector-420"><a href="#ContextInjector-420"><span class="linenos">420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_metadata</span><span class="p">(</span>
</span><span id="ContextInjector-421"><a href="#ContextInjector-421"><span class="linenos">421</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</span><span id="ContextInjector-422"><a href="#ContextInjector-422"><span class="linenos">422</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-423"><a href="#ContextInjector-423"><span class="linenos">423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate metadata for the context.</span>
</span><span id="ContextInjector-424"><a href="#ContextInjector-424"><span class="linenos">424</span></a>
</span><span id="ContextInjector-425"><a href="#ContextInjector-425"><span class="linenos">425</span></a><span class="sd">        Creates metadata including time ranges, data sources, and</span>
</span><span id="ContextInjector-426"><a href="#ContextInjector-426"><span class="linenos">426</span></a><span class="sd">        processing information for the context.</span>
</span><span id="ContextInjector-427"><a href="#ContextInjector-427"><span class="linenos">427</span></a>
</span><span id="ContextInjector-428"><a href="#ContextInjector-428"><span class="linenos">428</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-429"><a href="#ContextInjector-429"><span class="linenos">429</span></a><span class="sd">            events: List of events to analyze</span>
</span><span id="ContextInjector-430"><a href="#ContextInjector-430"><span class="linenos">430</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="ContextInjector-431"><a href="#ContextInjector-431"><span class="linenos">431</span></a>
</span><span id="ContextInjector-432"><a href="#ContextInjector-432"><span class="linenos">432</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-433"><a href="#ContextInjector-433"><span class="linenos">433</span></a><span class="sd">            Dictionary containing context metadata</span>
</span><span id="ContextInjector-434"><a href="#ContextInjector-434"><span class="linenos">434</span></a>
</span><span id="ContextInjector-435"><a href="#ContextInjector-435"><span class="linenos">435</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-436"><a href="#ContextInjector-436"><span class="linenos">436</span></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-437"><a href="#ContextInjector-437"><span class="linenos">437</span></a>            <span class="s2">&quot;event_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="ContextInjector-438"><a href="#ContextInjector-438"><span class="linenos">438</span></a>            <span class="s2">&quot;time_range&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_time_range</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="ContextInjector-439"><a href="#ContextInjector-439"><span class="linenos">439</span></a>            <span class="s2">&quot;data_sources&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_data_sources</span><span class="p">(</span><span class="n">events</span><span class="p">),</span>
</span><span id="ContextInjector-440"><a href="#ContextInjector-440"><span class="linenos">440</span></a>            <span class="s2">&quot;threat_intelligence_available&quot;</span><span class="p">:</span> <span class="n">threat_intelligence</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="ContextInjector-441"><a href="#ContextInjector-441"><span class="linenos">441</span></a>            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_intelligence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-442"><a href="#ContextInjector-442"><span class="linenos">442</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-443"><a href="#ContextInjector-443"><span class="linenos">443</span></a>
</span><span id="ContextInjector-444"><a href="#ContextInjector-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="ContextInjector-445"><a href="#ContextInjector-445"><span class="linenos">445</span></a>            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;threat_intelligence_ips&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threat_intelligence</span><span class="p">)</span>
</span><span id="ContextInjector-446"><a href="#ContextInjector-446"><span class="linenos">446</span></a>
</span><span id="ContextInjector-447"><a href="#ContextInjector-447"><span class="linenos">447</span></a>        <span class="k">return</span> <span class="n">metadata</span>
</span><span id="ContextInjector-448"><a href="#ContextInjector-448"><span class="linenos">448</span></a>
</span><span id="ContextInjector-449"><a href="#ContextInjector-449"><span class="linenos">449</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_analysis_hints</span><span class="p">(</span>
</span><span id="ContextInjector-450"><a href="#ContextInjector-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
</span><span id="ContextInjector-451"><a href="#ContextInjector-451"><span class="linenos">451</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="ContextInjector-452"><a href="#ContextInjector-452"><span class="linenos">452</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate analysis hints for ChatGPT.</span>
</span><span id="ContextInjector-453"><a href="#ContextInjector-453"><span class="linenos">453</span></a>
</span><span id="ContextInjector-454"><a href="#ContextInjector-454"><span class="linenos">454</span></a><span class="sd">        Creates a list of analysis hints and suggestions based on</span>
</span><span id="ContextInjector-455"><a href="#ContextInjector-455"><span class="linenos">455</span></a><span class="sd">        the events and threat intelligence data.</span>
</span><span id="ContextInjector-456"><a href="#ContextInjector-456"><span class="linenos">456</span></a>
</span><span id="ContextInjector-457"><a href="#ContextInjector-457"><span class="linenos">457</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-458"><a href="#ContextInjector-458"><span class="linenos">458</span></a><span class="sd">            events: List of events to analyze</span>
</span><span id="ContextInjector-459"><a href="#ContextInjector-459"><span class="linenos">459</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="ContextInjector-460"><a href="#ContextInjector-460"><span class="linenos">460</span></a>
</span><span id="ContextInjector-461"><a href="#ContextInjector-461"><span class="linenos">461</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-462"><a href="#ContextInjector-462"><span class="linenos">462</span></a><span class="sd">            List of analysis hints and suggestions</span>
</span><span id="ContextInjector-463"><a href="#ContextInjector-463"><span class="linenos">463</span></a>
</span><span id="ContextInjector-464"><a href="#ContextInjector-464"><span class="linenos">464</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-465"><a href="#ContextInjector-465"><span class="linenos">465</span></a>        <span class="n">hints</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-466"><a href="#ContextInjector-466"><span class="linenos">466</span></a>
</span><span id="ContextInjector-467"><a href="#ContextInjector-467"><span class="linenos">467</span></a>        <span class="c1"># Analyze event patterns</span>
</span><span id="ContextInjector-468"><a href="#ContextInjector-468"><span class="linenos">468</span></a>        <span class="n">high_severity_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="ContextInjector-469"><a href="#ContextInjector-469"><span class="linenos">469</span></a>            <span class="mi">1</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-470"><a href="#ContextInjector-470"><span class="linenos">470</span></a>        <span class="p">)</span>
</span><span id="ContextInjector-471"><a href="#ContextInjector-471"><span class="linenos">471</span></a>        <span class="k">if</span> <span class="n">high_severity_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ContextInjector-472"><a href="#ContextInjector-472"><span class="linenos">472</span></a>            <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-473"><a href="#ContextInjector-473"><span class="linenos">473</span></a>                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">high_severity_count</span><span class="si">}</span><span class="s2"> high/critical severity events requiring immediate attention&quot;</span>
</span><span id="ContextInjector-474"><a href="#ContextInjector-474"><span class="linenos">474</span></a>            <span class="p">)</span>
</span><span id="ContextInjector-475"><a href="#ContextInjector-475"><span class="linenos">475</span></a>
</span><span id="ContextInjector-476"><a href="#ContextInjector-476"><span class="linenos">476</span></a>        <span class="c1"># Check for threat intelligence hits</span>
</span><span id="ContextInjector-477"><a href="#ContextInjector-477"><span class="linenos">477</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="ContextInjector-478"><a href="#ContextInjector-478"><span class="linenos">478</span></a>            <span class="n">high_risk_ti</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="ContextInjector-479"><a href="#ContextInjector-479"><span class="linenos">479</span></a>                <span class="mi">1</span>
</span><span id="ContextInjector-480"><a href="#ContextInjector-480"><span class="linenos">480</span></a>                <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">threat_intelligence</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="ContextInjector-481"><a href="#ContextInjector-481"><span class="linenos">481</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;threat_level&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span>
</span><span id="ContextInjector-482"><a href="#ContextInjector-482"><span class="linenos">482</span></a>            <span class="p">)</span>
</span><span id="ContextInjector-483"><a href="#ContextInjector-483"><span class="linenos">483</span></a>            <span class="k">if</span> <span class="n">high_risk_ti</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ContextInjector-484"><a href="#ContextInjector-484"><span class="linenos">484</span></a>                <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-485"><a href="#ContextInjector-485"><span class="linenos">485</span></a>                    <span class="sa">f</span><span class="s2">&quot;Identified </span><span class="si">{</span><span class="n">high_risk_ti</span><span class="si">}</span><span class="s2"> IP addresses with high threat intelligence scores&quot;</span>
</span><span id="ContextInjector-486"><a href="#ContextInjector-486"><span class="linenos">486</span></a>                <span class="p">)</span>
</span><span id="ContextInjector-487"><a href="#ContextInjector-487"><span class="linenos">487</span></a>
</span><span id="ContextInjector-488"><a href="#ContextInjector-488"><span class="linenos">488</span></a>        <span class="c1"># Check for attack patterns</span>
</span><span id="ContextInjector-489"><a href="#ContextInjector-489"><span class="linenos">489</span></a>        <span class="n">attack_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_attack_patterns</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector-490"><a href="#ContextInjector-490"><span class="linenos">490</span></a>        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">attack_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ContextInjector-491"><a href="#ContextInjector-491"><span class="linenos">491</span></a>            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ContextInjector-492"><a href="#ContextInjector-492"><span class="linenos">492</span></a>                <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> events matching </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2"> pattern&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-493"><a href="#ContextInjector-493"><span class="linenos">493</span></a>
</span><span id="ContextInjector-494"><a href="#ContextInjector-494"><span class="linenos">494</span></a>        <span class="c1"># Add general analysis guidance</span>
</span><span id="ContextInjector-495"><a href="#ContextInjector-495"><span class="linenos">495</span></a>        <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-496"><a href="#ContextInjector-496"><span class="linenos">496</span></a>            <span class="s2">&quot;Consider correlating events with threat intelligence for comprehensive analysis&quot;</span>
</span><span id="ContextInjector-497"><a href="#ContextInjector-497"><span class="linenos">497</span></a>        <span class="p">)</span>
</span><span id="ContextInjector-498"><a href="#ContextInjector-498"><span class="linenos">498</span></a>        <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Look for patterns in source IPs, ports, and protocols&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-499"><a href="#ContextInjector-499"><span class="linenos">499</span></a>        <span class="n">hints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Assess the potential impact and recommend mitigation strategies&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-500"><a href="#ContextInjector-500"><span class="linenos">500</span></a>
</span><span id="ContextInjector-501"><a href="#ContextInjector-501"><span class="linenos">501</span></a>        <span class="k">return</span> <span class="n">hints</span>
</span><span id="ContextInjector-502"><a href="#ContextInjector-502"><span class="linenos">502</span></a>
</span><span id="ContextInjector-503"><a href="#ContextInjector-503"><span class="linenos">503</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_attack_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector-504"><a href="#ContextInjector-504"><span class="linenos">504</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format attack report for context injection.</span>
</span><span id="ContextInjector-505"><a href="#ContextInjector-505"><span class="linenos">505</span></a>
</span><span id="ContextInjector-506"><a href="#ContextInjector-506"><span class="linenos">506</span></a><span class="sd">        Formats an attack report for inclusion in context, organizing</span>
</span><span id="ContextInjector-507"><a href="#ContextInjector-507"><span class="linenos">507</span></a><span class="sd">        it into sections for executive summary, details, and recommendations.</span>
</span><span id="ContextInjector-508"><a href="#ContextInjector-508"><span class="linenos">508</span></a>
</span><span id="ContextInjector-509"><a href="#ContextInjector-509"><span class="linenos">509</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-510"><a href="#ContextInjector-510"><span class="linenos">510</span></a><span class="sd">            report: Raw attack report dictionary</span>
</span><span id="ContextInjector-511"><a href="#ContextInjector-511"><span class="linenos">511</span></a>
</span><span id="ContextInjector-512"><a href="#ContextInjector-512"><span class="linenos">512</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-513"><a href="#ContextInjector-513"><span class="linenos">513</span></a><span class="sd">            Formatted attack report dictionary</span>
</span><span id="ContextInjector-514"><a href="#ContextInjector-514"><span class="linenos">514</span></a>
</span><span id="ContextInjector-515"><a href="#ContextInjector-515"><span class="linenos">515</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-516"><a href="#ContextInjector-516"><span class="linenos">516</span></a>        <span class="n">formatted_report</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-517"><a href="#ContextInjector-517"><span class="linenos">517</span></a>            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-518"><a href="#ContextInjector-518"><span class="linenos">518</span></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-519"><a href="#ContextInjector-519"><span class="linenos">519</span></a>            <span class="s2">&quot;key_findings&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector-520"><a href="#ContextInjector-520"><span class="linenos">520</span></a>                <span class="s2">&quot;total_events&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_events&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-521"><a href="#ContextInjector-521"><span class="linenos">521</span></a>                <span class="s2">&quot;unique_ips&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unique_ips&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-522"><a href="#ContextInjector-522"><span class="linenos">522</span></a>                <span class="s2">&quot;high_risk_ips&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector-523"><a href="#ContextInjector-523"><span class="linenos">523</span></a>                <span class="s2">&quot;attack_vectors&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attack_vectors&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector-524"><a href="#ContextInjector-524"><span class="linenos">524</span></a>                <span class="s2">&quot;impact_assessment&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impact_assessment&quot;</span><span class="p">),</span>
</span><span id="ContextInjector-525"><a href="#ContextInjector-525"><span class="linenos">525</span></a>            <span class="p">},</span>
</span><span id="ContextInjector-526"><a href="#ContextInjector-526"><span class="linenos">526</span></a>            <span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recommendations&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector-527"><a href="#ContextInjector-527"><span class="linenos">527</span></a>            <span class="s2">&quot;mitigation_actions&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mitigation_actions&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector-528"><a href="#ContextInjector-528"><span class="linenos">528</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-529"><a href="#ContextInjector-529"><span class="linenos">529</span></a>
</span><span id="ContextInjector-530"><a href="#ContextInjector-530"><span class="linenos">530</span></a>        <span class="k">return</span> <span class="n">formatted_report</span>
</span><span id="ContextInjector-531"><a href="#ContextInjector-531"><span class="linenos">531</span></a>
</span><span id="ContextInjector-532"><a href="#ContextInjector-532"><span class="linenos">532</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="ContextInjector-533"><a href="#ContextInjector-533"><span class="linenos">533</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format query results for context injection.</span>
</span><span id="ContextInjector-534"><a href="#ContextInjector-534"><span class="linenos">534</span></a>
</span><span id="ContextInjector-535"><a href="#ContextInjector-535"><span class="linenos">535</span></a><span class="sd">        Formats query results for inclusion in context, ensuring</span>
</span><span id="ContextInjector-536"><a href="#ContextInjector-536"><span class="linenos">536</span></a><span class="sd">        they are properly structured and readable.</span>
</span><span id="ContextInjector-537"><a href="#ContextInjector-537"><span class="linenos">537</span></a>
</span><span id="ContextInjector-538"><a href="#ContextInjector-538"><span class="linenos">538</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-539"><a href="#ContextInjector-539"><span class="linenos">539</span></a><span class="sd">            results: Raw query results list</span>
</span><span id="ContextInjector-540"><a href="#ContextInjector-540"><span class="linenos">540</span></a>
</span><span id="ContextInjector-541"><a href="#ContextInjector-541"><span class="linenos">541</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-542"><a href="#ContextInjector-542"><span class="linenos">542</span></a><span class="sd">            Formatted query results list</span>
</span><span id="ContextInjector-543"><a href="#ContextInjector-543"><span class="linenos">543</span></a>
</span><span id="ContextInjector-544"><a href="#ContextInjector-544"><span class="linenos">544</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-545"><a href="#ContextInjector-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-546"><a href="#ContextInjector-546"><span class="linenos">546</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="ContextInjector-547"><a href="#ContextInjector-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span>
</span><span id="ContextInjector-548"><a href="#ContextInjector-548"><span class="linenos">548</span></a>            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_summarize_events</span><span class="p">(</span><span class="n">results</span><span class="p">)]</span>
</span><span id="ContextInjector-549"><a href="#ContextInjector-549"><span class="linenos">549</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_events</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="ContextInjector-550"><a href="#ContextInjector-550"><span class="linenos">550</span></a>
</span><span id="ContextInjector-551"><a href="#ContextInjector-551"><span class="linenos">551</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_security_context_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ContextInjector-552"><a href="#ContextInjector-552"><span class="linenos">552</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format security context specifically for ChatGPT.</span>
</span><span id="ContextInjector-553"><a href="#ContextInjector-553"><span class="linenos">553</span></a>
</span><span id="ContextInjector-554"><a href="#ContextInjector-554"><span class="linenos">554</span></a><span class="sd">        Converts security context data into a text format optimized</span>
</span><span id="ContextInjector-555"><a href="#ContextInjector-555"><span class="linenos">555</span></a><span class="sd">        for ChatGPT consumption, including structured sections and</span>
</span><span id="ContextInjector-556"><a href="#ContextInjector-556"><span class="linenos">556</span></a><span class="sd">        analysis guidance.</span>
</span><span id="ContextInjector-557"><a href="#ContextInjector-557"><span class="linenos">557</span></a>
</span><span id="ContextInjector-558"><a href="#ContextInjector-558"><span class="linenos">558</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-559"><a href="#ContextInjector-559"><span class="linenos">559</span></a><span class="sd">            data: Security context data dictionary</span>
</span><span id="ContextInjector-560"><a href="#ContextInjector-560"><span class="linenos">560</span></a>
</span><span id="ContextInjector-561"><a href="#ContextInjector-561"><span class="linenos">561</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-562"><a href="#ContextInjector-562"><span class="linenos">562</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="ContextInjector-563"><a href="#ContextInjector-563"><span class="linenos">563</span></a>
</span><span id="ContextInjector-564"><a href="#ContextInjector-564"><span class="linenos">564</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-565"><a href="#ContextInjector-565"><span class="linenos">565</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-566"><a href="#ContextInjector-566"><span class="linenos">566</span></a>
</span><span id="ContextInjector-567"><a href="#ContextInjector-567"><span class="linenos">567</span></a>        <span class="c1"># Add summary if available</span>
</span><span id="ContextInjector-568"><a href="#ContextInjector-568"><span class="linenos">568</span></a>        <span class="k">if</span> <span class="s2">&quot;summary&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="ContextInjector-569"><a href="#ContextInjector-569"><span class="linenos">569</span></a>            <span class="n">summary</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-570"><a href="#ContextInjector-570"><span class="linenos">570</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== SECURITY SUMMARY ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-571"><a href="#ContextInjector-571"><span class="linenos">571</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Events: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-572"><a href="#ContextInjector-572"><span class="linenos">572</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time Range: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_range_hours&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="si">}</span><span class="s2"> hours&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-573"><a href="#ContextInjector-573"><span class="linenos">573</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High Risk Events: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_risk_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-574"><a href="#ContextInjector-574"><span class="linenos">574</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-575"><a href="#ContextInjector-575"><span class="linenos">575</span></a>
</span><span id="ContextInjector-576"><a href="#ContextInjector-576"><span class="linenos">576</span></a>        <span class="c1"># Add events</span>
</span><span id="ContextInjector-577"><a href="#ContextInjector-577"><span class="linenos">577</span></a>        <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="ContextInjector-578"><a href="#ContextInjector-578"><span class="linenos">578</span></a>            <span class="n">events</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-579"><a href="#ContextInjector-579"><span class="linenos">579</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;total_events&quot;</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-580"><a href="#ContextInjector-580"><span class="linenos">580</span></a>                <span class="c1"># Summary format</span>
</span><span id="ContextInjector-581"><a href="#ContextInjector-581"><span class="linenos">581</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== EVENT SUMMARY ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-582"><a href="#ContextInjector-582"><span class="linenos">582</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Events: </span><span class="si">{</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;total_events&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-583"><a href="#ContextInjector-583"><span class="linenos">583</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-584"><a href="#ContextInjector-584"><span class="linenos">584</span></a>                    <span class="sa">f</span><span class="s2">&quot;Severity Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ContextInjector-585"><a href="#ContextInjector-585"><span class="linenos">585</span></a>                <span class="p">)</span>
</span><span id="ContextInjector-586"><a href="#ContextInjector-586"><span class="linenos">586</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-587"><a href="#ContextInjector-587"><span class="linenos">587</span></a>                    <span class="sa">f</span><span class="s2">&quot;Category Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ContextInjector-588"><a href="#ContextInjector-588"><span class="linenos">588</span></a>                <span class="p">)</span>
</span><span id="ContextInjector-589"><a href="#ContextInjector-589"><span class="linenos">589</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-590"><a href="#ContextInjector-590"><span class="linenos">590</span></a>
</span><span id="ContextInjector-591"><a href="#ContextInjector-591"><span class="linenos">591</span></a>                <span class="k">if</span> <span class="s2">&quot;sample_events&quot;</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-592"><a href="#ContextInjector-592"><span class="linenos">592</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== SAMPLE EVENTS ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-593"><a href="#ContextInjector-593"><span class="linenos">593</span></a>                    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">[</span><span class="s2">&quot;sample_events&quot;</span><span class="p">]:</span>
</span><span id="ContextInjector-594"><a href="#ContextInjector-594"><span class="linenos">594</span></a>                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-595"><a href="#ContextInjector-595"><span class="linenos">595</span></a>                            <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No description&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ContextInjector-596"><a href="#ContextInjector-596"><span class="linenos">596</span></a>                        <span class="p">)</span>
</span><span id="ContextInjector-597"><a href="#ContextInjector-597"><span class="linenos">597</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-598"><a href="#ContextInjector-598"><span class="linenos">598</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-599"><a href="#ContextInjector-599"><span class="linenos">599</span></a>                <span class="c1"># Full events format</span>
</span><span id="ContextInjector-600"><a href="#ContextInjector-600"><span class="linenos">600</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== SECURITY EVENTS ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-601"><a href="#ContextInjector-601"><span class="linenos">601</span></a>                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-602"><a href="#ContextInjector-602"><span class="linenos">602</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Event: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-603"><a href="#ContextInjector-603"><span class="linenos">603</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Severity: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-604"><a href="#ContextInjector-604"><span class="linenos">604</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Description: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No description&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-605"><a href="#ContextInjector-605"><span class="linenos">605</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_ip&quot;</span><span class="p">):</span>
</span><span id="ContextInjector-606"><a href="#ContextInjector-606"><span class="linenos">606</span></a>                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Source IP: </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;source_ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-607"><a href="#ContextInjector-607"><span class="linenos">607</span></a>                    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination_ip&quot;</span><span class="p">):</span>
</span><span id="ContextInjector-608"><a href="#ContextInjector-608"><span class="linenos">608</span></a>                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Destination IP: </span><span class="si">{</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;destination_ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-609"><a href="#ContextInjector-609"><span class="linenos">609</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-610"><a href="#ContextInjector-610"><span class="linenos">610</span></a>
</span><span id="ContextInjector-611"><a href="#ContextInjector-611"><span class="linenos">611</span></a>        <span class="c1"># Add threat intelligence</span>
</span><span id="ContextInjector-612"><a href="#ContextInjector-612"><span class="linenos">612</span></a>        <span class="k">if</span> <span class="s2">&quot;threat_intelligence&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="ContextInjector-613"><a href="#ContextInjector-613"><span class="linenos">613</span></a>            <span class="n">ti</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;threat_intelligence&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-614"><a href="#ContextInjector-614"><span class="linenos">614</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== THREAT INTELLIGENCE ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-615"><a href="#ContextInjector-615"><span class="linenos">615</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total IPs: </span><span class="si">{</span><span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-616"><a href="#ContextInjector-616"><span class="linenos">616</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High Risk IPs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_risk_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-617"><a href="#ContextInjector-617"><span class="linenos">617</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Medium Risk IPs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;medium_risk_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-618"><a href="#ContextInjector-618"><span class="linenos">618</span></a>
</span><span id="ContextInjector-619"><a href="#ContextInjector-619"><span class="linenos">619</span></a>            <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">):</span>
</span><span id="ContextInjector-620"><a href="#ContextInjector-620"><span class="linenos">620</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;High Risk IPs:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-621"><a href="#ContextInjector-621"><span class="linenos">621</span></a>                <span class="k">for</span> <span class="n">ip_info</span> <span class="ow">in</span> <span class="n">ti</span><span class="p">[</span><span class="s2">&quot;high_risk_ips&quot;</span><span class="p">]:</span>
</span><span id="ContextInjector-622"><a href="#ContextInjector-622"><span class="linenos">622</span></a>                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-623"><a href="#ContextInjector-623"><span class="linenos">623</span></a>                        <span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">ip_info</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Score: </span><span class="si">{</span><span class="n">ip_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reputation_score&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="ContextInjector-624"><a href="#ContextInjector-624"><span class="linenos">624</span></a>                    <span class="p">)</span>
</span><span id="ContextInjector-625"><a href="#ContextInjector-625"><span class="linenos">625</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-626"><a href="#ContextInjector-626"><span class="linenos">626</span></a>
</span><span id="ContextInjector-627"><a href="#ContextInjector-627"><span class="linenos">627</span></a>        <span class="c1"># Add analysis hints</span>
</span><span id="ContextInjector-628"><a href="#ContextInjector-628"><span class="linenos">628</span></a>        <span class="k">if</span> <span class="s2">&quot;analysis_hints&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="ContextInjector-629"><a href="#ContextInjector-629"><span class="linenos">629</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== ANALYSIS HINTS ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-630"><a href="#ContextInjector-630"><span class="linenos">630</span></a>            <span class="k">for</span> <span class="n">hint</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;analysis_hints&quot;</span><span class="p">]:</span>
</span><span id="ContextInjector-631"><a href="#ContextInjector-631"><span class="linenos">631</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">hint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-632"><a href="#ContextInjector-632"><span class="linenos">632</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-633"><a href="#ContextInjector-633"><span class="linenos">633</span></a>
</span><span id="ContextInjector-634"><a href="#ContextInjector-634"><span class="linenos">634</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span id="ContextInjector-635"><a href="#ContextInjector-635"><span class="linenos">635</span></a>
</span><span id="ContextInjector-636"><a href="#ContextInjector-636"><span class="linenos">636</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_attack_report_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ContextInjector-637"><a href="#ContextInjector-637"><span class="linenos">637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format attack report specifically for ChatGPT.</span>
</span><span id="ContextInjector-638"><a href="#ContextInjector-638"><span class="linenos">638</span></a>
</span><span id="ContextInjector-639"><a href="#ContextInjector-639"><span class="linenos">639</span></a><span class="sd">        Converts attack report data into a text format optimized</span>
</span><span id="ContextInjector-640"><a href="#ContextInjector-640"><span class="linenos">640</span></a><span class="sd">        for ChatGPT consumption, including executive summary and</span>
</span><span id="ContextInjector-641"><a href="#ContextInjector-641"><span class="linenos">641</span></a><span class="sd">        detailed analysis sections.</span>
</span><span id="ContextInjector-642"><a href="#ContextInjector-642"><span class="linenos">642</span></a>
</span><span id="ContextInjector-643"><a href="#ContextInjector-643"><span class="linenos">643</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-644"><a href="#ContextInjector-644"><span class="linenos">644</span></a><span class="sd">            data: Attack report data dictionary</span>
</span><span id="ContextInjector-645"><a href="#ContextInjector-645"><span class="linenos">645</span></a>
</span><span id="ContextInjector-646"><a href="#ContextInjector-646"><span class="linenos">646</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-647"><a href="#ContextInjector-647"><span class="linenos">647</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="ContextInjector-648"><a href="#ContextInjector-648"><span class="linenos">648</span></a>
</span><span id="ContextInjector-649"><a href="#ContextInjector-649"><span class="linenos">649</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-650"><a href="#ContextInjector-650"><span class="linenos">650</span></a>        <span class="n">report</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-651"><a href="#ContextInjector-651"><span class="linenos">651</span></a>
</span><span id="ContextInjector-652"><a href="#ContextInjector-652"><span class="linenos">652</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-653"><a href="#ContextInjector-653"><span class="linenos">653</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=== ATTACK REPORT ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-654"><a href="#ContextInjector-654"><span class="linenos">654</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-655"><a href="#ContextInjector-655"><span class="linenos">655</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-656"><a href="#ContextInjector-656"><span class="linenos">656</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Executive Summary:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-657"><a href="#ContextInjector-657"><span class="linenos">657</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;No summary available&quot;</span><span class="p">))</span>
</span><span id="ContextInjector-658"><a href="#ContextInjector-658"><span class="linenos">658</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-659"><a href="#ContextInjector-659"><span class="linenos">659</span></a>
</span><span id="ContextInjector-660"><a href="#ContextInjector-660"><span class="linenos">660</span></a>        <span class="c1"># Key findings</span>
</span><span id="ContextInjector-661"><a href="#ContextInjector-661"><span class="linenos">661</span></a>        <span class="n">findings</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_findings&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="ContextInjector-662"><a href="#ContextInjector-662"><span class="linenos">662</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Key Findings:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-663"><a href="#ContextInjector-663"><span class="linenos">663</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total Events: </span><span class="si">{</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_events&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-664"><a href="#ContextInjector-664"><span class="linenos">664</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Unique IPs: </span><span class="si">{</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unique_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-665"><a href="#ContextInjector-665"><span class="linenos">665</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- High Risk IPs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;high_risk_ips&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-666"><a href="#ContextInjector-666"><span class="linenos">666</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Attack Vectors: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attack_vectors&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-667"><a href="#ContextInjector-667"><span class="linenos">667</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Impact: </span><span class="si">{</span><span class="n">findings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;impact_assessment&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-668"><a href="#ContextInjector-668"><span class="linenos">668</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-669"><a href="#ContextInjector-669"><span class="linenos">669</span></a>
</span><span id="ContextInjector-670"><a href="#ContextInjector-670"><span class="linenos">670</span></a>        <span class="c1"># Recommendations</span>
</span><span id="ContextInjector-671"><a href="#ContextInjector-671"><span class="linenos">671</span></a>        <span class="n">recommendations</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recommendations&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="ContextInjector-672"><a href="#ContextInjector-672"><span class="linenos">672</span></a>        <span class="k">if</span> <span class="n">recommendations</span><span class="p">:</span>
</span><span id="ContextInjector-673"><a href="#ContextInjector-673"><span class="linenos">673</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Recommendations:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-674"><a href="#ContextInjector-674"><span class="linenos">674</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="ContextInjector-675"><a href="#ContextInjector-675"><span class="linenos">675</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-676"><a href="#ContextInjector-676"><span class="linenos">676</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-677"><a href="#ContextInjector-677"><span class="linenos">677</span></a>
</span><span id="ContextInjector-678"><a href="#ContextInjector-678"><span class="linenos">678</span></a>        <span class="c1"># Mitigation actions</span>
</span><span id="ContextInjector-679"><a href="#ContextInjector-679"><span class="linenos">679</span></a>        <span class="n">actions</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mitigation_actions&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="ContextInjector-680"><a href="#ContextInjector-680"><span class="linenos">680</span></a>        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
</span><span id="ContextInjector-681"><a href="#ContextInjector-681"><span class="linenos">681</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Immediate Actions:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-682"><a href="#ContextInjector-682"><span class="linenos">682</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="ContextInjector-683"><a href="#ContextInjector-683"><span class="linenos">683</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-684"><a href="#ContextInjector-684"><span class="linenos">684</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-685"><a href="#ContextInjector-685"><span class="linenos">685</span></a>
</span><span id="ContextInjector-686"><a href="#ContextInjector-686"><span class="linenos">686</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span id="ContextInjector-687"><a href="#ContextInjector-687"><span class="linenos">687</span></a>
</span><span id="ContextInjector-688"><a href="#ContextInjector-688"><span class="linenos">688</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_query_results_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ContextInjector-689"><a href="#ContextInjector-689"><span class="linenos">689</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format query results specifically for ChatGPT.</span>
</span><span id="ContextInjector-690"><a href="#ContextInjector-690"><span class="linenos">690</span></a>
</span><span id="ContextInjector-691"><a href="#ContextInjector-691"><span class="linenos">691</span></a><span class="sd">        Converts query results data into a text format optimized</span>
</span><span id="ContextInjector-692"><a href="#ContextInjector-692"><span class="linenos">692</span></a><span class="sd">        for ChatGPT consumption, including query parameters and</span>
</span><span id="ContextInjector-693"><a href="#ContextInjector-693"><span class="linenos">693</span></a><span class="sd">        result summaries.</span>
</span><span id="ContextInjector-694"><a href="#ContextInjector-694"><span class="linenos">694</span></a>
</span><span id="ContextInjector-695"><a href="#ContextInjector-695"><span class="linenos">695</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-696"><a href="#ContextInjector-696"><span class="linenos">696</span></a><span class="sd">            data: Query results data dictionary</span>
</span><span id="ContextInjector-697"><a href="#ContextInjector-697"><span class="linenos">697</span></a>
</span><span id="ContextInjector-698"><a href="#ContextInjector-698"><span class="linenos">698</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-699"><a href="#ContextInjector-699"><span class="linenos">699</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="ContextInjector-700"><a href="#ContextInjector-700"><span class="linenos">700</span></a>
</span><span id="ContextInjector-701"><a href="#ContextInjector-701"><span class="linenos">701</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-702"><a href="#ContextInjector-702"><span class="linenos">702</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-703"><a href="#ContextInjector-703"><span class="linenos">703</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== QUERY RESULTS (</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) ===&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-704"><a href="#ContextInjector-704"><span class="linenos">704</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result Count: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-705"><a href="#ContextInjector-705"><span class="linenos">705</span></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-706"><a href="#ContextInjector-706"><span class="linenos">706</span></a>
</span><span id="ContextInjector-707"><a href="#ContextInjector-707"><span class="linenos">707</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="ContextInjector-708"><a href="#ContextInjector-708"><span class="linenos">708</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;total_events&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="ContextInjector-709"><a href="#ContextInjector-709"><span class="linenos">709</span></a>            <span class="c1"># Summary format</span>
</span><span id="ContextInjector-710"><a href="#ContextInjector-710"><span class="linenos">710</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Event Summary:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-711"><a href="#ContextInjector-711"><span class="linenos">711</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Total Events: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;total_events&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-712"><a href="#ContextInjector-712"><span class="linenos">712</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-713"><a href="#ContextInjector-713"><span class="linenos">713</span></a>                <span class="sa">f</span><span class="s2">&quot;- Severity Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ContextInjector-714"><a href="#ContextInjector-714"><span class="linenos">714</span></a>            <span class="p">)</span>
</span><span id="ContextInjector-715"><a href="#ContextInjector-715"><span class="linenos">715</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="ContextInjector-716"><a href="#ContextInjector-716"><span class="linenos">716</span></a>                <span class="sa">f</span><span class="s2">&quot;- Category Distribution: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category_distribution&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ContextInjector-717"><a href="#ContextInjector-717"><span class="linenos">717</span></a>            <span class="p">)</span>
</span><span id="ContextInjector-718"><a href="#ContextInjector-718"><span class="linenos">718</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-719"><a href="#ContextInjector-719"><span class="linenos">719</span></a>            <span class="c1"># Full results format</span>
</span><span id="ContextInjector-720"><a href="#ContextInjector-720"><span class="linenos">720</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Limit to first 10</span>
</span><span id="ContextInjector-721"><a href="#ContextInjector-721"><span class="linenos">721</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-722"><a href="#ContextInjector-722"><span class="linenos">722</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;event_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-723"><a href="#ContextInjector-723"><span class="linenos">723</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Severity: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;severity&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-724"><a href="#ContextInjector-724"><span class="linenos">724</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Description: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No description&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-725"><a href="#ContextInjector-725"><span class="linenos">725</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-726"><a href="#ContextInjector-726"><span class="linenos">726</span></a>
</span><span id="ContextInjector-727"><a href="#ContextInjector-727"><span class="linenos">727</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span id="ContextInjector-728"><a href="#ContextInjector-728"><span class="linenos">728</span></a>
</span><span id="ContextInjector-729"><a href="#ContextInjector-729"><span class="linenos">729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="ContextInjector-730"><a href="#ContextInjector-730"><span class="linenos">730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract time range from events.</span>
</span><span id="ContextInjector-731"><a href="#ContextInjector-731"><span class="linenos">731</span></a>
</span><span id="ContextInjector-732"><a href="#ContextInjector-732"><span class="linenos">732</span></a><span class="sd">        Determines the earliest and latest timestamps from a list</span>
</span><span id="ContextInjector-733"><a href="#ContextInjector-733"><span class="linenos">733</span></a><span class="sd">        of events to establish the time range.</span>
</span><span id="ContextInjector-734"><a href="#ContextInjector-734"><span class="linenos">734</span></a>
</span><span id="ContextInjector-735"><a href="#ContextInjector-735"><span class="linenos">735</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-736"><a href="#ContextInjector-736"><span class="linenos">736</span></a><span class="sd">            events: List of event dictionaries</span>
</span><span id="ContextInjector-737"><a href="#ContextInjector-737"><span class="linenos">737</span></a>
</span><span id="ContextInjector-738"><a href="#ContextInjector-738"><span class="linenos">738</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-739"><a href="#ContextInjector-739"><span class="linenos">739</span></a><span class="sd">            Dictionary with &#39;start&#39; and &#39;end&#39; timestamps</span>
</span><span id="ContextInjector-740"><a href="#ContextInjector-740"><span class="linenos">740</span></a>
</span><span id="ContextInjector-741"><a href="#ContextInjector-741"><span class="linenos">741</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-742"><a href="#ContextInjector-742"><span class="linenos">742</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-743"><a href="#ContextInjector-743"><span class="linenos">743</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="ContextInjector-744"><a href="#ContextInjector-744"><span class="linenos">744</span></a>
</span><span id="ContextInjector-745"><a href="#ContextInjector-745"><span class="linenos">745</span></a>        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ContextInjector-746"><a href="#ContextInjector-746"><span class="linenos">746</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-747"><a href="#ContextInjector-747"><span class="linenos">747</span></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-748"><a href="#ContextInjector-748"><span class="linenos">748</span></a>            <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
</span><span id="ContextInjector-749"><a href="#ContextInjector-749"><span class="linenos">749</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ContextInjector-750"><a href="#ContextInjector-750"><span class="linenos">750</span></a>                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
</span><span id="ContextInjector-751"><a href="#ContextInjector-751"><span class="linenos">751</span></a>                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;isoformat&quot;</span><span class="p">):</span>
</span><span id="ContextInjector-752"><a href="#ContextInjector-752"><span class="linenos">752</span></a>                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
</span><span id="ContextInjector-753"><a href="#ContextInjector-753"><span class="linenos">753</span></a>
</span><span id="ContextInjector-754"><a href="#ContextInjector-754"><span class="linenos">754</span></a>        <span class="k">if</span> <span class="n">timestamps</span><span class="p">:</span>
</span><span id="ContextInjector-755"><a href="#ContextInjector-755"><span class="linenos">755</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="ContextInjector-756"><a href="#ContextInjector-756"><span class="linenos">756</span></a>                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">timestamps</span><span class="p">),</span>
</span><span id="ContextInjector-757"><a href="#ContextInjector-757"><span class="linenos">757</span></a>                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestamps</span><span class="p">),</span>
</span><span id="ContextInjector-758"><a href="#ContextInjector-758"><span class="linenos">758</span></a>            <span class="p">}</span>
</span><span id="ContextInjector-759"><a href="#ContextInjector-759"><span class="linenos">759</span></a>
</span><span id="ContextInjector-760"><a href="#ContextInjector-760"><span class="linenos">760</span></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="ContextInjector-761"><a href="#ContextInjector-761"><span class="linenos">761</span></a>
</span><span id="ContextInjector-762"><a href="#ContextInjector-762"><span class="linenos">762</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_data_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="ContextInjector-763"><a href="#ContextInjector-763"><span class="linenos">763</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract data sources from events.</span>
</span><span id="ContextInjector-764"><a href="#ContextInjector-764"><span class="linenos">764</span></a>
</span><span id="ContextInjector-765"><a href="#ContextInjector-765"><span class="linenos">765</span></a><span class="sd">        Identifies the unique data sources (indices) from which</span>
</span><span id="ContextInjector-766"><a href="#ContextInjector-766"><span class="linenos">766</span></a><span class="sd">        the events were retrieved.</span>
</span><span id="ContextInjector-767"><a href="#ContextInjector-767"><span class="linenos">767</span></a>
</span><span id="ContextInjector-768"><a href="#ContextInjector-768"><span class="linenos">768</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-769"><a href="#ContextInjector-769"><span class="linenos">769</span></a><span class="sd">            events: List of event dictionaries</span>
</span><span id="ContextInjector-770"><a href="#ContextInjector-770"><span class="linenos">770</span></a>
</span><span id="ContextInjector-771"><a href="#ContextInjector-771"><span class="linenos">771</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-772"><a href="#ContextInjector-772"><span class="linenos">772</span></a><span class="sd">            List of unique data source names</span>
</span><span id="ContextInjector-773"><a href="#ContextInjector-773"><span class="linenos">773</span></a>
</span><span id="ContextInjector-774"><a href="#ContextInjector-774"><span class="linenos">774</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-775"><a href="#ContextInjector-775"><span class="linenos">775</span></a>        <span class="n">sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="ContextInjector-776"><a href="#ContextInjector-776"><span class="linenos">776</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-777"><a href="#ContextInjector-777"><span class="linenos">777</span></a>            <span class="k">if</span> <span class="s2">&quot;indices&quot;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
</span><span id="ContextInjector-778"><a href="#ContextInjector-778"><span class="linenos">778</span></a>                <span class="n">indices</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;indices&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-779"><a href="#ContextInjector-779"><span class="linenos">779</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ContextInjector-780"><a href="#ContextInjector-780"><span class="linenos">780</span></a>                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
</span><span id="ContextInjector-781"><a href="#ContextInjector-781"><span class="linenos">781</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="ContextInjector-782"><a href="#ContextInjector-782"><span class="linenos">782</span></a>                            <span class="n">sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="ContextInjector-783"><a href="#ContextInjector-783"><span class="linenos">783</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-784"><a href="#ContextInjector-784"><span class="linenos">784</span></a>                            <span class="n">sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="ContextInjector-785"><a href="#ContextInjector-785"><span class="linenos">785</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-786"><a href="#ContextInjector-786"><span class="linenos">786</span></a>                    <span class="n">sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
</span><span id="ContextInjector-787"><a href="#ContextInjector-787"><span class="linenos">787</span></a>
</span><span id="ContextInjector-788"><a href="#ContextInjector-788"><span class="linenos">788</span></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
</span><span id="ContextInjector-789"><a href="#ContextInjector-789"><span class="linenos">789</span></a>
</span><span id="ContextInjector-790"><a href="#ContextInjector-790"><span class="linenos">790</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_attack_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="ContextInjector-791"><a href="#ContextInjector-791"><span class="linenos">791</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect attack patterns in events.</span>
</span><span id="ContextInjector-792"><a href="#ContextInjector-792"><span class="linenos">792</span></a>
</span><span id="ContextInjector-793"><a href="#ContextInjector-793"><span class="linenos">793</span></a><span class="sd">        Analyzes events to identify common attack patterns and</span>
</span><span id="ContextInjector-794"><a href="#ContextInjector-794"><span class="linenos">794</span></a><span class="sd">        their frequencies.</span>
</span><span id="ContextInjector-795"><a href="#ContextInjector-795"><span class="linenos">795</span></a>
</span><span id="ContextInjector-796"><a href="#ContextInjector-796"><span class="linenos">796</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector-797"><a href="#ContextInjector-797"><span class="linenos">797</span></a><span class="sd">            events: List of event dictionaries</span>
</span><span id="ContextInjector-798"><a href="#ContextInjector-798"><span class="linenos">798</span></a>
</span><span id="ContextInjector-799"><a href="#ContextInjector-799"><span class="linenos">799</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector-800"><a href="#ContextInjector-800"><span class="linenos">800</span></a><span class="sd">            Dictionary mapping attack patterns to their counts</span>
</span><span id="ContextInjector-801"><a href="#ContextInjector-801"><span class="linenos">801</span></a>
</span><span id="ContextInjector-802"><a href="#ContextInjector-802"><span class="linenos">802</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector-803"><a href="#ContextInjector-803"><span class="linenos">803</span></a>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector-804"><a href="#ContextInjector-804"><span class="linenos">804</span></a>            <span class="s2">&quot;brute_force&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-805"><a href="#ContextInjector-805"><span class="linenos">805</span></a>            <span class="s2">&quot;port_scan&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-806"><a href="#ContextInjector-806"><span class="linenos">806</span></a>            <span class="s2">&quot;sql_injection&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-807"><a href="#ContextInjector-807"><span class="linenos">807</span></a>            <span class="s2">&quot;xss&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-808"><a href="#ContextInjector-808"><span class="linenos">808</span></a>            <span class="s2">&quot;ddos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-809"><a href="#ContextInjector-809"><span class="linenos">809</span></a>            <span class="s2">&quot;malware&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-810"><a href="#ContextInjector-810"><span class="linenos">810</span></a>            <span class="s2">&quot;phishing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-811"><a href="#ContextInjector-811"><span class="linenos">811</span></a>            <span class="s2">&quot;reconnaissance&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ContextInjector-812"><a href="#ContextInjector-812"><span class="linenos">812</span></a>        <span class="p">}</span>
</span><span id="ContextInjector-813"><a href="#ContextInjector-813"><span class="linenos">813</span></a>
</span><span id="ContextInjector-814"><a href="#ContextInjector-814"><span class="linenos">814</span></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
</span><span id="ContextInjector-815"><a href="#ContextInjector-815"><span class="linenos">815</span></a>            <span class="c1"># Robustly handle both strings and lists for description and event_type</span>
</span><span id="ContextInjector-816"><a href="#ContextInjector-816"><span class="linenos">816</span></a>            <span class="n">description_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-817"><a href="#ContextInjector-817"><span class="linenos">817</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">description_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ContextInjector-818"><a href="#ContextInjector-818"><span class="linenos">818</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">description_raw</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="ContextInjector-819"><a href="#ContextInjector-819"><span class="linenos">819</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-820"><a href="#ContextInjector-820"><span class="linenos">820</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">description_raw</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="ContextInjector-821"><a href="#ContextInjector-821"><span class="linenos">821</span></a>
</span><span id="ContextInjector-822"><a href="#ContextInjector-822"><span class="linenos">822</span></a>            <span class="n">event_type_raw</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ContextInjector-823"><a href="#ContextInjector-823"><span class="linenos">823</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_type_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ContextInjector-824"><a href="#ContextInjector-824"><span class="linenos">824</span></a>                <span class="n">event_type</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">event_type_raw</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="ContextInjector-825"><a href="#ContextInjector-825"><span class="linenos">825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ContextInjector-826"><a href="#ContextInjector-826"><span class="linenos">826</span></a>                <span class="n">event_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event_type_raw</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="ContextInjector-827"><a href="#ContextInjector-827"><span class="linenos">827</span></a>
</span><span id="ContextInjector-828"><a href="#ContextInjector-828"><span class="linenos">828</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-829"><a href="#ContextInjector-829"><span class="linenos">829</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span>
</span><span id="ContextInjector-830"><a href="#ContextInjector-830"><span class="linenos">830</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;brute&quot;</span><span class="p">,</span> <span class="s2">&quot;auth&quot;</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-831"><a href="#ContextInjector-831"><span class="linenos">831</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-832"><a href="#ContextInjector-832"><span class="linenos">832</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;brute_force&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-833"><a href="#ContextInjector-833"><span class="linenos">833</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-834"><a href="#ContextInjector-834"><span class="linenos">834</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span>
</span><span id="ContextInjector-835"><a href="#ContextInjector-835"><span class="linenos">835</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;nmap&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-836"><a href="#ContextInjector-836"><span class="linenos">836</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-837"><a href="#ContextInjector-837"><span class="linenos">837</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;port_scan&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-838"><a href="#ContextInjector-838"><span class="linenos">838</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-839"><a href="#ContextInjector-839"><span class="linenos">839</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sql&quot;</span><span class="p">,</span> <span class="s2">&quot;injection&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-840"><a href="#ContextInjector-840"><span class="linenos">840</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-841"><a href="#ContextInjector-841"><span class="linenos">841</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;sql_injection&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-842"><a href="#ContextInjector-842"><span class="linenos">842</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-843"><a href="#ContextInjector-843"><span class="linenos">843</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;xss&quot;</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-844"><a href="#ContextInjector-844"><span class="linenos">844</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-845"><a href="#ContextInjector-845"><span class="linenos">845</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;xss&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-846"><a href="#ContextInjector-846"><span class="linenos">846</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-847"><a href="#ContextInjector-847"><span class="linenos">847</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ddos&quot;</span><span class="p">,</span> <span class="s2">&quot;flood&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-848"><a href="#ContextInjector-848"><span class="linenos">848</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-849"><a href="#ContextInjector-849"><span class="linenos">849</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;ddos&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-850"><a href="#ContextInjector-850"><span class="linenos">850</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-851"><a href="#ContextInjector-851"><span class="linenos">851</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;malware&quot;</span><span class="p">,</span> <span class="s2">&quot;virus&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-852"><a href="#ContextInjector-852"><span class="linenos">852</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-853"><a href="#ContextInjector-853"><span class="linenos">853</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;malware&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-854"><a href="#ContextInjector-854"><span class="linenos">854</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-855"><a href="#ContextInjector-855"><span class="linenos">855</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;phishing&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-856"><a href="#ContextInjector-856"><span class="linenos">856</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-857"><a href="#ContextInjector-857"><span class="linenos">857</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;phishing&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-858"><a href="#ContextInjector-858"><span class="linenos">858</span></a>            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span>
</span><span id="ContextInjector-859"><a href="#ContextInjector-859"><span class="linenos">859</span></a>                <span class="n">keyword</span> <span class="ow">in</span> <span class="n">description</span> <span class="ow">or</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">event_type</span>
</span><span id="ContextInjector-860"><a href="#ContextInjector-860"><span class="linenos">860</span></a>                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;recon&quot;</span><span class="p">,</span> <span class="s2">&quot;enumeration&quot;</span><span class="p">]</span>
</span><span id="ContextInjector-861"><a href="#ContextInjector-861"><span class="linenos">861</span></a>            <span class="p">):</span>
</span><span id="ContextInjector-862"><a href="#ContextInjector-862"><span class="linenos">862</span></a>                <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;reconnaissance&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ContextInjector-863"><a href="#ContextInjector-863"><span class="linenos">863</span></a>
</span><span id="ContextInjector-864"><a href="#ContextInjector-864"><span class="linenos">864</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Prepare and inject security context for ChatGPT analysis.</p>

<p>This class provides methods to prepare and format various types of
security data for injection into ChatGPT conversations. It supports
multiple output formats and optimizes data for AI consumption.</p>

<p>Attributes:
    max_context_size: Maximum context size in characters
    include_raw_data: Whether to include raw data in context
    context_format: Output format (structured, summary, or raw)</p>

<p>Example:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>injector = ContextInjector()
      context = injector.prepare_security_context(events)
      formatted = injector.inject_context_for_chatgpt(context)</p>
    </blockquote>
  </blockquote>
</blockquote>
</div>


                            <div id="ContextInjector.__init__" class="classattr">
                                        <input id="ContextInjector.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="name">ContextInjector</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="ContextInjector.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector.__init__-58"><a href="#ContextInjector.__init__-58"><span class="linenos">58</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ContextInjector.__init__-59"><a href="#ContextInjector.__init__-59"><span class="linenos">59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ContextInjector.</span>
</span><span id="ContextInjector.__init__-60"><a href="#ContextInjector.__init__-60"><span class="linenos">60</span></a>
</span><span id="ContextInjector.__init__-61"><a href="#ContextInjector.__init__-61"><span class="linenos">61</span></a><span class="sd">        Loads configuration from environment variables for context</span>
</span><span id="ContextInjector.__init__-62"><a href="#ContextInjector.__init__-62"><span class="linenos">62</span></a><span class="sd">        formatting preferences and size limits.</span>
</span><span id="ContextInjector.__init__-63"><a href="#ContextInjector.__init__-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector.__init__-64"><a href="#ContextInjector.__init__-64"><span class="linenos">64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_context_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAX_CONTEXT_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;10000&quot;</span><span class="p">))</span>  <span class="c1"># characters</span>
</span><span id="ContextInjector.__init__-65"><a href="#ContextInjector.__init__-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;INCLUDE_RAW_DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>
</span><span id="ContextInjector.__init__-66"><a href="#ContextInjector.__init__-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
</span><span id="ContextInjector.__init__-67"><a href="#ContextInjector.__init__-67"><span class="linenos">67</span></a>            <span class="s2">&quot;CONTEXT_FORMAT&quot;</span><span class="p">,</span> <span class="s2">&quot;structured&quot;</span>
</span><span id="ContextInjector.__init__-68"><a href="#ContextInjector.__init__-68"><span class="linenos">68</span></a>        <span class="p">)</span>  <span class="c1"># structured, summary, or raw</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the ContextInjector.</p>

<p>Loads configuration from environment variables for context
formatting preferences and size limits.</p>
</div>


                            </div>
                            <div id="ContextInjector.max_context_size" class="classattr">
                                <div class="attr variable">
            <span class="name">max_context_size</span>


    </div>
    <a class="headerlink" href="#ContextInjector.max_context_size"></a>



                            </div>
                            <div id="ContextInjector.include_raw_data" class="classattr">
                                <div class="attr variable">
            <span class="name">include_raw_data</span>


    </div>
    <a class="headerlink" href="#ContextInjector.include_raw_data"></a>



                            </div>
                            <div id="ContextInjector.context_format" class="classattr">
                                <div class="attr variable">
            <span class="name">context_format</span>


    </div>
    <a class="headerlink" href="#ContextInjector.context_format"></a>



                            </div>
                            <div id="ContextInjector.prepare_security_context" class="classattr">
                                        <input id="ContextInjector.prepare_security_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">prepare_security_context</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>,</span><span class="param">	<span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ContextInjector.prepare_security_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector.prepare_security_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector.prepare_security_context-70"><a href="#ContextInjector.prepare_security_context-70"><span class="linenos"> 70</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_security_context</span><span class="p">(</span>
</span><span id="ContextInjector.prepare_security_context-71"><a href="#ContextInjector.prepare_security_context-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_security_context-72"><a href="#ContextInjector.prepare_security_context-72"><span class="linenos"> 72</span></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="ContextInjector.prepare_security_context-73"><a href="#ContextInjector.prepare_security_context-73"><span class="linenos"> 73</span></a>        <span class="n">threat_intelligence</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_security_context-74"><a href="#ContextInjector.prepare_security_context-74"><span class="linenos"> 74</span></a>        <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_security_context-75"><a href="#ContextInjector.prepare_security_context-75"><span class="linenos"> 75</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector.prepare_security_context-76"><a href="#ContextInjector.prepare_security_context-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare security context for injection.</span>
</span><span id="ContextInjector.prepare_security_context-77"><a href="#ContextInjector.prepare_security_context-77"><span class="linenos"> 77</span></a>
</span><span id="ContextInjector.prepare_security_context-78"><a href="#ContextInjector.prepare_security_context-78"><span class="linenos"> 78</span></a><span class="sd">        Creates a comprehensive security context from events, threat</span>
</span><span id="ContextInjector.prepare_security_context-79"><a href="#ContextInjector.prepare_security_context-79"><span class="linenos"> 79</span></a><span class="sd">        intelligence, and summary data, formatted according to the</span>
</span><span id="ContextInjector.prepare_security_context-80"><a href="#ContextInjector.prepare_security_context-80"><span class="linenos"> 80</span></a><span class="sd">        configured context format preference.</span>
</span><span id="ContextInjector.prepare_security_context-81"><a href="#ContextInjector.prepare_security_context-81"><span class="linenos"> 81</span></a>
</span><span id="ContextInjector.prepare_security_context-82"><a href="#ContextInjector.prepare_security_context-82"><span class="linenos"> 82</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector.prepare_security_context-83"><a href="#ContextInjector.prepare_security_context-83"><span class="linenos"> 83</span></a><span class="sd">            events: List of security event dictionaries</span>
</span><span id="ContextInjector.prepare_security_context-84"><a href="#ContextInjector.prepare_security_context-84"><span class="linenos"> 84</span></a><span class="sd">            threat_intelligence: Optional threat intelligence data</span>
</span><span id="ContextInjector.prepare_security_context-85"><a href="#ContextInjector.prepare_security_context-85"><span class="linenos"> 85</span></a><span class="sd">            summary: Optional summary data</span>
</span><span id="ContextInjector.prepare_security_context-86"><a href="#ContextInjector.prepare_security_context-86"><span class="linenos"> 86</span></a>
</span><span id="ContextInjector.prepare_security_context-87"><a href="#ContextInjector.prepare_security_context-87"><span class="linenos"> 87</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector.prepare_security_context-88"><a href="#ContextInjector.prepare_security_context-88"><span class="linenos"> 88</span></a><span class="sd">            Dictionary containing formatted security context</span>
</span><span id="ContextInjector.prepare_security_context-89"><a href="#ContextInjector.prepare_security_context-89"><span class="linenos"> 89</span></a>
</span><span id="ContextInjector.prepare_security_context-90"><a href="#ContextInjector.prepare_security_context-90"><span class="linenos"> 90</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector.prepare_security_context-91"><a href="#ContextInjector.prepare_security_context-91"><span class="linenos"> 91</span></a>        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_security_context-92"><a href="#ContextInjector.prepare_security_context-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector.prepare_security_context-93"><a href="#ContextInjector.prepare_security_context-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;security_analysis&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_security_context-94"><a href="#ContextInjector.prepare_security_context-94"><span class="linenos"> 94</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="ContextInjector.prepare_security_context-95"><a href="#ContextInjector.prepare_security_context-95"><span class="linenos"> 95</span></a>        <span class="p">}</span>
</span><span id="ContextInjector.prepare_security_context-96"><a href="#ContextInjector.prepare_security_context-96"><span class="linenos"> 96</span></a>
</span><span id="ContextInjector.prepare_security_context-97"><a href="#ContextInjector.prepare_security_context-97"><span class="linenos"> 97</span></a>        <span class="c1"># Add events based on format preference</span>
</span><span id="ContextInjector.prepare_security_context-98"><a href="#ContextInjector.prepare_security_context-98"><span class="linenos"> 98</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;structured&quot;</span><span class="p">:</span>
</span><span id="ContextInjector.prepare_security_context-99"><a href="#ContextInjector.prepare_security_context-99"><span class="linenos"> 99</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-100"><a href="#ContextInjector.prepare_security_context-100"><span class="linenos">100</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span> <span class="o">==</span> <span class="s2">&quot;summary&quot;</span><span class="p">:</span>
</span><span id="ContextInjector.prepare_security_context-101"><a href="#ContextInjector.prepare_security_context-101"><span class="linenos">101</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-102"><a href="#ContextInjector.prepare_security_context-102"><span class="linenos">102</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># raw</span>
</span><span id="ContextInjector.prepare_security_context-103"><a href="#ContextInjector.prepare_security_context-103"><span class="linenos">103</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ContextInjector.prepare_security_context-104"><a href="#ContextInjector.prepare_security_context-104"><span class="linenos">104</span></a>                <span class="n">events</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_raw_data</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-105"><a href="#ContextInjector.prepare_security_context-105"><span class="linenos">105</span></a>            <span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-106"><a href="#ContextInjector.prepare_security_context-106"><span class="linenos">106</span></a>
</span><span id="ContextInjector.prepare_security_context-107"><a href="#ContextInjector.prepare_security_context-107"><span class="linenos">107</span></a>        <span class="c1"># Add threat intelligence</span>
</span><span id="ContextInjector.prepare_security_context-108"><a href="#ContextInjector.prepare_security_context-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">threat_intelligence</span><span class="p">:</span>
</span><span id="ContextInjector.prepare_security_context-109"><a href="#ContextInjector.prepare_security_context-109"><span class="linenos">109</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;threat_intelligence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_threat_intelligence</span><span class="p">(</span>
</span><span id="ContextInjector.prepare_security_context-110"><a href="#ContextInjector.prepare_security_context-110"><span class="linenos">110</span></a>                <span class="n">threat_intelligence</span>
</span><span id="ContextInjector.prepare_security_context-111"><a href="#ContextInjector.prepare_security_context-111"><span class="linenos">111</span></a>            <span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-112"><a href="#ContextInjector.prepare_security_context-112"><span class="linenos">112</span></a>
</span><span id="ContextInjector.prepare_security_context-113"><a href="#ContextInjector.prepare_security_context-113"><span class="linenos">113</span></a>        <span class="c1"># Add summary if provided</span>
</span><span id="ContextInjector.prepare_security_context-114"><a href="#ContextInjector.prepare_security_context-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
</span><span id="ContextInjector.prepare_security_context-115"><a href="#ContextInjector.prepare_security_context-115"><span class="linenos">115</span></a>            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span>
</span><span id="ContextInjector.prepare_security_context-116"><a href="#ContextInjector.prepare_security_context-116"><span class="linenos">116</span></a>
</span><span id="ContextInjector.prepare_security_context-117"><a href="#ContextInjector.prepare_security_context-117"><span class="linenos">117</span></a>        <span class="c1"># Add metadata</span>
</span><span id="ContextInjector.prepare_security_context-118"><a href="#ContextInjector.prepare_security_context-118"><span class="linenos">118</span></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_metadata</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">threat_intelligence</span><span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-119"><a href="#ContextInjector.prepare_security_context-119"><span class="linenos">119</span></a>
</span><span id="ContextInjector.prepare_security_context-120"><a href="#ContextInjector.prepare_security_context-120"><span class="linenos">120</span></a>        <span class="c1"># Add analysis hints</span>
</span><span id="ContextInjector.prepare_security_context-121"><a href="#ContextInjector.prepare_security_context-121"><span class="linenos">121</span></a>        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;analysis_hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_analysis_hints</span><span class="p">(</span>
</span><span id="ContextInjector.prepare_security_context-122"><a href="#ContextInjector.prepare_security_context-122"><span class="linenos">122</span></a>            <span class="n">events</span><span class="p">,</span> <span class="n">threat_intelligence</span>
</span><span id="ContextInjector.prepare_security_context-123"><a href="#ContextInjector.prepare_security_context-123"><span class="linenos">123</span></a>        <span class="p">)</span>
</span><span id="ContextInjector.prepare_security_context-124"><a href="#ContextInjector.prepare_security_context-124"><span class="linenos">124</span></a>
</span><span id="ContextInjector.prepare_security_context-125"><a href="#ContextInjector.prepare_security_context-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="n">context</span>
</span></pre></div>


            <div class="docstring"><p>Prepare security context for injection.</p>

<p>Creates a comprehensive security context from events, threat
intelligence, and summary data, formatted according to the
configured context format preference.</p>

<p>Args:
    events: List of security event dictionaries
    threat_intelligence: Optional threat intelligence data
    summary: Optional summary data</p>

<p>Returns:
    Dictionary containing formatted security context</p>
</div>


                            </div>
                            <div id="ContextInjector.prepare_attack_report_context" class="classattr">
                                        <input id="ContextInjector.prepare_attack_report_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">prepare_attack_report_context</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">report</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ContextInjector.prepare_attack_report_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector.prepare_attack_report_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector.prepare_attack_report_context-127"><a href="#ContextInjector.prepare_attack_report_context-127"><span class="linenos">127</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_attack_report_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector.prepare_attack_report_context-128"><a href="#ContextInjector.prepare_attack_report_context-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare attack report context for injection.</span>
</span><span id="ContextInjector.prepare_attack_report_context-129"><a href="#ContextInjector.prepare_attack_report_context-129"><span class="linenos">129</span></a>
</span><span id="ContextInjector.prepare_attack_report_context-130"><a href="#ContextInjector.prepare_attack_report_context-130"><span class="linenos">130</span></a><span class="sd">        Formats an attack report for injection into ChatGPT conversations,</span>
</span><span id="ContextInjector.prepare_attack_report_context-131"><a href="#ContextInjector.prepare_attack_report_context-131"><span class="linenos">131</span></a><span class="sd">        including metadata and confidence information.</span>
</span><span id="ContextInjector.prepare_attack_report_context-132"><a href="#ContextInjector.prepare_attack_report_context-132"><span class="linenos">132</span></a>
</span><span id="ContextInjector.prepare_attack_report_context-133"><a href="#ContextInjector.prepare_attack_report_context-133"><span class="linenos">133</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector.prepare_attack_report_context-134"><a href="#ContextInjector.prepare_attack_report_context-134"><span class="linenos">134</span></a><span class="sd">            report: Attack report dictionary</span>
</span><span id="ContextInjector.prepare_attack_report_context-135"><a href="#ContextInjector.prepare_attack_report_context-135"><span class="linenos">135</span></a>
</span><span id="ContextInjector.prepare_attack_report_context-136"><a href="#ContextInjector.prepare_attack_report_context-136"><span class="linenos">136</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector.prepare_attack_report_context-137"><a href="#ContextInjector.prepare_attack_report_context-137"><span class="linenos">137</span></a><span class="sd">            Dictionary containing formatted attack report context</span>
</span><span id="ContextInjector.prepare_attack_report_context-138"><a href="#ContextInjector.prepare_attack_report_context-138"><span class="linenos">138</span></a>
</span><span id="ContextInjector.prepare_attack_report_context-139"><a href="#ContextInjector.prepare_attack_report_context-139"><span class="linenos">139</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector.prepare_attack_report_context-140"><a href="#ContextInjector.prepare_attack_report_context-140"><span class="linenos">140</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_attack_report_context-141"><a href="#ContextInjector.prepare_attack_report_context-141"><span class="linenos">141</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector.prepare_attack_report_context-142"><a href="#ContextInjector.prepare_attack_report_context-142"><span class="linenos">142</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;attack_report&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_attack_report_context-143"><a href="#ContextInjector.prepare_attack_report_context-143"><span class="linenos">143</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_attack_report_context-144"><a href="#ContextInjector.prepare_attack_report_context-144"><span class="linenos">144</span></a>                <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_attack_report</span><span class="p">(</span><span class="n">report</span><span class="p">),</span>
</span><span id="ContextInjector.prepare_attack_report_context-145"><a href="#ContextInjector.prepare_attack_report_context-145"><span class="linenos">145</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_attack_report_context-146"><a href="#ContextInjector.prepare_attack_report_context-146"><span class="linenos">146</span></a>                    <span class="s2">&quot;report_id&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;report_id&quot;</span><span class="p">),</span>
</span><span id="ContextInjector.prepare_attack_report_context-147"><a href="#ContextInjector.prepare_attack_report_context-147"><span class="linenos">147</span></a>                    <span class="s2">&quot;confidence_level&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence_level&quot;</span><span class="p">),</span>
</span><span id="ContextInjector.prepare_attack_report_context-148"><a href="#ContextInjector.prepare_attack_report_context-148"><span class="linenos">148</span></a>                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="ContextInjector.prepare_attack_report_context-149"><a href="#ContextInjector.prepare_attack_report_context-149"><span class="linenos">149</span></a>                <span class="p">},</span>
</span><span id="ContextInjector.prepare_attack_report_context-150"><a href="#ContextInjector.prepare_attack_report_context-150"><span class="linenos">150</span></a>            <span class="p">},</span>
</span><span id="ContextInjector.prepare_attack_report_context-151"><a href="#ContextInjector.prepare_attack_report_context-151"><span class="linenos">151</span></a>        <span class="p">}</span>
</span><span id="ContextInjector.prepare_attack_report_context-152"><a href="#ContextInjector.prepare_attack_report_context-152"><span class="linenos">152</span></a>
</span><span id="ContextInjector.prepare_attack_report_context-153"><a href="#ContextInjector.prepare_attack_report_context-153"><span class="linenos">153</span></a>        <span class="k">return</span> <span class="n">context</span>
</span></pre></div>


            <div class="docstring"><p>Prepare attack report context for injection.</p>

<p>Formats an attack report for injection into ChatGPT conversations,
including metadata and confidence information.</p>

<p>Args:
    report: Attack report dictionary</p>

<p>Returns:
    Dictionary containing formatted attack report context</p>
</div>


                            </div>
                            <div id="ContextInjector.prepare_query_context" class="classattr">
                                        <input id="ContextInjector.prepare_query_context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">prepare_query_context</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>,</span><span class="param">	<span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ContextInjector.prepare_query_context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector.prepare_query_context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector.prepare_query_context-155"><a href="#ContextInjector.prepare_query_context-155"><span class="linenos">155</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_query_context</span><span class="p">(</span>
</span><span id="ContextInjector.prepare_query_context-156"><a href="#ContextInjector.prepare_query_context-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_query_context-157"><a href="#ContextInjector.prepare_query_context-157"><span class="linenos">157</span></a>        <span class="n">query_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_query_context-158"><a href="#ContextInjector.prepare_query_context-158"><span class="linenos">158</span></a>        <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="ContextInjector.prepare_query_context-159"><a href="#ContextInjector.prepare_query_context-159"><span class="linenos">159</span></a>        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="ContextInjector.prepare_query_context-160"><a href="#ContextInjector.prepare_query_context-160"><span class="linenos">160</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector.prepare_query_context-161"><a href="#ContextInjector.prepare_query_context-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare query context for injection.</span>
</span><span id="ContextInjector.prepare_query_context-162"><a href="#ContextInjector.prepare_query_context-162"><span class="linenos">162</span></a>
</span><span id="ContextInjector.prepare_query_context-163"><a href="#ContextInjector.prepare_query_context-163"><span class="linenos">163</span></a><span class="sd">        Formats query results and parameters for injection into ChatGPT</span>
</span><span id="ContextInjector.prepare_query_context-164"><a href="#ContextInjector.prepare_query_context-164"><span class="linenos">164</span></a><span class="sd">        conversations, including metadata about the query execution.</span>
</span><span id="ContextInjector.prepare_query_context-165"><a href="#ContextInjector.prepare_query_context-165"><span class="linenos">165</span></a>
</span><span id="ContextInjector.prepare_query_context-166"><a href="#ContextInjector.prepare_query_context-166"><span class="linenos">166</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector.prepare_query_context-167"><a href="#ContextInjector.prepare_query_context-167"><span class="linenos">167</span></a><span class="sd">            query_type: Type of query that was executed</span>
</span><span id="ContextInjector.prepare_query_context-168"><a href="#ContextInjector.prepare_query_context-168"><span class="linenos">168</span></a><span class="sd">            parameters: Query parameters that were used</span>
</span><span id="ContextInjector.prepare_query_context-169"><a href="#ContextInjector.prepare_query_context-169"><span class="linenos">169</span></a><span class="sd">            results: Query results to format</span>
</span><span id="ContextInjector.prepare_query_context-170"><a href="#ContextInjector.prepare_query_context-170"><span class="linenos">170</span></a>
</span><span id="ContextInjector.prepare_query_context-171"><a href="#ContextInjector.prepare_query_context-171"><span class="linenos">171</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector.prepare_query_context-172"><a href="#ContextInjector.prepare_query_context-172"><span class="linenos">172</span></a><span class="sd">            Dictionary containing formatted query context</span>
</span><span id="ContextInjector.prepare_query_context-173"><a href="#ContextInjector.prepare_query_context-173"><span class="linenos">173</span></a>
</span><span id="ContextInjector.prepare_query_context-174"><a href="#ContextInjector.prepare_query_context-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector.prepare_query_context-175"><a href="#ContextInjector.prepare_query_context-175"><span class="linenos">175</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_query_context-176"><a href="#ContextInjector.prepare_query_context-176"><span class="linenos">176</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector.prepare_query_context-177"><a href="#ContextInjector.prepare_query_context-177"><span class="linenos">177</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="s2">&quot;query_results&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_query_context-178"><a href="#ContextInjector.prepare_query_context-178"><span class="linenos">178</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_query_context-179"><a href="#ContextInjector.prepare_query_context-179"><span class="linenos">179</span></a>                <span class="s2">&quot;query_type&quot;</span><span class="p">:</span> <span class="n">query_type</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_query_context-180"><a href="#ContextInjector.prepare_query_context-180"><span class="linenos">180</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_query_context-181"><a href="#ContextInjector.prepare_query_context-181"><span class="linenos">181</span></a>                <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_results</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span><span id="ContextInjector.prepare_query_context-182"><a href="#ContextInjector.prepare_query_context-182"><span class="linenos">182</span></a>                <span class="s2">&quot;result_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span><span id="ContextInjector.prepare_query_context-183"><a href="#ContextInjector.prepare_query_context-183"><span class="linenos">183</span></a>                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector.prepare_query_context-184"><a href="#ContextInjector.prepare_query_context-184"><span class="linenos">184</span></a>                    <span class="s2">&quot;query_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ContextInjector.prepare_query_context-185"><a href="#ContextInjector.prepare_query_context-185"><span class="linenos">185</span></a>                    <span class="s2">&quot;result_format&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_format</span><span class="p">,</span>
</span><span id="ContextInjector.prepare_query_context-186"><a href="#ContextInjector.prepare_query_context-186"><span class="linenos">186</span></a>                <span class="p">},</span>
</span><span id="ContextInjector.prepare_query_context-187"><a href="#ContextInjector.prepare_query_context-187"><span class="linenos">187</span></a>            <span class="p">},</span>
</span><span id="ContextInjector.prepare_query_context-188"><a href="#ContextInjector.prepare_query_context-188"><span class="linenos">188</span></a>        <span class="p">}</span>
</span><span id="ContextInjector.prepare_query_context-189"><a href="#ContextInjector.prepare_query_context-189"><span class="linenos">189</span></a>
</span><span id="ContextInjector.prepare_query_context-190"><a href="#ContextInjector.prepare_query_context-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="n">context</span>
</span></pre></div>


            <div class="docstring"><p>Prepare query context for injection.</p>

<p>Formats query results and parameters for injection into ChatGPT
conversations, including metadata about the query execution.</p>

<p>Args:
    query_type: Type of query that was executed
    parameters: Query parameters that were used
    results: Query results to format</p>

<p>Returns:
    Dictionary containing formatted query context</p>
</div>


                            </div>
                            <div id="ContextInjector.inject_context_for_chatgpt" class="classattr">
                                        <input id="ContextInjector.inject_context_for_chatgpt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">inject_context_for_chatgpt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="ContextInjector.inject_context_for_chatgpt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector.inject_context_for_chatgpt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector.inject_context_for_chatgpt-192"><a href="#ContextInjector.inject_context_for_chatgpt-192"><span class="linenos">192</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">inject_context_for_chatgpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-193"><a href="#ContextInjector.inject_context_for_chatgpt-193"><span class="linenos">193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format context for ChatGPT consumption.</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-194"><a href="#ContextInjector.inject_context_for_chatgpt-194"><span class="linenos">194</span></a>
</span><span id="ContextInjector.inject_context_for_chatgpt-195"><a href="#ContextInjector.inject_context_for_chatgpt-195"><span class="linenos">195</span></a><span class="sd">        Converts a context dictionary into a string format optimized</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-196"><a href="#ContextInjector.inject_context_for_chatgpt-196"><span class="linenos">196</span></a><span class="sd">        for ChatGPT consumption, handling different context types</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-197"><a href="#ContextInjector.inject_context_for_chatgpt-197"><span class="linenos">197</span></a><span class="sd">        appropriately.</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-198"><a href="#ContextInjector.inject_context_for_chatgpt-198"><span class="linenos">198</span></a>
</span><span id="ContextInjector.inject_context_for_chatgpt-199"><a href="#ContextInjector.inject_context_for_chatgpt-199"><span class="linenos">199</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-200"><a href="#ContextInjector.inject_context_for_chatgpt-200"><span class="linenos">200</span></a><span class="sd">            context: Context dictionary to format</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-201"><a href="#ContextInjector.inject_context_for_chatgpt-201"><span class="linenos">201</span></a>
</span><span id="ContextInjector.inject_context_for_chatgpt-202"><a href="#ContextInjector.inject_context_for_chatgpt-202"><span class="linenos">202</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-203"><a href="#ContextInjector.inject_context_for_chatgpt-203"><span class="linenos">203</span></a><span class="sd">            String formatted for ChatGPT consumption</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-204"><a href="#ContextInjector.inject_context_for_chatgpt-204"><span class="linenos">204</span></a>
</span><span id="ContextInjector.inject_context_for_chatgpt-205"><a href="#ContextInjector.inject_context_for_chatgpt-205"><span class="linenos">205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-206"><a href="#ContextInjector.inject_context_for_chatgpt-206"><span class="linenos">206</span></a>        <span class="c1"># Convert context to a readable format for ChatGPT</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-207"><a href="#ContextInjector.inject_context_for_chatgpt-207"><span class="linenos">207</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;security_analysis&quot;</span><span class="p">:</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-208"><a href="#ContextInjector.inject_context_for_chatgpt-208"><span class="linenos">208</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_security_context_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-209"><a href="#ContextInjector.inject_context_for_chatgpt-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;attack_report&quot;</span><span class="p">:</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-210"><a href="#ContextInjector.inject_context_for_chatgpt-210"><span class="linenos">210</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_attack_report_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-211"><a href="#ContextInjector.inject_context_for_chatgpt-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;query_results&quot;</span><span class="p">:</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-212"><a href="#ContextInjector.inject_context_for_chatgpt-212"><span class="linenos">212</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_query_results_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
</span><span id="ContextInjector.inject_context_for_chatgpt-213"><a href="#ContextInjector.inject_context_for_chatgpt-213"><span class="linenos">213</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Format context for ChatGPT consumption.</p>

<p>Converts a context dictionary into a string format optimized
for ChatGPT consumption, handling different context types
appropriately.</p>

<p>Args:
    context: Context dictionary to format</p>

<p>Returns:
    String formatted for ChatGPT consumption</p>
</div>


                            </div>
                            <div id="ContextInjector.create_mcp_context_injection" class="classattr">
                                        <input id="ContextInjector.create_mcp_context_injection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">

        <span class="def">def</span>
        <span class="name">create_mcp_context_injection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ContextInjector.create_mcp_context_injection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContextInjector.create_mcp_context_injection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContextInjector.create_mcp_context_injection-215"><a href="#ContextInjector.create_mcp_context_injection-215"><span class="linenos">215</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mcp_context_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="ContextInjector.create_mcp_context_injection-216"><a href="#ContextInjector.create_mcp_context_injection-216"><span class="linenos">216</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create MCP-compatible context injection.</span>
</span><span id="ContextInjector.create_mcp_context_injection-217"><a href="#ContextInjector.create_mcp_context_injection-217"><span class="linenos">217</span></a>
</span><span id="ContextInjector.create_mcp_context_injection-218"><a href="#ContextInjector.create_mcp_context_injection-218"><span class="linenos">218</span></a><span class="sd">        Formats context data for use with the Model Context Protocol (MCP),</span>
</span><span id="ContextInjector.create_mcp_context_injection-219"><a href="#ContextInjector.create_mcp_context_injection-219"><span class="linenos">219</span></a><span class="sd">        including proper metadata and version information.</span>
</span><span id="ContextInjector.create_mcp_context_injection-220"><a href="#ContextInjector.create_mcp_context_injection-220"><span class="linenos">220</span></a>
</span><span id="ContextInjector.create_mcp_context_injection-221"><a href="#ContextInjector.create_mcp_context_injection-221"><span class="linenos">221</span></a><span class="sd">        Args:</span>
</span><span id="ContextInjector.create_mcp_context_injection-222"><a href="#ContextInjector.create_mcp_context_injection-222"><span class="linenos">222</span></a><span class="sd">            context: Context dictionary to format</span>
</span><span id="ContextInjector.create_mcp_context_injection-223"><a href="#ContextInjector.create_mcp_context_injection-223"><span class="linenos">223</span></a>
</span><span id="ContextInjector.create_mcp_context_injection-224"><a href="#ContextInjector.create_mcp_context_injection-224"><span class="linenos">224</span></a><span class="sd">        Returns:</span>
</span><span id="ContextInjector.create_mcp_context_injection-225"><a href="#ContextInjector.create_mcp_context_injection-225"><span class="linenos">225</span></a><span class="sd">            Dictionary formatted for MCP protocol</span>
</span><span id="ContextInjector.create_mcp_context_injection-226"><a href="#ContextInjector.create_mcp_context_injection-226"><span class="linenos">226</span></a>
</span><span id="ContextInjector.create_mcp_context_injection-227"><a href="#ContextInjector.create_mcp_context_injection-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContextInjector.create_mcp_context_injection-228"><a href="#ContextInjector.create_mcp_context_injection-228"><span class="linenos">228</span></a>        <span class="c1"># Format for MCP protocol</span>
</span><span id="ContextInjector.create_mcp_context_injection-229"><a href="#ContextInjector.create_mcp_context_injection-229"><span class="linenos">229</span></a>        <span class="n">mcp_context</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ContextInjector.create_mcp_context_injection-230"><a href="#ContextInjector.create_mcp_context_injection-230"><span class="linenos">230</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;context_injection&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.create_mcp_context_injection-231"><a href="#ContextInjector.create_mcp_context_injection-231"><span class="linenos">231</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
</span><span id="ContextInjector.create_mcp_context_injection-232"><a href="#ContextInjector.create_mcp_context_injection-232"><span class="linenos">232</span></a>            <span class="s2">&quot;context_type&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;context_type&quot;</span><span class="p">],</span>
</span><span id="ContextInjector.create_mcp_context_injection-233"><a href="#ContextInjector.create_mcp_context_injection-233"><span class="linenos">233</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inject_context_for_chatgpt</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span><span id="ContextInjector.create_mcp_context_injection-234"><a href="#ContextInjector.create_mcp_context_injection-234"><span class="linenos">234</span></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ContextInjector.create_mcp_context_injection-235"><a href="#ContextInjector.create_mcp_context_injection-235"><span class="linenos">235</span></a>                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;dshield-elastic-mcp&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.create_mcp_context_injection-236"><a href="#ContextInjector.create_mcp_context_injection-236"><span class="linenos">236</span></a>                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.create_mcp_context_injection-237"><a href="#ContextInjector.create_mcp_context_injection-237"><span class="linenos">237</span></a>                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;structured_text&quot;</span><span class="p">,</span>
</span><span id="ContextInjector.create_mcp_context_injection-238"><a href="#ContextInjector.create_mcp_context_injection-238"><span class="linenos">238</span></a>            <span class="p">},</span>
</span><span id="ContextInjector.create_mcp_context_injection-239"><a href="#ContextInjector.create_mcp_context_injection-239"><span class="linenos">239</span></a>        <span class="p">}</span>
</span><span id="ContextInjector.create_mcp_context_injection-240"><a href="#ContextInjector.create_mcp_context_injection-240"><span class="linenos">240</span></a>
</span><span id="ContextInjector.create_mcp_context_injection-241"><a href="#ContextInjector.create_mcp_context_injection-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="n">mcp_context</span>
</span></pre></div>


            <div class="docstring"><p>Create MCP-compatible context injection.</p>

<p>Formats context data for use with the Model Context Protocol (MCP),
including proper metadata and version information.</p>

<p>Args:
    context: Context dictionary to format</p>

<p>Returns:
    Dictionary formatted for MCP protocol</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>
