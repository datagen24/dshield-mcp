<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>src.dshield_client API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../src.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;src</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#DShieldClient">DShieldClient</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DShieldClient.__init__">DShieldClient</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.api_key">api_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.base_url">base_url</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.session">session</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.error_handler">error_handler</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.rate_limit_requests">rate_limit_requests</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.rate_limit_window">rate_limit_window</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.request_times">request_times</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.cache">cache</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.cache_ttl">cache_ttl</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.enable_caching">enable_caching</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.max_cache_size">max_cache_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.request_timeout">request_timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.enable_performance_logging">enable_performance_logging</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.headers">headers</a>
                        </li>
                        <li>
                                <a class="variable" href="#DShieldClient.batch_size">batch_size</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.get_circuit_breaker_status">get_circuit_breaker_status</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.connect">connect</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.close">close</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.get_ip_reputation">get_ip_reputation</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.get_ip_details">get_ip_details</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.get_top_attackers">get_top_attackers</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.get_attack_summary">get_attack_summary</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.enrich_ips_batch">enrich_ips_batch</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.health_check">health_check</a>
                        </li>
                        <li>
                                <a class="function" href="#DShieldClient.check_health">check_health</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../src.html">src</a><wbr>.dshield_client    </h1>

                        <div class="docstring"><p>DShield client for threat intelligence and IP reputation lookup.</p>

<p>This module provides a client for interacting with the DShield threat intelligence API.
It supports IP reputation lookups, attack summaries, batch enrichment, and detailed
IP information retrieval. The client handles authentication, rate limiting, caching,
and error handling for robust integration with DShield services.</p>

<p>Features:</p>

<ul>
<li>IP reputation and details lookup</li>
<li>Attack summary retrieval</li>
<li>Batch enrichment of IPs</li>
<li>Caching and rate limiting</li>
<li>Async context management</li>
</ul>

<p>Example:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>from <a href="">src.dshield_client</a> import DShieldClient
      async with DShieldClient() as client:
          ...     rep = await client.get_ip_reputation("8.8.8.8")
          ...     print(rep)</p>
    </blockquote>
  </blockquote>
</blockquote>
</div>

                        <input id="mod-dshield_client-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-dshield_client-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;DShield client for threat intelligence and IP reputation lookup.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">This module provides a client for interacting with the DShield threat intelligence API.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">It supports IP reputation lookups, attack summaries, batch enrichment, and detailed</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">IP information retrieval. The client handles authentication, rate limiting, caching,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">and error handling for robust integration with DShield services.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">Features:</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">- IP reputation and details lookup</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">- Attack summary retrieval</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">- Batch enrichment of IPs</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">- Caching and rate limiting</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">- Async context management</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">Example:</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    &gt;&gt;&gt; from src.dshield_client import DShieldClient</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    &gt;&gt;&gt; async with DShieldClient() as client:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    ...     rep = await client.get_ip_reputation(&quot;8.8.8.8&quot;)</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">    ...     print(rep)</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">structlog</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.config_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_config</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.mcp_error_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircuitBreaker</span><span class="p">,</span> <span class="n">MCPErrorHandler</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.op_secrets</span><span class="w"> </span><span class="kn">import</span> <span class="n">OnePasswordSecrets</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.user_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_config</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="c1"># Load environment variables</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DShieldClient</span><span class="p">:</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Client for interacting with DShield threat intelligence API.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    This class provides methods to query DShield for IP reputation, details,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    attack summaries, and batch enrichment. It manages authentication, rate</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    limiting, caching, and session lifecycle for efficient API usage.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    Attributes:</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">        api_key: API key for DShield authentication</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        base_url: Base URL for DShield API</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">        session: aiohttp.ClientSession for HTTP requests</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">        rate_limit_requests: Max requests per minute</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">        rate_limit_window: Time window for rate limiting (seconds)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">        request_times: List of request timestamps for rate limiting</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">        cache: In-memory cache for API responses</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">        cache_ttl: Time-to-live for cache entries (seconds)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">        enable_caching: Whether caching is enabled</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">        max_cache_size: Maximum cache size</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">        request_timeout: Timeout for API requests (seconds)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        enable_performance_logging: Whether to log performance metrics</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        headers: HTTP headers for API requests</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        batch_size: Maximum batch size for IP enrichment</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    Example:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">        &gt;&gt;&gt; async with DShieldClient() as client:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">        ...     rep = await client.get_ip_reputation(&quot;8.8.8.8&quot;)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">        ...     print(rep)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">:</span> <span class="n">MCPErrorHandler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the DShield client.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">        Loads configuration, resolves secrets, sets up rate limiting,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        caching, and prepares HTTP headers for API requests.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        Args:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">            error_handler: Optional MCPErrorHandler for structured error responses</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        Raises:</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">            RuntimeError: If configuration or secret resolution fails</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>            <span class="n">secrets_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>            <span class="n">dshield_api_key</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dshield_api_key&quot;</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>            <span class="n">dshield_api_url</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dshield_api_url&quot;</span><span class="p">,</span> <span class="s2">&quot;https://dshield.org/api&quot;</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="n">rate_limit</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate_limit_requests_per_minute&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="n">cache_ttl</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_ttl_seconds&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_ip_enrichment_batch_size&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load DShield config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="c1"># 1Password resolution if needed</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="n">op</span> <span class="o">=</span> <span class="n">OnePasswordSecrets</span><span class="p">()</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">resolve_environment_variable</span><span class="p">(</span><span class="n">dshield_api_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">dshield_api_key</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">dshield_api_url</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>        <span class="c1"># Error handling</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">error_handler</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="c1"># Circuit breaker for external service protection</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>                <span class="s2">&quot;dshield_api&quot;</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">circuit_breaker</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_requests</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rate_limit</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>        <span class="c1"># Cache for IP reputation data</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache_ttl</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="c1"># Load user configuration</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="n">user_config</span> <span class="o">=</span> <span class="n">get_user_config</span><span class="p">()</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_caching</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_caching&quot;</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_size</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;max_cache_size&quot;</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_timeout</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;request_timeout_seconds&quot;</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_performance_logging</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_performance_logging&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        <span class="c1"># Headers for API requests</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;DShield-MCP/1.0&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="p">}</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_circuit_breaker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if circuit breaker allows execution.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        Args:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">            operation: Name of the operation being performed</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">        Returns:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">            True if execution is allowed, False if circuit breaker is open</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                <span class="s2">&quot;Circuit breaker is open, blocking operation&quot;</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;dshield_api&quot;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_circuit_breaker_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record successful operation with circuit breaker.&quot;&quot;&quot;</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">on_success</span><span class="p">()</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_circuit_breaker_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record failed operation with circuit breaker.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        Args:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">            exception: The exception that occurred</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_circuit_breaker_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current status of the DShield API circuit breaker.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">        Returns:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">            Circuit breaker status dictionary or None if not enabled</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DShieldClient&quot;</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async context manager entry.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        Returns:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">            DShieldClient: The initialized client instance</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async context manager exit.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">        Closes the HTTP session on exit.</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize HTTP session.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        Creates an aiohttp.ClientSession for making API requests.</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        Logs session initialization.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DShield client session initialized&quot;</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close HTTP session.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        Closes the aiohttp.ClientSession and releases resources.</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        Logs session closure.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DShield client session closed&quot;</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get IP reputation from DShield.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        Looks up the reputation of a given IP address using the DShield API.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        Utilizes caching and rate limiting for efficiency.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        Args:</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">            ip_address: The IP address to look up</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        Returns:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">            Dictionary containing reputation data for the IP</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="c1"># Check cache first</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;reputation_</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning cached IP reputation&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="k">return</span> <span class="n">cached_data</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_ip_reputation&quot;</span><span class="p">):</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="c1"># DShield IP reputation endpoint</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield IP reputation&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                    <span class="n">reputation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ip_reputation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                    <span class="c1"># Cache the result</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">reputation_data</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                        <span class="s2">&quot;IP reputation retrieved successfully&quot;</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                        <span class="n">reputation_score</span><span class="o">=</span><span class="n">reputation_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">),</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                    <span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                    <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>                    <span class="c1"># IP not found in DShield database</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                    <span class="n">reputation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">reputation_data</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                    <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                    <span class="s2">&quot;DShield API returned non-200 status&quot;</span><span class="p">,</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                <span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                <span class="s2">&quot;HTTP error during IP reputation lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_external_service_error</span><span class="p">(</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>                        <span class="s2">&quot;DShield API&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HTTP error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>                    <span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>                <span class="p">}</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>                <span class="s2">&quot;Unexpected error during IP reputation lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>            <span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>                        <span class="sa">f</span><span class="s2">&quot;IP reputation lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>                    <span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>                <span class="p">}</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get detailed IP information from DShield.</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">        Retrieves detailed information for a given IP address from the DShield API.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">        Utilizes caching and rate limiting for efficiency.</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        Args:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">            ip_address: The IP address to look up</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">        Returns:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">            Dictionary containing detailed data for the IP</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="c1"># Check cache first</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;details_</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="k">return</span> <span class="n">cached_data</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_ip_details&quot;</span><span class="p">):</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            <span class="c1"># DShield IP details endpoint</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">/details&quot;</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield IP details&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>                    <span class="n">details_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ip_details</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>                    <span class="c1"># Cache the result</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">details_data</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                    <span class="k">return</span> <span class="n">details_data</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                    <span class="s2">&quot;DShield details API returned non-200 status&quot;</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>                    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during IP details lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                        <span class="sa">f</span><span class="s2">&quot;IP details lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>                    <span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>                <span class="p">}</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_top_attackers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get top attackers from DShield.&quot;&quot;&quot;</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_top_attackers&quot;</span><span class="p">):</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="c1"># DShield top attackers endpoint</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;topattackers/</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield top attackers&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_top_attackers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                    <span class="s2">&quot;DShield top attackers API returned non-200 status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                <span class="p">)</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during top attackers lookup&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                        <span class="sa">f</span><span class="s2">&quot;Top attackers lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                    <span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                <span class="p">}</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_attack_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get attack summary from DShield.&quot;&quot;&quot;</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_attack_summary&quot;</span><span class="p">):</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>            <span class="c1"># DShield attack summary endpoint</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;summary/</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield attack summary&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_attack_summary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                    <span class="s2">&quot;DShield summary API returned non-200 status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during attack summary lookup&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>                        <span class="sa">f</span><span class="s2">&quot;Attack summary lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>                    <span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                <span class="p">}</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">enrich_ips_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enrich multiple IP addresses with threat intelligence.&quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">ip_addresses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="c1"># Process batch concurrently</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ip_reputation</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">batch_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="c1"># Store results</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to enrich IP&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>                    <span class="n">results</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>                    <span class="n">results</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>            <span class="c1"># Small delay between batches</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">):</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check DShield API connectivity and authentication (placeholder).&quot;&quot;&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="c1"># TODO: Implement actual connectivity check</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_ip_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield IP reputation response.&quot;&quot;&quot;</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="n">reputation_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>            <span class="s2">&quot;reputation_score&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>            <span class="s2">&quot;threat_level&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>            <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>            <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>            <span class="s2">&quot;first_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>            <span class="s2">&quot;last_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>            <span class="s2">&quot;attack_types&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="p">}</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>            <span class="c1"># Extract reputation score</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>            <span class="k">if</span> <span class="s2">&quot;reputation&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;reputation&quot;</span><span class="p">])</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>                <span class="c1"># Determine threat level based on reputation score</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>                <span class="k">if</span> <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                    <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;threat_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;high&quot;</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>                <span class="k">elif</span> <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                    <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;threat_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;medium&quot;</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                    <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;threat_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;low&quot;</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="c1"># Extract geographic information</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="k">if</span> <span class="s2">&quot;country&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="c1"># Extract ASN information</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="k">if</span> <span class="s2">&quot;as&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;asn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;as&quot;</span><span class="p">]</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="c1"># Extract organization</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>            <span class="k">if</span> <span class="s2">&quot;org&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;organization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;org&quot;</span><span class="p">]</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>            <span class="c1"># Extract timestamps</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>            <span class="k">if</span> <span class="s2">&quot;firstseen&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;first_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;firstseen&quot;</span><span class="p">]</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>            <span class="k">if</span> <span class="s2">&quot;lastseen&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lastseen&quot;</span><span class="p">]</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>            <span class="c1"># Extract attack types</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>            <span class="k">if</span> <span class="s2">&quot;attacks&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;attack_types&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;attacks&quot;</span><span class="p">]</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>            <span class="c1"># Extract tags</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="k">if</span> <span class="s2">&quot;tags&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                <span class="s2">&quot;Failed to parse IP reputation data&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_ip_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield IP details response.&quot;&quot;&quot;</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="n">details_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="p">}</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>            <span class="c1"># Extract additional details from the response</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw_data&quot;</span><span class="p">]:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                    <span class="n">details_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse IP details data&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="k">return</span> <span class="n">details_data</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_top_attackers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield top attackers response.&quot;&quot;&quot;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="n">attackers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>            <span class="k">for</span> <span class="n">attacker</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                <span class="n">attacker_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                    <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">),</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>                    <span class="s2">&quot;attack_count&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;country&quot;</span><span class="p">),</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>                    <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;as&quot;</span><span class="p">),</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                    <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org&quot;</span><span class="p">),</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                <span class="p">}</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                <span class="n">attackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attacker_info</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse top attackers data&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>        <span class="k">return</span> <span class="n">attackers</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_attack_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield attack summary response.&quot;&quot;&quot;</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="s2">&quot;total_attacks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="s2">&quot;unique_attackers&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>            <span class="s2">&quot;top_countries&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>            <span class="s2">&quot;top_ports&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="p">}</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>            <span class="c1"># Extract summary statistics</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="k">if</span> <span class="s2">&quot;total&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;total_attacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            <span class="k">if</span> <span class="s2">&quot;unique&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;unique_attackers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">]</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>            <span class="k">if</span> <span class="s2">&quot;countries&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;top_countries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;countries&quot;</span><span class="p">]</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>            <span class="k">if</span> <span class="s2">&quot;ports&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;top_ports&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ports&quot;</span><span class="p">]</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse attack summary data&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="k">return</span> <span class="n">summary</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create default reputation data for IP.&quot;&quot;&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="s2">&quot;reputation_score&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>            <span class="s2">&quot;threat_level&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>            <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>            <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>            <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="s2">&quot;first_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="s2">&quot;last_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="s2">&quot;attack_types&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="p">}</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create default details data for IP.&quot;&quot;&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="p">}</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create default attack summary.&quot;&quot;&quot;</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="s2">&quot;total_attacks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>            <span class="s2">&quot;unique_attackers&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="s2">&quot;top_countries&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>            <span class="s2">&quot;top_ports&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>        <span class="p">}</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cached_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data from cache if not expired.&quot;&quot;&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="n">cached_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">cached_item</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>                <span class="k">return</span> <span class="n">cached_item</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="c1"># Remove expired cache entry</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache data with timestamp.&quot;&quot;&quot;</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>        <span class="p">}</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check DShield API connectivity and authentication.</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">        Returns:</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a><span class="sd">            bool: True if DShield API is healthy and accessible, False otherwise</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>            <span class="c1"># Check if we have valid configuration</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API base URL not configured&quot;</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DShield API key not configured - some endpoints may not work&quot;</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>                <span class="c1"># Continue with health check but note the limitation</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>            <span class="c1"># Try to connect and make a simple test request</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to create DShield client session&quot;</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="c1"># Make a simple health check request to test connectivity</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>            <span class="c1"># Use a simple endpoint that doesn&#39;t require authentication</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>                <span class="c1"># Try to access the base URL to test connectivity</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>                <span class="n">test_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">test_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>                        <span class="mi">200</span><span class="p">,</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>                        <span class="mi">401</span><span class="p">,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>                        <span class="mi">403</span><span class="p">,</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>                        <span class="mi">404</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>                    <span class="p">]:</span>  <span class="c1"># 404 means API is reachable but endpoint not found</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>                            <span class="s2">&quot;DShield API connectivity test passed&quot;</span><span class="p">,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>                            <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>                            <span class="n">url</span><span class="o">=</span><span class="n">test_url</span><span class="p">,</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>                        <span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>                        <span class="s2">&quot;DShield API returned unexpected status&quot;</span><span class="p">,</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                        <span class="n">url</span><span class="o">=</span><span class="n">test_url</span><span class="p">,</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                    <span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>            <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API connectivity test failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API connectivity test timed out&quot;</span><span class="p">)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API health check failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check and enforce rate limiting.&quot;&quot;&quot;</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>        <span class="c1"># Remove old request times outside the window</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="p">]</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="c1"># Check if we&#39;re at the rate limit</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_requests</span><span class="p">:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>            <span class="c1"># Calculate wait time</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="n">oldest_request</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>            <span class="n">wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span> <span class="o">-</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">oldest_request</span><span class="p">)</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>            <span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rate limit reached, waiting&quot;</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="n">wait_time</span><span class="p">)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>        <span class="c1"># Add current request time</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<input id="logger-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="logger-view-value"></label><span class="default_value">&lt;BoundLoggerLazyProxy(logger=None, wrapper_class=None, processors=None, context_class=None, initial_values={}, logger_factory_args=(&#39;<a href="">src.dshield_client</a>&#39;,))&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="DShieldClient">
                            <input id="DShieldClient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DShieldClient</span>:

                <label class="view-source-button" for="DShieldClient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient-44"><a href="#DShieldClient-44"><span class="linenos"> 44</span></a><span class="k">class</span><span class="w"> </span><span class="nc">DShieldClient</span><span class="p">:</span>
</span><span id="DShieldClient-45"><a href="#DShieldClient-45"><span class="linenos"> 45</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Client for interacting with DShield threat intelligence API.</span>
</span><span id="DShieldClient-46"><a href="#DShieldClient-46"><span class="linenos"> 46</span></a>
</span><span id="DShieldClient-47"><a href="#DShieldClient-47"><span class="linenos"> 47</span></a><span class="sd">    This class provides methods to query DShield for IP reputation, details,</span>
</span><span id="DShieldClient-48"><a href="#DShieldClient-48"><span class="linenos"> 48</span></a><span class="sd">    attack summaries, and batch enrichment. It manages authentication, rate</span>
</span><span id="DShieldClient-49"><a href="#DShieldClient-49"><span class="linenos"> 49</span></a><span class="sd">    limiting, caching, and session lifecycle for efficient API usage.</span>
</span><span id="DShieldClient-50"><a href="#DShieldClient-50"><span class="linenos"> 50</span></a>
</span><span id="DShieldClient-51"><a href="#DShieldClient-51"><span class="linenos"> 51</span></a><span class="sd">    Attributes:</span>
</span><span id="DShieldClient-52"><a href="#DShieldClient-52"><span class="linenos"> 52</span></a><span class="sd">        api_key: API key for DShield authentication</span>
</span><span id="DShieldClient-53"><a href="#DShieldClient-53"><span class="linenos"> 53</span></a><span class="sd">        base_url: Base URL for DShield API</span>
</span><span id="DShieldClient-54"><a href="#DShieldClient-54"><span class="linenos"> 54</span></a><span class="sd">        session: aiohttp.ClientSession for HTTP requests</span>
</span><span id="DShieldClient-55"><a href="#DShieldClient-55"><span class="linenos"> 55</span></a><span class="sd">        rate_limit_requests: Max requests per minute</span>
</span><span id="DShieldClient-56"><a href="#DShieldClient-56"><span class="linenos"> 56</span></a><span class="sd">        rate_limit_window: Time window for rate limiting (seconds)</span>
</span><span id="DShieldClient-57"><a href="#DShieldClient-57"><span class="linenos"> 57</span></a><span class="sd">        request_times: List of request timestamps for rate limiting</span>
</span><span id="DShieldClient-58"><a href="#DShieldClient-58"><span class="linenos"> 58</span></a><span class="sd">        cache: In-memory cache for API responses</span>
</span><span id="DShieldClient-59"><a href="#DShieldClient-59"><span class="linenos"> 59</span></a><span class="sd">        cache_ttl: Time-to-live for cache entries (seconds)</span>
</span><span id="DShieldClient-60"><a href="#DShieldClient-60"><span class="linenos"> 60</span></a><span class="sd">        enable_caching: Whether caching is enabled</span>
</span><span id="DShieldClient-61"><a href="#DShieldClient-61"><span class="linenos"> 61</span></a><span class="sd">        max_cache_size: Maximum cache size</span>
</span><span id="DShieldClient-62"><a href="#DShieldClient-62"><span class="linenos"> 62</span></a><span class="sd">        request_timeout: Timeout for API requests (seconds)</span>
</span><span id="DShieldClient-63"><a href="#DShieldClient-63"><span class="linenos"> 63</span></a><span class="sd">        enable_performance_logging: Whether to log performance metrics</span>
</span><span id="DShieldClient-64"><a href="#DShieldClient-64"><span class="linenos"> 64</span></a><span class="sd">        headers: HTTP headers for API requests</span>
</span><span id="DShieldClient-65"><a href="#DShieldClient-65"><span class="linenos"> 65</span></a><span class="sd">        batch_size: Maximum batch size for IP enrichment</span>
</span><span id="DShieldClient-66"><a href="#DShieldClient-66"><span class="linenos"> 66</span></a>
</span><span id="DShieldClient-67"><a href="#DShieldClient-67"><span class="linenos"> 67</span></a><span class="sd">    Example:</span>
</span><span id="DShieldClient-68"><a href="#DShieldClient-68"><span class="linenos"> 68</span></a><span class="sd">        &gt;&gt;&gt; async with DShieldClient() as client:</span>
</span><span id="DShieldClient-69"><a href="#DShieldClient-69"><span class="linenos"> 69</span></a><span class="sd">        ...     rep = await client.get_ip_reputation(&quot;8.8.8.8&quot;)</span>
</span><span id="DShieldClient-70"><a href="#DShieldClient-70"><span class="linenos"> 70</span></a><span class="sd">        ...     print(rep)</span>
</span><span id="DShieldClient-71"><a href="#DShieldClient-71"><span class="linenos"> 71</span></a>
</span><span id="DShieldClient-72"><a href="#DShieldClient-72"><span class="linenos"> 72</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DShieldClient-73"><a href="#DShieldClient-73"><span class="linenos"> 73</span></a>
</span><span id="DShieldClient-74"><a href="#DShieldClient-74"><span class="linenos"> 74</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">:</span> <span class="n">MCPErrorHandler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-75"><a href="#DShieldClient-75"><span class="linenos"> 75</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the DShield client.</span>
</span><span id="DShieldClient-76"><a href="#DShieldClient-76"><span class="linenos"> 76</span></a>
</span><span id="DShieldClient-77"><a href="#DShieldClient-77"><span class="linenos"> 77</span></a><span class="sd">        Loads configuration, resolves secrets, sets up rate limiting,</span>
</span><span id="DShieldClient-78"><a href="#DShieldClient-78"><span class="linenos"> 78</span></a><span class="sd">        caching, and prepares HTTP headers for API requests.</span>
</span><span id="DShieldClient-79"><a href="#DShieldClient-79"><span class="linenos"> 79</span></a>
</span><span id="DShieldClient-80"><a href="#DShieldClient-80"><span class="linenos"> 80</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient-81"><a href="#DShieldClient-81"><span class="linenos"> 81</span></a><span class="sd">            error_handler: Optional MCPErrorHandler for structured error responses</span>
</span><span id="DShieldClient-82"><a href="#DShieldClient-82"><span class="linenos"> 82</span></a>
</span><span id="DShieldClient-83"><a href="#DShieldClient-83"><span class="linenos"> 83</span></a><span class="sd">        Raises:</span>
</span><span id="DShieldClient-84"><a href="#DShieldClient-84"><span class="linenos"> 84</span></a><span class="sd">            RuntimeError: If configuration or secret resolution fails</span>
</span><span id="DShieldClient-85"><a href="#DShieldClient-85"><span class="linenos"> 85</span></a>
</span><span id="DShieldClient-86"><a href="#DShieldClient-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-87"><a href="#DShieldClient-87"><span class="linenos"> 87</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-88"><a href="#DShieldClient-88"><span class="linenos"> 88</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span><span id="DShieldClient-89"><a href="#DShieldClient-89"><span class="linenos"> 89</span></a>            <span class="n">secrets_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="DShieldClient-90"><a href="#DShieldClient-90"><span class="linenos"> 90</span></a>            <span class="n">dshield_api_key</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dshield_api_key&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-91"><a href="#DShieldClient-91"><span class="linenos"> 91</span></a>            <span class="n">dshield_api_url</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dshield_api_url&quot;</span><span class="p">,</span> <span class="s2">&quot;https://dshield.org/api&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-92"><a href="#DShieldClient-92"><span class="linenos"> 92</span></a>            <span class="n">rate_limit</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate_limit_requests_per_minute&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="DShieldClient-93"><a href="#DShieldClient-93"><span class="linenos"> 93</span></a>            <span class="n">cache_ttl</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_ttl_seconds&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
</span><span id="DShieldClient-94"><a href="#DShieldClient-94"><span class="linenos"> 94</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_ip_enrichment_batch_size&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DShieldClient-95"><a href="#DShieldClient-95"><span class="linenos"> 95</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-96"><a href="#DShieldClient-96"><span class="linenos"> 96</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load DShield config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="DShieldClient-97"><a href="#DShieldClient-97"><span class="linenos"> 97</span></a>
</span><span id="DShieldClient-98"><a href="#DShieldClient-98"><span class="linenos"> 98</span></a>        <span class="c1"># 1Password resolution if needed</span>
</span><span id="DShieldClient-99"><a href="#DShieldClient-99"><span class="linenos"> 99</span></a>        <span class="n">op</span> <span class="o">=</span> <span class="n">OnePasswordSecrets</span><span class="p">()</span>
</span><span id="DShieldClient-100"><a href="#DShieldClient-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">resolve_environment_variable</span><span class="p">(</span><span class="n">dshield_api_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">dshield_api_key</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="DShieldClient-101"><a href="#DShieldClient-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">dshield_api_url</span>
</span><span id="DShieldClient-102"><a href="#DShieldClient-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DShieldClient-103"><a href="#DShieldClient-103"><span class="linenos">103</span></a>
</span><span id="DShieldClient-104"><a href="#DShieldClient-104"><span class="linenos">104</span></a>        <span class="c1"># Error handling</span>
</span><span id="DShieldClient-105"><a href="#DShieldClient-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">error_handler</span>
</span><span id="DShieldClient-106"><a href="#DShieldClient-106"><span class="linenos">106</span></a>
</span><span id="DShieldClient-107"><a href="#DShieldClient-107"><span class="linenos">107</span></a>        <span class="c1"># Circuit breaker for external service protection</span>
</span><span id="DShieldClient-108"><a href="#DShieldClient-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-109"><a href="#DShieldClient-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
</span><span id="DShieldClient-110"><a href="#DShieldClient-110"><span class="linenos">110</span></a>                <span class="s2">&quot;dshield_api&quot;</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">circuit_breaker</span>
</span><span id="DShieldClient-111"><a href="#DShieldClient-111"><span class="linenos">111</span></a>            <span class="p">)</span>
</span><span id="DShieldClient-112"><a href="#DShieldClient-112"><span class="linenos">112</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DShieldClient-113"><a href="#DShieldClient-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DShieldClient-114"><a href="#DShieldClient-114"><span class="linenos">114</span></a>
</span><span id="DShieldClient-115"><a href="#DShieldClient-115"><span class="linenos">115</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient-116"><a href="#DShieldClient-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_requests</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rate_limit</span><span class="p">)</span>
</span><span id="DShieldClient-117"><a href="#DShieldClient-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>
</span><span id="DShieldClient-118"><a href="#DShieldClient-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DShieldClient-119"><a href="#DShieldClient-119"><span class="linenos">119</span></a>
</span><span id="DShieldClient-120"><a href="#DShieldClient-120"><span class="linenos">120</span></a>        <span class="c1"># Cache for IP reputation data</span>
</span><span id="DShieldClient-121"><a href="#DShieldClient-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="DShieldClient-122"><a href="#DShieldClient-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache_ttl</span><span class="p">)</span>
</span><span id="DShieldClient-123"><a href="#DShieldClient-123"><span class="linenos">123</span></a>
</span><span id="DShieldClient-124"><a href="#DShieldClient-124"><span class="linenos">124</span></a>        <span class="c1"># Load user configuration</span>
</span><span id="DShieldClient-125"><a href="#DShieldClient-125"><span class="linenos">125</span></a>        <span class="n">user_config</span> <span class="o">=</span> <span class="n">get_user_config</span><span class="p">()</span>
</span><span id="DShieldClient-126"><a href="#DShieldClient-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_caching</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_caching&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-127"><a href="#DShieldClient-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_size</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;max_cache_size&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-128"><a href="#DShieldClient-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_timeout</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;request_timeout_seconds&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-129"><a href="#DShieldClient-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_performance_logging</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span>
</span><span id="DShieldClient-130"><a href="#DShieldClient-130"><span class="linenos">130</span></a>            <span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_performance_logging&quot;</span>
</span><span id="DShieldClient-131"><a href="#DShieldClient-131"><span class="linenos">131</span></a>        <span class="p">)</span>
</span><span id="DShieldClient-132"><a href="#DShieldClient-132"><span class="linenos">132</span></a>
</span><span id="DShieldClient-133"><a href="#DShieldClient-133"><span class="linenos">133</span></a>        <span class="c1"># Headers for API requests</span>
</span><span id="DShieldClient-134"><a href="#DShieldClient-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient-135"><a href="#DShieldClient-135"><span class="linenos">135</span></a>            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;DShield-MCP/1.0&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-136"><a href="#DShieldClient-136"><span class="linenos">136</span></a>            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-137"><a href="#DShieldClient-137"><span class="linenos">137</span></a>            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-138"><a href="#DShieldClient-138"><span class="linenos">138</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-139"><a href="#DShieldClient-139"><span class="linenos">139</span></a>
</span><span id="DShieldClient-140"><a href="#DShieldClient-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span id="DShieldClient-141"><a href="#DShieldClient-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-142"><a href="#DShieldClient-142"><span class="linenos">142</span></a>
</span><span id="DShieldClient-143"><a href="#DShieldClient-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="DShieldClient-144"><a href="#DShieldClient-144"><span class="linenos">144</span></a>
</span><span id="DShieldClient-145"><a href="#DShieldClient-145"><span class="linenos">145</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_circuit_breaker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="DShieldClient-146"><a href="#DShieldClient-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if circuit breaker allows execution.</span>
</span><span id="DShieldClient-147"><a href="#DShieldClient-147"><span class="linenos">147</span></a>
</span><span id="DShieldClient-148"><a href="#DShieldClient-148"><span class="linenos">148</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient-149"><a href="#DShieldClient-149"><span class="linenos">149</span></a><span class="sd">            operation: Name of the operation being performed</span>
</span><span id="DShieldClient-150"><a href="#DShieldClient-150"><span class="linenos">150</span></a>
</span><span id="DShieldClient-151"><a href="#DShieldClient-151"><span class="linenos">151</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient-152"><a href="#DShieldClient-152"><span class="linenos">152</span></a><span class="sd">            True if execution is allowed, False if circuit breaker is open</span>
</span><span id="DShieldClient-153"><a href="#DShieldClient-153"><span class="linenos">153</span></a>
</span><span id="DShieldClient-154"><a href="#DShieldClient-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-155"><a href="#DShieldClient-155"><span class="linenos">155</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="DShieldClient-156"><a href="#DShieldClient-156"><span class="linenos">156</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="DShieldClient-157"><a href="#DShieldClient-157"><span class="linenos">157</span></a>
</span><span id="DShieldClient-158"><a href="#DShieldClient-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">can_execute</span><span class="p">():</span>
</span><span id="DShieldClient-159"><a href="#DShieldClient-159"><span class="linenos">159</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-160"><a href="#DShieldClient-160"><span class="linenos">160</span></a>                <span class="s2">&quot;Circuit breaker is open, blocking operation&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-161"><a href="#DShieldClient-161"><span class="linenos">161</span></a>                <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
</span><span id="DShieldClient-162"><a href="#DShieldClient-162"><span class="linenos">162</span></a>                <span class="n">service</span><span class="o">=</span><span class="s2">&quot;dshield_api&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-163"><a href="#DShieldClient-163"><span class="linenos">163</span></a>            <span class="p">)</span>
</span><span id="DShieldClient-164"><a href="#DShieldClient-164"><span class="linenos">164</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-165"><a href="#DShieldClient-165"><span class="linenos">165</span></a>
</span><span id="DShieldClient-166"><a href="#DShieldClient-166"><span class="linenos">166</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="DShieldClient-167"><a href="#DShieldClient-167"><span class="linenos">167</span></a>
</span><span id="DShieldClient-168"><a href="#DShieldClient-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_circuit_breaker_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-169"><a href="#DShieldClient-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record successful operation with circuit breaker.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-170"><a href="#DShieldClient-170"><span class="linenos">170</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="DShieldClient-171"><a href="#DShieldClient-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">on_success</span><span class="p">()</span>
</span><span id="DShieldClient-172"><a href="#DShieldClient-172"><span class="linenos">172</span></a>
</span><span id="DShieldClient-173"><a href="#DShieldClient-173"><span class="linenos">173</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_circuit_breaker_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-174"><a href="#DShieldClient-174"><span class="linenos">174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record failed operation with circuit breaker.</span>
</span><span id="DShieldClient-175"><a href="#DShieldClient-175"><span class="linenos">175</span></a>
</span><span id="DShieldClient-176"><a href="#DShieldClient-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient-177"><a href="#DShieldClient-177"><span class="linenos">177</span></a><span class="sd">            exception: The exception that occurred</span>
</span><span id="DShieldClient-178"><a href="#DShieldClient-178"><span class="linenos">178</span></a>
</span><span id="DShieldClient-179"><a href="#DShieldClient-179"><span class="linenos">179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-180"><a href="#DShieldClient-180"><span class="linenos">180</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="DShieldClient-181"><a href="#DShieldClient-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
</span><span id="DShieldClient-182"><a href="#DShieldClient-182"><span class="linenos">182</span></a>
</span><span id="DShieldClient-183"><a href="#DShieldClient-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_circuit_breaker_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-184"><a href="#DShieldClient-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current status of the DShield API circuit breaker.</span>
</span><span id="DShieldClient-185"><a href="#DShieldClient-185"><span class="linenos">185</span></a>
</span><span id="DShieldClient-186"><a href="#DShieldClient-186"><span class="linenos">186</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient-187"><a href="#DShieldClient-187"><span class="linenos">187</span></a><span class="sd">            Circuit breaker status dictionary or None if not enabled</span>
</span><span id="DShieldClient-188"><a href="#DShieldClient-188"><span class="linenos">188</span></a>
</span><span id="DShieldClient-189"><a href="#DShieldClient-189"><span class="linenos">189</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-190"><a href="#DShieldClient-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="DShieldClient-191"><a href="#DShieldClient-191"><span class="linenos">191</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="DShieldClient-192"><a href="#DShieldClient-192"><span class="linenos">192</span></a>
</span><span id="DShieldClient-193"><a href="#DShieldClient-193"><span class="linenos">193</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
</span><span id="DShieldClient-194"><a href="#DShieldClient-194"><span class="linenos">194</span></a>
</span><span id="DShieldClient-195"><a href="#DShieldClient-195"><span class="linenos">195</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DShieldClient&quot;</span><span class="p">:</span>
</span><span id="DShieldClient-196"><a href="#DShieldClient-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async context manager entry.</span>
</span><span id="DShieldClient-197"><a href="#DShieldClient-197"><span class="linenos">197</span></a>
</span><span id="DShieldClient-198"><a href="#DShieldClient-198"><span class="linenos">198</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient-199"><a href="#DShieldClient-199"><span class="linenos">199</span></a><span class="sd">            DShieldClient: The initialized client instance</span>
</span><span id="DShieldClient-200"><a href="#DShieldClient-200"><span class="linenos">200</span></a>
</span><span id="DShieldClient-201"><a href="#DShieldClient-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-202"><a href="#DShieldClient-202"><span class="linenos">202</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient-203"><a href="#DShieldClient-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="DShieldClient-204"><a href="#DShieldClient-204"><span class="linenos">204</span></a>
</span><span id="DShieldClient-205"><a href="#DShieldClient-205"><span class="linenos">205</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-206"><a href="#DShieldClient-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async context manager exit.</span>
</span><span id="DShieldClient-207"><a href="#DShieldClient-207"><span class="linenos">207</span></a>
</span><span id="DShieldClient-208"><a href="#DShieldClient-208"><span class="linenos">208</span></a><span class="sd">        Closes the HTTP session on exit.</span>
</span><span id="DShieldClient-209"><a href="#DShieldClient-209"><span class="linenos">209</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-210"><a href="#DShieldClient-210"><span class="linenos">210</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="DShieldClient-211"><a href="#DShieldClient-211"><span class="linenos">211</span></a>
</span><span id="DShieldClient-212"><a href="#DShieldClient-212"><span class="linenos">212</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-213"><a href="#DShieldClient-213"><span class="linenos">213</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize HTTP session.</span>
</span><span id="DShieldClient-214"><a href="#DShieldClient-214"><span class="linenos">214</span></a>
</span><span id="DShieldClient-215"><a href="#DShieldClient-215"><span class="linenos">215</span></a><span class="sd">        Creates an aiohttp.ClientSession for making API requests.</span>
</span><span id="DShieldClient-216"><a href="#DShieldClient-216"><span class="linenos">216</span></a><span class="sd">        Logs session initialization.</span>
</span><span id="DShieldClient-217"><a href="#DShieldClient-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-218"><a href="#DShieldClient-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="DShieldClient-219"><a href="#DShieldClient-219"><span class="linenos">219</span></a>            <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="DShieldClient-220"><a href="#DShieldClient-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
</span><span id="DShieldClient-221"><a href="#DShieldClient-221"><span class="linenos">221</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="DShieldClient-222"><a href="#DShieldClient-222"><span class="linenos">222</span></a>                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
</span><span id="DShieldClient-223"><a href="#DShieldClient-223"><span class="linenos">223</span></a>            <span class="p">)</span>
</span><span id="DShieldClient-224"><a href="#DShieldClient-224"><span class="linenos">224</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DShield client session initialized&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-225"><a href="#DShieldClient-225"><span class="linenos">225</span></a>
</span><span id="DShieldClient-226"><a href="#DShieldClient-226"><span class="linenos">226</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-227"><a href="#DShieldClient-227"><span class="linenos">227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close HTTP session.</span>
</span><span id="DShieldClient-228"><a href="#DShieldClient-228"><span class="linenos">228</span></a>
</span><span id="DShieldClient-229"><a href="#DShieldClient-229"><span class="linenos">229</span></a><span class="sd">        Closes the aiohttp.ClientSession and releases resources.</span>
</span><span id="DShieldClient-230"><a href="#DShieldClient-230"><span class="linenos">230</span></a><span class="sd">        Logs session closure.</span>
</span><span id="DShieldClient-231"><a href="#DShieldClient-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-232"><a href="#DShieldClient-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="DShieldClient-233"><a href="#DShieldClient-233"><span class="linenos">233</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="DShieldClient-234"><a href="#DShieldClient-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DShieldClient-235"><a href="#DShieldClient-235"><span class="linenos">235</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DShield client session closed&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-236"><a href="#DShieldClient-236"><span class="linenos">236</span></a>
</span><span id="DShieldClient-237"><a href="#DShieldClient-237"><span class="linenos">237</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-238"><a href="#DShieldClient-238"><span class="linenos">238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get IP reputation from DShield.</span>
</span><span id="DShieldClient-239"><a href="#DShieldClient-239"><span class="linenos">239</span></a>
</span><span id="DShieldClient-240"><a href="#DShieldClient-240"><span class="linenos">240</span></a><span class="sd">        Looks up the reputation of a given IP address using the DShield API.</span>
</span><span id="DShieldClient-241"><a href="#DShieldClient-241"><span class="linenos">241</span></a><span class="sd">        Utilizes caching and rate limiting for efficiency.</span>
</span><span id="DShieldClient-242"><a href="#DShieldClient-242"><span class="linenos">242</span></a>
</span><span id="DShieldClient-243"><a href="#DShieldClient-243"><span class="linenos">243</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient-244"><a href="#DShieldClient-244"><span class="linenos">244</span></a><span class="sd">            ip_address: The IP address to look up</span>
</span><span id="DShieldClient-245"><a href="#DShieldClient-245"><span class="linenos">245</span></a>
</span><span id="DShieldClient-246"><a href="#DShieldClient-246"><span class="linenos">246</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient-247"><a href="#DShieldClient-247"><span class="linenos">247</span></a><span class="sd">            Dictionary containing reputation data for the IP</span>
</span><span id="DShieldClient-248"><a href="#DShieldClient-248"><span class="linenos">248</span></a>
</span><span id="DShieldClient-249"><a href="#DShieldClient-249"><span class="linenos">249</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-250"><a href="#DShieldClient-250"><span class="linenos">250</span></a>        <span class="c1"># Check cache first</span>
</span><span id="DShieldClient-251"><a href="#DShieldClient-251"><span class="linenos">251</span></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;reputation_</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-252"><a href="#DShieldClient-252"><span class="linenos">252</span></a>        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span><span id="DShieldClient-253"><a href="#DShieldClient-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
</span><span id="DShieldClient-254"><a href="#DShieldClient-254"><span class="linenos">254</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning cached IP reputation&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-255"><a href="#DShieldClient-255"><span class="linenos">255</span></a>            <span class="k">return</span> <span class="n">cached_data</span>
</span><span id="DShieldClient-256"><a href="#DShieldClient-256"><span class="linenos">256</span></a>
</span><span id="DShieldClient-257"><a href="#DShieldClient-257"><span class="linenos">257</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient-258"><a href="#DShieldClient-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_ip_reputation&quot;</span><span class="p">):</span>
</span><span id="DShieldClient-259"><a href="#DShieldClient-259"><span class="linenos">259</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-260"><a href="#DShieldClient-260"><span class="linenos">260</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-261"><a href="#DShieldClient-261"><span class="linenos">261</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-262"><a href="#DShieldClient-262"><span class="linenos">262</span></a>
</span><span id="DShieldClient-263"><a href="#DShieldClient-263"><span class="linenos">263</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient-264"><a href="#DShieldClient-264"><span class="linenos">264</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient-265"><a href="#DShieldClient-265"><span class="linenos">265</span></a>
</span><span id="DShieldClient-266"><a href="#DShieldClient-266"><span class="linenos">266</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-267"><a href="#DShieldClient-267"><span class="linenos">267</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient-268"><a href="#DShieldClient-268"><span class="linenos">268</span></a>
</span><span id="DShieldClient-269"><a href="#DShieldClient-269"><span class="linenos">269</span></a>            <span class="c1"># DShield IP reputation endpoint</span>
</span><span id="DShieldClient-270"><a href="#DShieldClient-270"><span class="linenos">270</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-271"><a href="#DShieldClient-271"><span class="linenos">271</span></a>
</span><span id="DShieldClient-272"><a href="#DShieldClient-272"><span class="linenos">272</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield IP reputation&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-273"><a href="#DShieldClient-273"><span class="linenos">273</span></a>
</span><span id="DShieldClient-274"><a href="#DShieldClient-274"><span class="linenos">274</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient-275"><a href="#DShieldClient-275"><span class="linenos">275</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient-276"><a href="#DShieldClient-276"><span class="linenos">276</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient-277"><a href="#DShieldClient-277"><span class="linenos">277</span></a>                    <span class="n">reputation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ip_reputation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-278"><a href="#DShieldClient-278"><span class="linenos">278</span></a>
</span><span id="DShieldClient-279"><a href="#DShieldClient-279"><span class="linenos">279</span></a>                    <span class="c1"># Cache the result</span>
</span><span id="DShieldClient-280"><a href="#DShieldClient-280"><span class="linenos">280</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">reputation_data</span><span class="p">)</span>
</span><span id="DShieldClient-281"><a href="#DShieldClient-281"><span class="linenos">281</span></a>
</span><span id="DShieldClient-282"><a href="#DShieldClient-282"><span class="linenos">282</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="DShieldClient-283"><a href="#DShieldClient-283"><span class="linenos">283</span></a>                        <span class="s2">&quot;IP reputation retrieved successfully&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-284"><a href="#DShieldClient-284"><span class="linenos">284</span></a>                        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-285"><a href="#DShieldClient-285"><span class="linenos">285</span></a>                        <span class="n">reputation_score</span><span class="o">=</span><span class="n">reputation_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">),</span>
</span><span id="DShieldClient-286"><a href="#DShieldClient-286"><span class="linenos">286</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-287"><a href="#DShieldClient-287"><span class="linenos">287</span></a>
</span><span id="DShieldClient-288"><a href="#DShieldClient-288"><span class="linenos">288</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient-289"><a href="#DShieldClient-289"><span class="linenos">289</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient-290"><a href="#DShieldClient-290"><span class="linenos">290</span></a>
</span><span id="DShieldClient-291"><a href="#DShieldClient-291"><span class="linenos">291</span></a>                    <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="DShieldClient-292"><a href="#DShieldClient-292"><span class="linenos">292</span></a>
</span><span id="DShieldClient-293"><a href="#DShieldClient-293"><span class="linenos">293</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
</span><span id="DShieldClient-294"><a href="#DShieldClient-294"><span class="linenos">294</span></a>                    <span class="c1"># IP not found in DShield database</span>
</span><span id="DShieldClient-295"><a href="#DShieldClient-295"><span class="linenos">295</span></a>                    <span class="n">reputation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-296"><a href="#DShieldClient-296"><span class="linenos">296</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">reputation_data</span><span class="p">)</span>
</span><span id="DShieldClient-297"><a href="#DShieldClient-297"><span class="linenos">297</span></a>                    <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="DShieldClient-298"><a href="#DShieldClient-298"><span class="linenos">298</span></a>
</span><span id="DShieldClient-299"><a href="#DShieldClient-299"><span class="linenos">299</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-300"><a href="#DShieldClient-300"><span class="linenos">300</span></a>                    <span class="s2">&quot;DShield API returned non-200 status&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-301"><a href="#DShieldClient-301"><span class="linenos">301</span></a>                    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-302"><a href="#DShieldClient-302"><span class="linenos">302</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient-303"><a href="#DShieldClient-303"><span class="linenos">303</span></a>                <span class="p">)</span>
</span><span id="DShieldClient-304"><a href="#DShieldClient-304"><span class="linenos">304</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-305"><a href="#DShieldClient-305"><span class="linenos">305</span></a>
</span><span id="DShieldClient-306"><a href="#DShieldClient-306"><span class="linenos">306</span></a>        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-307"><a href="#DShieldClient-307"><span class="linenos">307</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="DShieldClient-308"><a href="#DShieldClient-308"><span class="linenos">308</span></a>                <span class="s2">&quot;HTTP error during IP reputation lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-309"><a href="#DShieldClient-309"><span class="linenos">309</span></a>            <span class="p">)</span>
</span><span id="DShieldClient-310"><a href="#DShieldClient-310"><span class="linenos">310</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient-311"><a href="#DShieldClient-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-312"><a href="#DShieldClient-312"><span class="linenos">312</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-313"><a href="#DShieldClient-313"><span class="linenos">313</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-314"><a href="#DShieldClient-314"><span class="linenos">314</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_external_service_error</span><span class="p">(</span>
</span><span id="DShieldClient-315"><a href="#DShieldClient-315"><span class="linenos">315</span></a>                        <span class="s2">&quot;DShield API&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HTTP error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-316"><a href="#DShieldClient-316"><span class="linenos">316</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-317"><a href="#DShieldClient-317"><span class="linenos">317</span></a>                <span class="p">}</span>
</span><span id="DShieldClient-318"><a href="#DShieldClient-318"><span class="linenos">318</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-319"><a href="#DShieldClient-319"><span class="linenos">319</span></a>
</span><span id="DShieldClient-320"><a href="#DShieldClient-320"><span class="linenos">320</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-321"><a href="#DShieldClient-321"><span class="linenos">321</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="DShieldClient-322"><a href="#DShieldClient-322"><span class="linenos">322</span></a>                <span class="s2">&quot;Unexpected error during IP reputation lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-323"><a href="#DShieldClient-323"><span class="linenos">323</span></a>            <span class="p">)</span>
</span><span id="DShieldClient-324"><a href="#DShieldClient-324"><span class="linenos">324</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient-325"><a href="#DShieldClient-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-326"><a href="#DShieldClient-326"><span class="linenos">326</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-327"><a href="#DShieldClient-327"><span class="linenos">327</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-328"><a href="#DShieldClient-328"><span class="linenos">328</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient-329"><a href="#DShieldClient-329"><span class="linenos">329</span></a>                        <span class="sa">f</span><span class="s2">&quot;IP reputation lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-330"><a href="#DShieldClient-330"><span class="linenos">330</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-331"><a href="#DShieldClient-331"><span class="linenos">331</span></a>                <span class="p">}</span>
</span><span id="DShieldClient-332"><a href="#DShieldClient-332"><span class="linenos">332</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-333"><a href="#DShieldClient-333"><span class="linenos">333</span></a>
</span><span id="DShieldClient-334"><a href="#DShieldClient-334"><span class="linenos">334</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-335"><a href="#DShieldClient-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get detailed IP information from DShield.</span>
</span><span id="DShieldClient-336"><a href="#DShieldClient-336"><span class="linenos">336</span></a>
</span><span id="DShieldClient-337"><a href="#DShieldClient-337"><span class="linenos">337</span></a><span class="sd">        Retrieves detailed information for a given IP address from the DShield API.</span>
</span><span id="DShieldClient-338"><a href="#DShieldClient-338"><span class="linenos">338</span></a><span class="sd">        Utilizes caching and rate limiting for efficiency.</span>
</span><span id="DShieldClient-339"><a href="#DShieldClient-339"><span class="linenos">339</span></a>
</span><span id="DShieldClient-340"><a href="#DShieldClient-340"><span class="linenos">340</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient-341"><a href="#DShieldClient-341"><span class="linenos">341</span></a><span class="sd">            ip_address: The IP address to look up</span>
</span><span id="DShieldClient-342"><a href="#DShieldClient-342"><span class="linenos">342</span></a>
</span><span id="DShieldClient-343"><a href="#DShieldClient-343"><span class="linenos">343</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient-344"><a href="#DShieldClient-344"><span class="linenos">344</span></a><span class="sd">            Dictionary containing detailed data for the IP</span>
</span><span id="DShieldClient-345"><a href="#DShieldClient-345"><span class="linenos">345</span></a>
</span><span id="DShieldClient-346"><a href="#DShieldClient-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-347"><a href="#DShieldClient-347"><span class="linenos">347</span></a>        <span class="c1"># Check cache first</span>
</span><span id="DShieldClient-348"><a href="#DShieldClient-348"><span class="linenos">348</span></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;details_</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-349"><a href="#DShieldClient-349"><span class="linenos">349</span></a>        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span><span id="DShieldClient-350"><a href="#DShieldClient-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
</span><span id="DShieldClient-351"><a href="#DShieldClient-351"><span class="linenos">351</span></a>            <span class="k">return</span> <span class="n">cached_data</span>
</span><span id="DShieldClient-352"><a href="#DShieldClient-352"><span class="linenos">352</span></a>
</span><span id="DShieldClient-353"><a href="#DShieldClient-353"><span class="linenos">353</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient-354"><a href="#DShieldClient-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_ip_details&quot;</span><span class="p">):</span>
</span><span id="DShieldClient-355"><a href="#DShieldClient-355"><span class="linenos">355</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-356"><a href="#DShieldClient-356"><span class="linenos">356</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-357"><a href="#DShieldClient-357"><span class="linenos">357</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-358"><a href="#DShieldClient-358"><span class="linenos">358</span></a>
</span><span id="DShieldClient-359"><a href="#DShieldClient-359"><span class="linenos">359</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient-360"><a href="#DShieldClient-360"><span class="linenos">360</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient-361"><a href="#DShieldClient-361"><span class="linenos">361</span></a>
</span><span id="DShieldClient-362"><a href="#DShieldClient-362"><span class="linenos">362</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-363"><a href="#DShieldClient-363"><span class="linenos">363</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient-364"><a href="#DShieldClient-364"><span class="linenos">364</span></a>
</span><span id="DShieldClient-365"><a href="#DShieldClient-365"><span class="linenos">365</span></a>            <span class="c1"># DShield IP details endpoint</span>
</span><span id="DShieldClient-366"><a href="#DShieldClient-366"><span class="linenos">366</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">/details&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-367"><a href="#DShieldClient-367"><span class="linenos">367</span></a>
</span><span id="DShieldClient-368"><a href="#DShieldClient-368"><span class="linenos">368</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield IP details&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-369"><a href="#DShieldClient-369"><span class="linenos">369</span></a>
</span><span id="DShieldClient-370"><a href="#DShieldClient-370"><span class="linenos">370</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient-371"><a href="#DShieldClient-371"><span class="linenos">371</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient-372"><a href="#DShieldClient-372"><span class="linenos">372</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient-373"><a href="#DShieldClient-373"><span class="linenos">373</span></a>                    <span class="n">details_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ip_details</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-374"><a href="#DShieldClient-374"><span class="linenos">374</span></a>
</span><span id="DShieldClient-375"><a href="#DShieldClient-375"><span class="linenos">375</span></a>                    <span class="c1"># Cache the result</span>
</span><span id="DShieldClient-376"><a href="#DShieldClient-376"><span class="linenos">376</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">details_data</span><span class="p">)</span>
</span><span id="DShieldClient-377"><a href="#DShieldClient-377"><span class="linenos">377</span></a>
</span><span id="DShieldClient-378"><a href="#DShieldClient-378"><span class="linenos">378</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient-379"><a href="#DShieldClient-379"><span class="linenos">379</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient-380"><a href="#DShieldClient-380"><span class="linenos">380</span></a>
</span><span id="DShieldClient-381"><a href="#DShieldClient-381"><span class="linenos">381</span></a>                    <span class="k">return</span> <span class="n">details_data</span>
</span><span id="DShieldClient-382"><a href="#DShieldClient-382"><span class="linenos">382</span></a>
</span><span id="DShieldClient-383"><a href="#DShieldClient-383"><span class="linenos">383</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-384"><a href="#DShieldClient-384"><span class="linenos">384</span></a>                    <span class="s2">&quot;DShield details API returned non-200 status&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-385"><a href="#DShieldClient-385"><span class="linenos">385</span></a>                    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-386"><a href="#DShieldClient-386"><span class="linenos">386</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient-387"><a href="#DShieldClient-387"><span class="linenos">387</span></a>                <span class="p">)</span>
</span><span id="DShieldClient-388"><a href="#DShieldClient-388"><span class="linenos">388</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-389"><a href="#DShieldClient-389"><span class="linenos">389</span></a>
</span><span id="DShieldClient-390"><a href="#DShieldClient-390"><span class="linenos">390</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-391"><a href="#DShieldClient-391"><span class="linenos">391</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during IP details lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-392"><a href="#DShieldClient-392"><span class="linenos">392</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient-393"><a href="#DShieldClient-393"><span class="linenos">393</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-394"><a href="#DShieldClient-394"><span class="linenos">394</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-395"><a href="#DShieldClient-395"><span class="linenos">395</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-396"><a href="#DShieldClient-396"><span class="linenos">396</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient-397"><a href="#DShieldClient-397"><span class="linenos">397</span></a>                        <span class="sa">f</span><span class="s2">&quot;IP details lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-398"><a href="#DShieldClient-398"><span class="linenos">398</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-399"><a href="#DShieldClient-399"><span class="linenos">399</span></a>                <span class="p">}</span>
</span><span id="DShieldClient-400"><a href="#DShieldClient-400"><span class="linenos">400</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient-401"><a href="#DShieldClient-401"><span class="linenos">401</span></a>
</span><span id="DShieldClient-402"><a href="#DShieldClient-402"><span class="linenos">402</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_top_attackers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="DShieldClient-403"><a href="#DShieldClient-403"><span class="linenos">403</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get top attackers from DShield.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-404"><a href="#DShieldClient-404"><span class="linenos">404</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient-405"><a href="#DShieldClient-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_top_attackers&quot;</span><span class="p">):</span>
</span><span id="DShieldClient-406"><a href="#DShieldClient-406"><span class="linenos">406</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-407"><a href="#DShieldClient-407"><span class="linenos">407</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-408"><a href="#DShieldClient-408"><span class="linenos">408</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="DShieldClient-409"><a href="#DShieldClient-409"><span class="linenos">409</span></a>
</span><span id="DShieldClient-410"><a href="#DShieldClient-410"><span class="linenos">410</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient-411"><a href="#DShieldClient-411"><span class="linenos">411</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient-412"><a href="#DShieldClient-412"><span class="linenos">412</span></a>
</span><span id="DShieldClient-413"><a href="#DShieldClient-413"><span class="linenos">413</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-414"><a href="#DShieldClient-414"><span class="linenos">414</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient-415"><a href="#DShieldClient-415"><span class="linenos">415</span></a>
</span><span id="DShieldClient-416"><a href="#DShieldClient-416"><span class="linenos">416</span></a>            <span class="c1"># DShield top attackers endpoint</span>
</span><span id="DShieldClient-417"><a href="#DShieldClient-417"><span class="linenos">417</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;topattackers/</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-418"><a href="#DShieldClient-418"><span class="linenos">418</span></a>
</span><span id="DShieldClient-419"><a href="#DShieldClient-419"><span class="linenos">419</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield top attackers&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="DShieldClient-420"><a href="#DShieldClient-420"><span class="linenos">420</span></a>
</span><span id="DShieldClient-421"><a href="#DShieldClient-421"><span class="linenos">421</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient-422"><a href="#DShieldClient-422"><span class="linenos">422</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient-423"><a href="#DShieldClient-423"><span class="linenos">423</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient-424"><a href="#DShieldClient-424"><span class="linenos">424</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient-425"><a href="#DShieldClient-425"><span class="linenos">425</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient-426"><a href="#DShieldClient-426"><span class="linenos">426</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_top_attackers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="DShieldClient-427"><a href="#DShieldClient-427"><span class="linenos">427</span></a>
</span><span id="DShieldClient-428"><a href="#DShieldClient-428"><span class="linenos">428</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-429"><a href="#DShieldClient-429"><span class="linenos">429</span></a>                    <span class="s2">&quot;DShield top attackers API returned non-200 status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span>
</span><span id="DShieldClient-430"><a href="#DShieldClient-430"><span class="linenos">430</span></a>                <span class="p">)</span>
</span><span id="DShieldClient-431"><a href="#DShieldClient-431"><span class="linenos">431</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="DShieldClient-432"><a href="#DShieldClient-432"><span class="linenos">432</span></a>
</span><span id="DShieldClient-433"><a href="#DShieldClient-433"><span class="linenos">433</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-434"><a href="#DShieldClient-434"><span class="linenos">434</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during top attackers lookup&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-435"><a href="#DShieldClient-435"><span class="linenos">435</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient-436"><a href="#DShieldClient-436"><span class="linenos">436</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-437"><a href="#DShieldClient-437"><span class="linenos">437</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-438"><a href="#DShieldClient-438"><span class="linenos">438</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-439"><a href="#DShieldClient-439"><span class="linenos">439</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient-440"><a href="#DShieldClient-440"><span class="linenos">440</span></a>                        <span class="sa">f</span><span class="s2">&quot;Top attackers lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-441"><a href="#DShieldClient-441"><span class="linenos">441</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-442"><a href="#DShieldClient-442"><span class="linenos">442</span></a>                <span class="p">}</span>
</span><span id="DShieldClient-443"><a href="#DShieldClient-443"><span class="linenos">443</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="DShieldClient-444"><a href="#DShieldClient-444"><span class="linenos">444</span></a>
</span><span id="DShieldClient-445"><a href="#DShieldClient-445"><span class="linenos">445</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_attack_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-446"><a href="#DShieldClient-446"><span class="linenos">446</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get attack summary from DShield.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-447"><a href="#DShieldClient-447"><span class="linenos">447</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient-448"><a href="#DShieldClient-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_attack_summary&quot;</span><span class="p">):</span>
</span><span id="DShieldClient-449"><a href="#DShieldClient-449"><span class="linenos">449</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-450"><a href="#DShieldClient-450"><span class="linenos">450</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-451"><a href="#DShieldClient-451"><span class="linenos">451</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="DShieldClient-452"><a href="#DShieldClient-452"><span class="linenos">452</span></a>
</span><span id="DShieldClient-453"><a href="#DShieldClient-453"><span class="linenos">453</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient-454"><a href="#DShieldClient-454"><span class="linenos">454</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient-455"><a href="#DShieldClient-455"><span class="linenos">455</span></a>
</span><span id="DShieldClient-456"><a href="#DShieldClient-456"><span class="linenos">456</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-457"><a href="#DShieldClient-457"><span class="linenos">457</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient-458"><a href="#DShieldClient-458"><span class="linenos">458</span></a>
</span><span id="DShieldClient-459"><a href="#DShieldClient-459"><span class="linenos">459</span></a>            <span class="c1"># DShield attack summary endpoint</span>
</span><span id="DShieldClient-460"><a href="#DShieldClient-460"><span class="linenos">460</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;summary/</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-461"><a href="#DShieldClient-461"><span class="linenos">461</span></a>
</span><span id="DShieldClient-462"><a href="#DShieldClient-462"><span class="linenos">462</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield attack summary&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="DShieldClient-463"><a href="#DShieldClient-463"><span class="linenos">463</span></a>
</span><span id="DShieldClient-464"><a href="#DShieldClient-464"><span class="linenos">464</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient-465"><a href="#DShieldClient-465"><span class="linenos">465</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient-466"><a href="#DShieldClient-466"><span class="linenos">466</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient-467"><a href="#DShieldClient-467"><span class="linenos">467</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient-468"><a href="#DShieldClient-468"><span class="linenos">468</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient-469"><a href="#DShieldClient-469"><span class="linenos">469</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_attack_summary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="DShieldClient-470"><a href="#DShieldClient-470"><span class="linenos">470</span></a>
</span><span id="DShieldClient-471"><a href="#DShieldClient-471"><span class="linenos">471</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-472"><a href="#DShieldClient-472"><span class="linenos">472</span></a>                    <span class="s2">&quot;DShield summary API returned non-200 status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span>
</span><span id="DShieldClient-473"><a href="#DShieldClient-473"><span class="linenos">473</span></a>                <span class="p">)</span>
</span><span id="DShieldClient-474"><a href="#DShieldClient-474"><span class="linenos">474</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="DShieldClient-475"><a href="#DShieldClient-475"><span class="linenos">475</span></a>
</span><span id="DShieldClient-476"><a href="#DShieldClient-476"><span class="linenos">476</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-477"><a href="#DShieldClient-477"><span class="linenos">477</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during attack summary lookup&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-478"><a href="#DShieldClient-478"><span class="linenos">478</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient-479"><a href="#DShieldClient-479"><span class="linenos">479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-480"><a href="#DShieldClient-480"><span class="linenos">480</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient-481"><a href="#DShieldClient-481"><span class="linenos">481</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-482"><a href="#DShieldClient-482"><span class="linenos">482</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient-483"><a href="#DShieldClient-483"><span class="linenos">483</span></a>                        <span class="sa">f</span><span class="s2">&quot;Attack summary lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient-484"><a href="#DShieldClient-484"><span class="linenos">484</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-485"><a href="#DShieldClient-485"><span class="linenos">485</span></a>                <span class="p">}</span>
</span><span id="DShieldClient-486"><a href="#DShieldClient-486"><span class="linenos">486</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="DShieldClient-487"><a href="#DShieldClient-487"><span class="linenos">487</span></a>
</span><span id="DShieldClient-488"><a href="#DShieldClient-488"><span class="linenos">488</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">enrich_ips_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="DShieldClient-489"><a href="#DShieldClient-489"><span class="linenos">489</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enrich multiple IP addresses with threat intelligence.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-490"><a href="#DShieldClient-490"><span class="linenos">490</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="DShieldClient-491"><a href="#DShieldClient-491"><span class="linenos">491</span></a>
</span><span id="DShieldClient-492"><a href="#DShieldClient-492"><span class="linenos">492</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
</span><span id="DShieldClient-493"><a href="#DShieldClient-493"><span class="linenos">493</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="DShieldClient-494"><a href="#DShieldClient-494"><span class="linenos">494</span></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">ip_addresses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
</span><span id="DShieldClient-495"><a href="#DShieldClient-495"><span class="linenos">495</span></a>
</span><span id="DShieldClient-496"><a href="#DShieldClient-496"><span class="linenos">496</span></a>            <span class="c1"># Process batch concurrently</span>
</span><span id="DShieldClient-497"><a href="#DShieldClient-497"><span class="linenos">497</span></a>            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ip_reputation</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span id="DShieldClient-498"><a href="#DShieldClient-498"><span class="linenos">498</span></a>            <span class="n">batch_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DShieldClient-499"><a href="#DShieldClient-499"><span class="linenos">499</span></a>
</span><span id="DShieldClient-500"><a href="#DShieldClient-500"><span class="linenos">500</span></a>            <span class="c1"># Store results</span>
</span><span id="DShieldClient-501"><a href="#DShieldClient-501"><span class="linenos">501</span></a>            <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="DShieldClient-502"><a href="#DShieldClient-502"><span class="linenos">502</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
</span><span id="DShieldClient-503"><a href="#DShieldClient-503"><span class="linenos">503</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to enrich IP&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span><span id="DShieldClient-504"><a href="#DShieldClient-504"><span class="linenos">504</span></a>                    <span class="n">results</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</span><span id="DShieldClient-505"><a href="#DShieldClient-505"><span class="linenos">505</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DShieldClient-506"><a href="#DShieldClient-506"><span class="linenos">506</span></a>                    <span class="n">results</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="DShieldClient-507"><a href="#DShieldClient-507"><span class="linenos">507</span></a>
</span><span id="DShieldClient-508"><a href="#DShieldClient-508"><span class="linenos">508</span></a>            <span class="c1"># Small delay between batches</span>
</span><span id="DShieldClient-509"><a href="#DShieldClient-509"><span class="linenos">509</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">):</span>
</span><span id="DShieldClient-510"><a href="#DShieldClient-510"><span class="linenos">510</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DShieldClient-511"><a href="#DShieldClient-511"><span class="linenos">511</span></a>
</span><span id="DShieldClient-512"><a href="#DShieldClient-512"><span class="linenos">512</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="DShieldClient-513"><a href="#DShieldClient-513"><span class="linenos">513</span></a>
</span><span id="DShieldClient-514"><a href="#DShieldClient-514"><span class="linenos">514</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="DShieldClient-515"><a href="#DShieldClient-515"><span class="linenos">515</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check DShield API connectivity and authentication (placeholder).&quot;&quot;&quot;</span>
</span><span id="DShieldClient-516"><a href="#DShieldClient-516"><span class="linenos">516</span></a>        <span class="c1"># TODO: Implement actual connectivity check</span>
</span><span id="DShieldClient-517"><a href="#DShieldClient-517"><span class="linenos">517</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="DShieldClient-518"><a href="#DShieldClient-518"><span class="linenos">518</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="DShieldClient-519"><a href="#DShieldClient-519"><span class="linenos">519</span></a>
</span><span id="DShieldClient-520"><a href="#DShieldClient-520"><span class="linenos">520</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_ip_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-521"><a href="#DShieldClient-521"><span class="linenos">521</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield IP reputation response.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-522"><a href="#DShieldClient-522"><span class="linenos">522</span></a>        <span class="n">reputation_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient-523"><a href="#DShieldClient-523"><span class="linenos">523</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-524"><a href="#DShieldClient-524"><span class="linenos">524</span></a>            <span class="s2">&quot;reputation_score&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-525"><a href="#DShieldClient-525"><span class="linenos">525</span></a>            <span class="s2">&quot;threat_level&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-526"><a href="#DShieldClient-526"><span class="linenos">526</span></a>            <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-527"><a href="#DShieldClient-527"><span class="linenos">527</span></a>            <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-528"><a href="#DShieldClient-528"><span class="linenos">528</span></a>            <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-529"><a href="#DShieldClient-529"><span class="linenos">529</span></a>            <span class="s2">&quot;first_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-530"><a href="#DShieldClient-530"><span class="linenos">530</span></a>            <span class="s2">&quot;last_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-531"><a href="#DShieldClient-531"><span class="linenos">531</span></a>            <span class="s2">&quot;attack_types&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-532"><a href="#DShieldClient-532"><span class="linenos">532</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-533"><a href="#DShieldClient-533"><span class="linenos">533</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="DShieldClient-534"><a href="#DShieldClient-534"><span class="linenos">534</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-535"><a href="#DShieldClient-535"><span class="linenos">535</span></a>
</span><span id="DShieldClient-536"><a href="#DShieldClient-536"><span class="linenos">536</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-537"><a href="#DShieldClient-537"><span class="linenos">537</span></a>            <span class="c1"># Extract reputation score</span>
</span><span id="DShieldClient-538"><a href="#DShieldClient-538"><span class="linenos">538</span></a>            <span class="k">if</span> <span class="s2">&quot;reputation&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-539"><a href="#DShieldClient-539"><span class="linenos">539</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;reputation&quot;</span><span class="p">])</span>
</span><span id="DShieldClient-540"><a href="#DShieldClient-540"><span class="linenos">540</span></a>
</span><span id="DShieldClient-541"><a href="#DShieldClient-541"><span class="linenos">541</span></a>                <span class="c1"># Determine threat level based on reputation score</span>
</span><span id="DShieldClient-542"><a href="#DShieldClient-542"><span class="linenos">542</span></a>                <span class="k">if</span> <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>
</span><span id="DShieldClient-543"><a href="#DShieldClient-543"><span class="linenos">543</span></a>                    <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;threat_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;high&quot;</span>
</span><span id="DShieldClient-544"><a href="#DShieldClient-544"><span class="linenos">544</span></a>                <span class="k">elif</span> <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="DShieldClient-545"><a href="#DShieldClient-545"><span class="linenos">545</span></a>                    <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;threat_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;medium&quot;</span>
</span><span id="DShieldClient-546"><a href="#DShieldClient-546"><span class="linenos">546</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DShieldClient-547"><a href="#DShieldClient-547"><span class="linenos">547</span></a>                    <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;threat_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;low&quot;</span>
</span><span id="DShieldClient-548"><a href="#DShieldClient-548"><span class="linenos">548</span></a>
</span><span id="DShieldClient-549"><a href="#DShieldClient-549"><span class="linenos">549</span></a>            <span class="c1"># Extract geographic information</span>
</span><span id="DShieldClient-550"><a href="#DShieldClient-550"><span class="linenos">550</span></a>            <span class="k">if</span> <span class="s2">&quot;country&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-551"><a href="#DShieldClient-551"><span class="linenos">551</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-552"><a href="#DShieldClient-552"><span class="linenos">552</span></a>
</span><span id="DShieldClient-553"><a href="#DShieldClient-553"><span class="linenos">553</span></a>            <span class="c1"># Extract ASN information</span>
</span><span id="DShieldClient-554"><a href="#DShieldClient-554"><span class="linenos">554</span></a>            <span class="k">if</span> <span class="s2">&quot;as&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-555"><a href="#DShieldClient-555"><span class="linenos">555</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;asn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;as&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-556"><a href="#DShieldClient-556"><span class="linenos">556</span></a>
</span><span id="DShieldClient-557"><a href="#DShieldClient-557"><span class="linenos">557</span></a>            <span class="c1"># Extract organization</span>
</span><span id="DShieldClient-558"><a href="#DShieldClient-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="s2">&quot;org&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-559"><a href="#DShieldClient-559"><span class="linenos">559</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;organization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;org&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-560"><a href="#DShieldClient-560"><span class="linenos">560</span></a>
</span><span id="DShieldClient-561"><a href="#DShieldClient-561"><span class="linenos">561</span></a>            <span class="c1"># Extract timestamps</span>
</span><span id="DShieldClient-562"><a href="#DShieldClient-562"><span class="linenos">562</span></a>            <span class="k">if</span> <span class="s2">&quot;firstseen&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-563"><a href="#DShieldClient-563"><span class="linenos">563</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;first_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;firstseen&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-564"><a href="#DShieldClient-564"><span class="linenos">564</span></a>
</span><span id="DShieldClient-565"><a href="#DShieldClient-565"><span class="linenos">565</span></a>            <span class="k">if</span> <span class="s2">&quot;lastseen&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-566"><a href="#DShieldClient-566"><span class="linenos">566</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lastseen&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-567"><a href="#DShieldClient-567"><span class="linenos">567</span></a>
</span><span id="DShieldClient-568"><a href="#DShieldClient-568"><span class="linenos">568</span></a>            <span class="c1"># Extract attack types</span>
</span><span id="DShieldClient-569"><a href="#DShieldClient-569"><span class="linenos">569</span></a>            <span class="k">if</span> <span class="s2">&quot;attacks&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-570"><a href="#DShieldClient-570"><span class="linenos">570</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;attack_types&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;attacks&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-571"><a href="#DShieldClient-571"><span class="linenos">571</span></a>
</span><span id="DShieldClient-572"><a href="#DShieldClient-572"><span class="linenos">572</span></a>            <span class="c1"># Extract tags</span>
</span><span id="DShieldClient-573"><a href="#DShieldClient-573"><span class="linenos">573</span></a>            <span class="k">if</span> <span class="s2">&quot;tags&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-574"><a href="#DShieldClient-574"><span class="linenos">574</span></a>                <span class="n">reputation_data</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-575"><a href="#DShieldClient-575"><span class="linenos">575</span></a>
</span><span id="DShieldClient-576"><a href="#DShieldClient-576"><span class="linenos">576</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-577"><a href="#DShieldClient-577"><span class="linenos">577</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-578"><a href="#DShieldClient-578"><span class="linenos">578</span></a>                <span class="s2">&quot;Failed to parse IP reputation data&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient-579"><a href="#DShieldClient-579"><span class="linenos">579</span></a>            <span class="p">)</span>
</span><span id="DShieldClient-580"><a href="#DShieldClient-580"><span class="linenos">580</span></a>
</span><span id="DShieldClient-581"><a href="#DShieldClient-581"><span class="linenos">581</span></a>        <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="DShieldClient-582"><a href="#DShieldClient-582"><span class="linenos">582</span></a>
</span><span id="DShieldClient-583"><a href="#DShieldClient-583"><span class="linenos">583</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_ip_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-584"><a href="#DShieldClient-584"><span class="linenos">584</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield IP details response.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-585"><a href="#DShieldClient-585"><span class="linenos">585</span></a>        <span class="n">details_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient-586"><a href="#DShieldClient-586"><span class="linenos">586</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-587"><a href="#DShieldClient-587"><span class="linenos">587</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="DShieldClient-588"><a href="#DShieldClient-588"><span class="linenos">588</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-589"><a href="#DShieldClient-589"><span class="linenos">589</span></a>
</span><span id="DShieldClient-590"><a href="#DShieldClient-590"><span class="linenos">590</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-591"><a href="#DShieldClient-591"><span class="linenos">591</span></a>            <span class="c1"># Extract additional details from the response</span>
</span><span id="DShieldClient-592"><a href="#DShieldClient-592"><span class="linenos">592</span></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="DShieldClient-593"><a href="#DShieldClient-593"><span class="linenos">593</span></a>                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw_data&quot;</span><span class="p">]:</span>
</span><span id="DShieldClient-594"><a href="#DShieldClient-594"><span class="linenos">594</span></a>                    <span class="n">details_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="DShieldClient-595"><a href="#DShieldClient-595"><span class="linenos">595</span></a>
</span><span id="DShieldClient-596"><a href="#DShieldClient-596"><span class="linenos">596</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-597"><a href="#DShieldClient-597"><span class="linenos">597</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse IP details data&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-598"><a href="#DShieldClient-598"><span class="linenos">598</span></a>
</span><span id="DShieldClient-599"><a href="#DShieldClient-599"><span class="linenos">599</span></a>        <span class="k">return</span> <span class="n">details_data</span>
</span><span id="DShieldClient-600"><a href="#DShieldClient-600"><span class="linenos">600</span></a>
</span><span id="DShieldClient-601"><a href="#DShieldClient-601"><span class="linenos">601</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_top_attackers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="DShieldClient-602"><a href="#DShieldClient-602"><span class="linenos">602</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield top attackers response.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-603"><a href="#DShieldClient-603"><span class="linenos">603</span></a>        <span class="n">attackers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DShieldClient-604"><a href="#DShieldClient-604"><span class="linenos">604</span></a>
</span><span id="DShieldClient-605"><a href="#DShieldClient-605"><span class="linenos">605</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-606"><a href="#DShieldClient-606"><span class="linenos">606</span></a>            <span class="k">for</span> <span class="n">attacker</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-607"><a href="#DShieldClient-607"><span class="linenos">607</span></a>                <span class="n">attacker_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient-608"><a href="#DShieldClient-608"><span class="linenos">608</span></a>                    <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">),</span>
</span><span id="DShieldClient-609"><a href="#DShieldClient-609"><span class="linenos">609</span></a>                    <span class="s2">&quot;attack_count&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="DShieldClient-610"><a href="#DShieldClient-610"><span class="linenos">610</span></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;country&quot;</span><span class="p">),</span>
</span><span id="DShieldClient-611"><a href="#DShieldClient-611"><span class="linenos">611</span></a>                    <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;as&quot;</span><span class="p">),</span>
</span><span id="DShieldClient-612"><a href="#DShieldClient-612"><span class="linenos">612</span></a>                    <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="n">attacker</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org&quot;</span><span class="p">),</span>
</span><span id="DShieldClient-613"><a href="#DShieldClient-613"><span class="linenos">613</span></a>                <span class="p">}</span>
</span><span id="DShieldClient-614"><a href="#DShieldClient-614"><span class="linenos">614</span></a>                <span class="n">attackers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attacker_info</span><span class="p">)</span>
</span><span id="DShieldClient-615"><a href="#DShieldClient-615"><span class="linenos">615</span></a>
</span><span id="DShieldClient-616"><a href="#DShieldClient-616"><span class="linenos">616</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-617"><a href="#DShieldClient-617"><span class="linenos">617</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse top attackers data&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-618"><a href="#DShieldClient-618"><span class="linenos">618</span></a>
</span><span id="DShieldClient-619"><a href="#DShieldClient-619"><span class="linenos">619</span></a>        <span class="k">return</span> <span class="n">attackers</span>
</span><span id="DShieldClient-620"><a href="#DShieldClient-620"><span class="linenos">620</span></a>
</span><span id="DShieldClient-621"><a href="#DShieldClient-621"><span class="linenos">621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_attack_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-622"><a href="#DShieldClient-622"><span class="linenos">622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse DShield attack summary response.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-623"><a href="#DShieldClient-623"><span class="linenos">623</span></a>        <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient-624"><a href="#DShieldClient-624"><span class="linenos">624</span></a>            <span class="s2">&quot;total_attacks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="DShieldClient-625"><a href="#DShieldClient-625"><span class="linenos">625</span></a>            <span class="s2">&quot;unique_attackers&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="DShieldClient-626"><a href="#DShieldClient-626"><span class="linenos">626</span></a>            <span class="s2">&quot;top_countries&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-627"><a href="#DShieldClient-627"><span class="linenos">627</span></a>            <span class="s2">&quot;top_ports&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-628"><a href="#DShieldClient-628"><span class="linenos">628</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="DShieldClient-629"><a href="#DShieldClient-629"><span class="linenos">629</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-630"><a href="#DShieldClient-630"><span class="linenos">630</span></a>
</span><span id="DShieldClient-631"><a href="#DShieldClient-631"><span class="linenos">631</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-632"><a href="#DShieldClient-632"><span class="linenos">632</span></a>            <span class="c1"># Extract summary statistics</span>
</span><span id="DShieldClient-633"><a href="#DShieldClient-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="s2">&quot;total&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-634"><a href="#DShieldClient-634"><span class="linenos">634</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;total_attacks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-635"><a href="#DShieldClient-635"><span class="linenos">635</span></a>
</span><span id="DShieldClient-636"><a href="#DShieldClient-636"><span class="linenos">636</span></a>            <span class="k">if</span> <span class="s2">&quot;unique&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-637"><a href="#DShieldClient-637"><span class="linenos">637</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;unique_attackers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-638"><a href="#DShieldClient-638"><span class="linenos">638</span></a>
</span><span id="DShieldClient-639"><a href="#DShieldClient-639"><span class="linenos">639</span></a>            <span class="k">if</span> <span class="s2">&quot;countries&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-640"><a href="#DShieldClient-640"><span class="linenos">640</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;top_countries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;countries&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-641"><a href="#DShieldClient-641"><span class="linenos">641</span></a>
</span><span id="DShieldClient-642"><a href="#DShieldClient-642"><span class="linenos">642</span></a>            <span class="k">if</span> <span class="s2">&quot;ports&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="DShieldClient-643"><a href="#DShieldClient-643"><span class="linenos">643</span></a>                <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;top_ports&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ports&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-644"><a href="#DShieldClient-644"><span class="linenos">644</span></a>
</span><span id="DShieldClient-645"><a href="#DShieldClient-645"><span class="linenos">645</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-646"><a href="#DShieldClient-646"><span class="linenos">646</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse attack summary data&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-647"><a href="#DShieldClient-647"><span class="linenos">647</span></a>
</span><span id="DShieldClient-648"><a href="#DShieldClient-648"><span class="linenos">648</span></a>        <span class="k">return</span> <span class="n">summary</span>
</span><span id="DShieldClient-649"><a href="#DShieldClient-649"><span class="linenos">649</span></a>
</span><span id="DShieldClient-650"><a href="#DShieldClient-650"><span class="linenos">650</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-651"><a href="#DShieldClient-651"><span class="linenos">651</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create default reputation data for IP.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-652"><a href="#DShieldClient-652"><span class="linenos">652</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-653"><a href="#DShieldClient-653"><span class="linenos">653</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-654"><a href="#DShieldClient-654"><span class="linenos">654</span></a>            <span class="s2">&quot;reputation_score&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-655"><a href="#DShieldClient-655"><span class="linenos">655</span></a>            <span class="s2">&quot;threat_level&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-656"><a href="#DShieldClient-656"><span class="linenos">656</span></a>            <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-657"><a href="#DShieldClient-657"><span class="linenos">657</span></a>            <span class="s2">&quot;asn&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-658"><a href="#DShieldClient-658"><span class="linenos">658</span></a>            <span class="s2">&quot;organization&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-659"><a href="#DShieldClient-659"><span class="linenos">659</span></a>            <span class="s2">&quot;first_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-660"><a href="#DShieldClient-660"><span class="linenos">660</span></a>            <span class="s2">&quot;last_seen&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DShieldClient-661"><a href="#DShieldClient-661"><span class="linenos">661</span></a>            <span class="s2">&quot;attack_types&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-662"><a href="#DShieldClient-662"><span class="linenos">662</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-663"><a href="#DShieldClient-663"><span class="linenos">663</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="DShieldClient-664"><a href="#DShieldClient-664"><span class="linenos">664</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-665"><a href="#DShieldClient-665"><span class="linenos">665</span></a>
</span><span id="DShieldClient-666"><a href="#DShieldClient-666"><span class="linenos">666</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-667"><a href="#DShieldClient-667"><span class="linenos">667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create default details data for IP.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-668"><a href="#DShieldClient-668"><span class="linenos">668</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-669"><a href="#DShieldClient-669"><span class="linenos">669</span></a>            <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient-670"><a href="#DShieldClient-670"><span class="linenos">670</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="DShieldClient-671"><a href="#DShieldClient-671"><span class="linenos">671</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-672"><a href="#DShieldClient-672"><span class="linenos">672</span></a>
</span><span id="DShieldClient-673"><a href="#DShieldClient-673"><span class="linenos">673</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_default_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient-674"><a href="#DShieldClient-674"><span class="linenos">674</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create default attack summary.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-675"><a href="#DShieldClient-675"><span class="linenos">675</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient-676"><a href="#DShieldClient-676"><span class="linenos">676</span></a>            <span class="s2">&quot;total_attacks&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="DShieldClient-677"><a href="#DShieldClient-677"><span class="linenos">677</span></a>            <span class="s2">&quot;unique_attackers&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="DShieldClient-678"><a href="#DShieldClient-678"><span class="linenos">678</span></a>            <span class="s2">&quot;top_countries&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-679"><a href="#DShieldClient-679"><span class="linenos">679</span></a>            <span class="s2">&quot;top_ports&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="DShieldClient-680"><a href="#DShieldClient-680"><span class="linenos">680</span></a>            <span class="s2">&quot;raw_data&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span id="DShieldClient-681"><a href="#DShieldClient-681"><span class="linenos">681</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-682"><a href="#DShieldClient-682"><span class="linenos">682</span></a>
</span><span id="DShieldClient-683"><a href="#DShieldClient-683"><span class="linenos">683</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cached_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient-684"><a href="#DShieldClient-684"><span class="linenos">684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data from cache if not expired.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-685"><a href="#DShieldClient-685"><span class="linenos">685</span></a>        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
</span><span id="DShieldClient-686"><a href="#DShieldClient-686"><span class="linenos">686</span></a>            <span class="n">cached_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
</span><span id="DShieldClient-687"><a href="#DShieldClient-687"><span class="linenos">687</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">cached_item</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span><span class="p">:</span>
</span><span id="DShieldClient-688"><a href="#DShieldClient-688"><span class="linenos">688</span></a>                <span class="k">return</span> <span class="n">cached_item</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
</span><span id="DShieldClient-689"><a href="#DShieldClient-689"><span class="linenos">689</span></a>            <span class="c1"># Remove expired cache entry</span>
</span><span id="DShieldClient-690"><a href="#DShieldClient-690"><span class="linenos">690</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
</span><span id="DShieldClient-691"><a href="#DShieldClient-691"><span class="linenos">691</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="DShieldClient-692"><a href="#DShieldClient-692"><span class="linenos">692</span></a>
</span><span id="DShieldClient-693"><a href="#DShieldClient-693"><span class="linenos">693</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
</span><span id="DShieldClient-694"><a href="#DShieldClient-694"><span class="linenos">694</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache data with timestamp.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-695"><a href="#DShieldClient-695"><span class="linenos">695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient-696"><a href="#DShieldClient-696"><span class="linenos">696</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
</span><span id="DShieldClient-697"><a href="#DShieldClient-697"><span class="linenos">697</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span><span id="DShieldClient-698"><a href="#DShieldClient-698"><span class="linenos">698</span></a>        <span class="p">}</span>
</span><span id="DShieldClient-699"><a href="#DShieldClient-699"><span class="linenos">699</span></a>
</span><span id="DShieldClient-700"><a href="#DShieldClient-700"><span class="linenos">700</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="DShieldClient-701"><a href="#DShieldClient-701"><span class="linenos">701</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check DShield API connectivity and authentication.</span>
</span><span id="DShieldClient-702"><a href="#DShieldClient-702"><span class="linenos">702</span></a>
</span><span id="DShieldClient-703"><a href="#DShieldClient-703"><span class="linenos">703</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient-704"><a href="#DShieldClient-704"><span class="linenos">704</span></a><span class="sd">            bool: True if DShield API is healthy and accessible, False otherwise</span>
</span><span id="DShieldClient-705"><a href="#DShieldClient-705"><span class="linenos">705</span></a>
</span><span id="DShieldClient-706"><a href="#DShieldClient-706"><span class="linenos">706</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient-707"><a href="#DShieldClient-707"><span class="linenos">707</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-708"><a href="#DShieldClient-708"><span class="linenos">708</span></a>            <span class="c1"># Check if we have valid configuration</span>
</span><span id="DShieldClient-709"><a href="#DShieldClient-709"><span class="linenos">709</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
</span><span id="DShieldClient-710"><a href="#DShieldClient-710"><span class="linenos">710</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API base URL not configured&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-711"><a href="#DShieldClient-711"><span class="linenos">711</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-712"><a href="#DShieldClient-712"><span class="linenos">712</span></a>
</span><span id="DShieldClient-713"><a href="#DShieldClient-713"><span class="linenos">713</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span id="DShieldClient-714"><a href="#DShieldClient-714"><span class="linenos">714</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DShield API key not configured - some endpoints may not work&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-715"><a href="#DShieldClient-715"><span class="linenos">715</span></a>                <span class="c1"># Continue with health check but note the limitation</span>
</span><span id="DShieldClient-716"><a href="#DShieldClient-716"><span class="linenos">716</span></a>
</span><span id="DShieldClient-717"><a href="#DShieldClient-717"><span class="linenos">717</span></a>            <span class="c1"># Try to connect and make a simple test request</span>
</span><span id="DShieldClient-718"><a href="#DShieldClient-718"><span class="linenos">718</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient-719"><a href="#DShieldClient-719"><span class="linenos">719</span></a>
</span><span id="DShieldClient-720"><a href="#DShieldClient-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="DShieldClient-721"><a href="#DShieldClient-721"><span class="linenos">721</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to create DShield client session&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-722"><a href="#DShieldClient-722"><span class="linenos">722</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-723"><a href="#DShieldClient-723"><span class="linenos">723</span></a>
</span><span id="DShieldClient-724"><a href="#DShieldClient-724"><span class="linenos">724</span></a>            <span class="c1"># Make a simple health check request to test connectivity</span>
</span><span id="DShieldClient-725"><a href="#DShieldClient-725"><span class="linenos">725</span></a>            <span class="c1"># Use a simple endpoint that doesn&#39;t require authentication</span>
</span><span id="DShieldClient-726"><a href="#DShieldClient-726"><span class="linenos">726</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient-727"><a href="#DShieldClient-727"><span class="linenos">727</span></a>                <span class="c1"># Try to access the base URL to test connectivity</span>
</span><span id="DShieldClient-728"><a href="#DShieldClient-728"><span class="linenos">728</span></a>                <span class="n">test_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
</span><span id="DShieldClient-729"><a href="#DShieldClient-729"><span class="linenos">729</span></a>
</span><span id="DShieldClient-730"><a href="#DShieldClient-730"><span class="linenos">730</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">test_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient-731"><a href="#DShieldClient-731"><span class="linenos">731</span></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="DShieldClient-732"><a href="#DShieldClient-732"><span class="linenos">732</span></a>                        <span class="mi">200</span><span class="p">,</span>
</span><span id="DShieldClient-733"><a href="#DShieldClient-733"><span class="linenos">733</span></a>                        <span class="mi">401</span><span class="p">,</span>
</span><span id="DShieldClient-734"><a href="#DShieldClient-734"><span class="linenos">734</span></a>                        <span class="mi">403</span><span class="p">,</span>
</span><span id="DShieldClient-735"><a href="#DShieldClient-735"><span class="linenos">735</span></a>                        <span class="mi">404</span><span class="p">,</span>
</span><span id="DShieldClient-736"><a href="#DShieldClient-736"><span class="linenos">736</span></a>                    <span class="p">]:</span>  <span class="c1"># 404 means API is reachable but endpoint not found</span>
</span><span id="DShieldClient-737"><a href="#DShieldClient-737"><span class="linenos">737</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="DShieldClient-738"><a href="#DShieldClient-738"><span class="linenos">738</span></a>                            <span class="s2">&quot;DShield API connectivity test passed&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-739"><a href="#DShieldClient-739"><span class="linenos">739</span></a>                            <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient-740"><a href="#DShieldClient-740"><span class="linenos">740</span></a>                            <span class="n">url</span><span class="o">=</span><span class="n">test_url</span><span class="p">,</span>
</span><span id="DShieldClient-741"><a href="#DShieldClient-741"><span class="linenos">741</span></a>                        <span class="p">)</span>
</span><span id="DShieldClient-742"><a href="#DShieldClient-742"><span class="linenos">742</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="DShieldClient-743"><a href="#DShieldClient-743"><span class="linenos">743</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient-744"><a href="#DShieldClient-744"><span class="linenos">744</span></a>                        <span class="s2">&quot;DShield API returned unexpected status&quot;</span><span class="p">,</span>
</span><span id="DShieldClient-745"><a href="#DShieldClient-745"><span class="linenos">745</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient-746"><a href="#DShieldClient-746"><span class="linenos">746</span></a>                        <span class="n">url</span><span class="o">=</span><span class="n">test_url</span><span class="p">,</span>
</span><span id="DShieldClient-747"><a href="#DShieldClient-747"><span class="linenos">747</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient-748"><a href="#DShieldClient-748"><span class="linenos">748</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-749"><a href="#DShieldClient-749"><span class="linenos">749</span></a>
</span><span id="DShieldClient-750"><a href="#DShieldClient-750"><span class="linenos">750</span></a>            <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-751"><a href="#DShieldClient-751"><span class="linenos">751</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API connectivity test failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-752"><a href="#DShieldClient-752"><span class="linenos">752</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-753"><a href="#DShieldClient-753"><span class="linenos">753</span></a>            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
</span><span id="DShieldClient-754"><a href="#DShieldClient-754"><span class="linenos">754</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API connectivity test timed out&quot;</span><span class="p">)</span>
</span><span id="DShieldClient-755"><a href="#DShieldClient-755"><span class="linenos">755</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-756"><a href="#DShieldClient-756"><span class="linenos">756</span></a>
</span><span id="DShieldClient-757"><a href="#DShieldClient-757"><span class="linenos">757</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient-758"><a href="#DShieldClient-758"><span class="linenos">758</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API health check failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient-759"><a href="#DShieldClient-759"><span class="linenos">759</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient-760"><a href="#DShieldClient-760"><span class="linenos">760</span></a>
</span><span id="DShieldClient-761"><a href="#DShieldClient-761"><span class="linenos">761</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DShieldClient-762"><a href="#DShieldClient-762"><span class="linenos">762</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check and enforce rate limiting.&quot;&quot;&quot;</span>
</span><span id="DShieldClient-763"><a href="#DShieldClient-763"><span class="linenos">763</span></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="DShieldClient-764"><a href="#DShieldClient-764"><span class="linenos">764</span></a>
</span><span id="DShieldClient-765"><a href="#DShieldClient-765"><span class="linenos">765</span></a>        <span class="c1"># Remove old request times outside the window</span>
</span><span id="DShieldClient-766"><a href="#DShieldClient-766"><span class="linenos">766</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="DShieldClient-767"><a href="#DShieldClient-767"><span class="linenos">767</span></a>            <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span> <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span>
</span><span id="DShieldClient-768"><a href="#DShieldClient-768"><span class="linenos">768</span></a>        <span class="p">]</span>
</span><span id="DShieldClient-769"><a href="#DShieldClient-769"><span class="linenos">769</span></a>
</span><span id="DShieldClient-770"><a href="#DShieldClient-770"><span class="linenos">770</span></a>        <span class="c1"># Check if we&#39;re at the rate limit</span>
</span><span id="DShieldClient-771"><a href="#DShieldClient-771"><span class="linenos">771</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_requests</span><span class="p">:</span>
</span><span id="DShieldClient-772"><a href="#DShieldClient-772"><span class="linenos">772</span></a>            <span class="c1"># Calculate wait time</span>
</span><span id="DShieldClient-773"><a href="#DShieldClient-773"><span class="linenos">773</span></a>            <span class="n">oldest_request</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">)</span>
</span><span id="DShieldClient-774"><a href="#DShieldClient-774"><span class="linenos">774</span></a>            <span class="n">wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span> <span class="o">-</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">oldest_request</span><span class="p">)</span>
</span><span id="DShieldClient-775"><a href="#DShieldClient-775"><span class="linenos">775</span></a>
</span><span id="DShieldClient-776"><a href="#DShieldClient-776"><span class="linenos">776</span></a>            <span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DShieldClient-777"><a href="#DShieldClient-777"><span class="linenos">777</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rate limit reached, waiting&quot;</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="n">wait_time</span><span class="p">)</span>
</span><span id="DShieldClient-778"><a href="#DShieldClient-778"><span class="linenos">778</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
</span><span id="DShieldClient-779"><a href="#DShieldClient-779"><span class="linenos">779</span></a>
</span><span id="DShieldClient-780"><a href="#DShieldClient-780"><span class="linenos">780</span></a>        <span class="c1"># Add current request time</span>
</span><span id="DShieldClient-781"><a href="#DShieldClient-781"><span class="linenos">781</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Client for interacting with DShield threat intelligence API.</p>

<p>This class provides methods to query DShield for IP reputation, details,
attack summaries, and batch enrichment. It manages authentication, rate
limiting, caching, and session lifecycle for efficient API usage.</p>

<p>Attributes:
    api_key: API key for DShield authentication
    base_url: Base URL for DShield API
    session: aiohttp.ClientSession for HTTP requests
    rate_limit_requests: Max requests per minute
    rate_limit_window: Time window for rate limiting (seconds)
    request_times: List of request timestamps for rate limiting
    cache: In-memory cache for API responses
    cache_ttl: Time-to-live for cache entries (seconds)
    enable_caching: Whether caching is enabled
    max_cache_size: Maximum cache size
    request_timeout: Timeout for API requests (seconds)
    enable_performance_logging: Whether to log performance metrics
    headers: HTTP headers for API requests
    batch_size: Maximum batch size for IP enrichment</p>

<p>Example:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>async with DShieldClient() as client:
          ...     rep = await client.get_ip_reputation("8.8.8.8")
          ...     print(rep)</p>
    </blockquote>
  </blockquote>
</blockquote>
</div>


                            <div id="DShieldClient.__init__" class="classattr">
                                        <input id="DShieldClient.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DShieldClient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">error_handler</span><span class="p">:</span> <span class="n"><a href="mcp_error_handler.html#MCPErrorHandler">src.mcp_error_handler.MCPErrorHandler</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="DShieldClient.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.__init__-74"><a href="#DShieldClient.__init__-74"><span class="linenos"> 74</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">:</span> <span class="n">MCPErrorHandler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient.__init__-75"><a href="#DShieldClient.__init__-75"><span class="linenos"> 75</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the DShield client.</span>
</span><span id="DShieldClient.__init__-76"><a href="#DShieldClient.__init__-76"><span class="linenos"> 76</span></a>
</span><span id="DShieldClient.__init__-77"><a href="#DShieldClient.__init__-77"><span class="linenos"> 77</span></a><span class="sd">        Loads configuration, resolves secrets, sets up rate limiting,</span>
</span><span id="DShieldClient.__init__-78"><a href="#DShieldClient.__init__-78"><span class="linenos"> 78</span></a><span class="sd">        caching, and prepares HTTP headers for API requests.</span>
</span><span id="DShieldClient.__init__-79"><a href="#DShieldClient.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="DShieldClient.__init__-80"><a href="#DShieldClient.__init__-80"><span class="linenos"> 80</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient.__init__-81"><a href="#DShieldClient.__init__-81"><span class="linenos"> 81</span></a><span class="sd">            error_handler: Optional MCPErrorHandler for structured error responses</span>
</span><span id="DShieldClient.__init__-82"><a href="#DShieldClient.__init__-82"><span class="linenos"> 82</span></a>
</span><span id="DShieldClient.__init__-83"><a href="#DShieldClient.__init__-83"><span class="linenos"> 83</span></a><span class="sd">        Raises:</span>
</span><span id="DShieldClient.__init__-84"><a href="#DShieldClient.__init__-84"><span class="linenos"> 84</span></a><span class="sd">            RuntimeError: If configuration or secret resolution fails</span>
</span><span id="DShieldClient.__init__-85"><a href="#DShieldClient.__init__-85"><span class="linenos"> 85</span></a>
</span><span id="DShieldClient.__init__-86"><a href="#DShieldClient.__init__-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.__init__-87"><a href="#DShieldClient.__init__-87"><span class="linenos"> 87</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.__init__-88"><a href="#DShieldClient.__init__-88"><span class="linenos"> 88</span></a>            <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
</span><span id="DShieldClient.__init__-89"><a href="#DShieldClient.__init__-89"><span class="linenos"> 89</span></a>            <span class="n">secrets_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="DShieldClient.__init__-90"><a href="#DShieldClient.__init__-90"><span class="linenos"> 90</span></a>            <span class="n">dshield_api_key</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dshield_api_key&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-91"><a href="#DShieldClient.__init__-91"><span class="linenos"> 91</span></a>            <span class="n">dshield_api_url</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dshield_api_url&quot;</span><span class="p">,</span> <span class="s2">&quot;https://dshield.org/api&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-92"><a href="#DShieldClient.__init__-92"><span class="linenos"> 92</span></a>            <span class="n">rate_limit</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rate_limit_requests_per_minute&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-93"><a href="#DShieldClient.__init__-93"><span class="linenos"> 93</span></a>            <span class="n">cache_ttl</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_ttl_seconds&quot;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-94"><a href="#DShieldClient.__init__-94"><span class="linenos"> 94</span></a>            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">secrets_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_ip_enrichment_batch_size&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-95"><a href="#DShieldClient.__init__-95"><span class="linenos"> 95</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.__init__-96"><a href="#DShieldClient.__init__-96"><span class="linenos"> 96</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load DShield config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</span><span id="DShieldClient.__init__-97"><a href="#DShieldClient.__init__-97"><span class="linenos"> 97</span></a>
</span><span id="DShieldClient.__init__-98"><a href="#DShieldClient.__init__-98"><span class="linenos"> 98</span></a>        <span class="c1"># 1Password resolution if needed</span>
</span><span id="DShieldClient.__init__-99"><a href="#DShieldClient.__init__-99"><span class="linenos"> 99</span></a>        <span class="n">op</span> <span class="o">=</span> <span class="n">OnePasswordSecrets</span><span class="p">()</span>
</span><span id="DShieldClient.__init__-100"><a href="#DShieldClient.__init__-100"><span class="linenos">100</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">resolve_environment_variable</span><span class="p">(</span><span class="n">dshield_api_key</span><span class="p">)</span> <span class="k">if</span> <span class="n">dshield_api_key</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="DShieldClient.__init__-101"><a href="#DShieldClient.__init__-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">dshield_api_url</span>
</span><span id="DShieldClient.__init__-102"><a href="#DShieldClient.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DShieldClient.__init__-103"><a href="#DShieldClient.__init__-103"><span class="linenos">103</span></a>
</span><span id="DShieldClient.__init__-104"><a href="#DShieldClient.__init__-104"><span class="linenos">104</span></a>        <span class="c1"># Error handling</span>
</span><span id="DShieldClient.__init__-105"><a href="#DShieldClient.__init__-105"><span class="linenos">105</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">error_handler</span>
</span><span id="DShieldClient.__init__-106"><a href="#DShieldClient.__init__-106"><span class="linenos">106</span></a>
</span><span id="DShieldClient.__init__-107"><a href="#DShieldClient.__init__-107"><span class="linenos">107</span></a>        <span class="c1"># Circuit breaker for external service protection</span>
</span><span id="DShieldClient.__init__-108"><a href="#DShieldClient.__init__-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.__init__-109"><a href="#DShieldClient.__init__-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
</span><span id="DShieldClient.__init__-110"><a href="#DShieldClient.__init__-110"><span class="linenos">110</span></a>                <span class="s2">&quot;dshield_api&quot;</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">circuit_breaker</span>
</span><span id="DShieldClient.__init__-111"><a href="#DShieldClient.__init__-111"><span class="linenos">111</span></a>            <span class="p">)</span>
</span><span id="DShieldClient.__init__-112"><a href="#DShieldClient.__init__-112"><span class="linenos">112</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DShieldClient.__init__-113"><a href="#DShieldClient.__init__-113"><span class="linenos">113</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DShieldClient.__init__-114"><a href="#DShieldClient.__init__-114"><span class="linenos">114</span></a>
</span><span id="DShieldClient.__init__-115"><a href="#DShieldClient.__init__-115"><span class="linenos">115</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient.__init__-116"><a href="#DShieldClient.__init__-116"><span class="linenos">116</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_requests</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rate_limit</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-117"><a href="#DShieldClient.__init__-117"><span class="linenos">117</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rate_limit_window</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds</span>
</span><span id="DShieldClient.__init__-118"><a href="#DShieldClient.__init__-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_times</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DShieldClient.__init__-119"><a href="#DShieldClient.__init__-119"><span class="linenos">119</span></a>
</span><span id="DShieldClient.__init__-120"><a href="#DShieldClient.__init__-120"><span class="linenos">120</span></a>        <span class="c1"># Cache for IP reputation data</span>
</span><span id="DShieldClient.__init__-121"><a href="#DShieldClient.__init__-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="DShieldClient.__init__-122"><a href="#DShieldClient.__init__-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cache_ttl</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-123"><a href="#DShieldClient.__init__-123"><span class="linenos">123</span></a>
</span><span id="DShieldClient.__init__-124"><a href="#DShieldClient.__init__-124"><span class="linenos">124</span></a>        <span class="c1"># Load user configuration</span>
</span><span id="DShieldClient.__init__-125"><a href="#DShieldClient.__init__-125"><span class="linenos">125</span></a>        <span class="n">user_config</span> <span class="o">=</span> <span class="n">get_user_config</span><span class="p">()</span>
</span><span id="DShieldClient.__init__-126"><a href="#DShieldClient.__init__-126"><span class="linenos">126</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_caching</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_caching&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-127"><a href="#DShieldClient.__init__-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_size</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;max_cache_size&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-128"><a href="#DShieldClient.__init__-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_timeout</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span><span class="s2">&quot;performance&quot;</span><span class="p">,</span> <span class="s2">&quot;request_timeout_seconds&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.__init__-129"><a href="#DShieldClient.__init__-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_performance_logging</span> <span class="o">=</span> <span class="n">user_config</span><span class="o">.</span><span class="n">get_setting</span><span class="p">(</span>
</span><span id="DShieldClient.__init__-130"><a href="#DShieldClient.__init__-130"><span class="linenos">130</span></a>            <span class="s2">&quot;logging&quot;</span><span class="p">,</span> <span class="s2">&quot;enable_performance_logging&quot;</span>
</span><span id="DShieldClient.__init__-131"><a href="#DShieldClient.__init__-131"><span class="linenos">131</span></a>        <span class="p">)</span>
</span><span id="DShieldClient.__init__-132"><a href="#DShieldClient.__init__-132"><span class="linenos">132</span></a>
</span><span id="DShieldClient.__init__-133"><a href="#DShieldClient.__init__-133"><span class="linenos">133</span></a>        <span class="c1"># Headers for API requests</span>
</span><span id="DShieldClient.__init__-134"><a href="#DShieldClient.__init__-134"><span class="linenos">134</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DShieldClient.__init__-135"><a href="#DShieldClient.__init__-135"><span class="linenos">135</span></a>            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;DShield-MCP/1.0&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.__init__-136"><a href="#DShieldClient.__init__-136"><span class="linenos">136</span></a>            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.__init__-137"><a href="#DShieldClient.__init__-137"><span class="linenos">137</span></a>            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.__init__-138"><a href="#DShieldClient.__init__-138"><span class="linenos">138</span></a>        <span class="p">}</span>
</span><span id="DShieldClient.__init__-139"><a href="#DShieldClient.__init__-139"><span class="linenos">139</span></a>
</span><span id="DShieldClient.__init__-140"><a href="#DShieldClient.__init__-140"><span class="linenos">140</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span id="DShieldClient.__init__-141"><a href="#DShieldClient.__init__-141"><span class="linenos">141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.__init__-142"><a href="#DShieldClient.__init__-142"><span class="linenos">142</span></a>
</span><span id="DShieldClient.__init__-143"><a href="#DShieldClient.__init__-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the DShield client.</p>

<p>Loads configuration, resolves secrets, sets up rate limiting,
caching, and prepares HTTP headers for API requests.</p>

<p>Args:
    error_handler: Optional MCPErrorHandler for structured error responses</p>

<p>Raises:
    RuntimeError: If configuration or secret resolution fails</p>
</div>


                            </div>
                            <div id="DShieldClient.api_key" class="classattr">
                                <div class="attr variable">
            <span class="name">api_key</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.api_key"></a>
    
    

                            </div>
                            <div id="DShieldClient.base_url" class="classattr">
                                <div class="attr variable">
            <span class="name">base_url</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.base_url"></a>
    
    

                            </div>
                            <div id="DShieldClient.session" class="classattr">
                                <div class="attr variable">
            <span class="name">session</span><span class="annotation">: aiohttp.client.ClientSession | None</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.session"></a>
    
    

                            </div>
                            <div id="DShieldClient.error_handler" class="classattr">
                                <div class="attr variable">
            <span class="name">error_handler</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.error_handler"></a>
    
    

                            </div>
                            <div id="DShieldClient.rate_limit_requests" class="classattr">
                                <div class="attr variable">
            <span class="name">rate_limit_requests</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.rate_limit_requests"></a>
    
    

                            </div>
                            <div id="DShieldClient.rate_limit_window" class="classattr">
                                <div class="attr variable">
            <span class="name">rate_limit_window</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.rate_limit_window"></a>
    
    

                            </div>
                            <div id="DShieldClient.request_times" class="classattr">
                                <div class="attr variable">
            <span class="name">request_times</span><span class="annotation">: list[float]</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.request_times"></a>
    
    

                            </div>
                            <div id="DShieldClient.cache" class="classattr">
                                <div class="attr variable">
            <span class="name">cache</span><span class="annotation">: dict[str, dict[str, typing.Any]]</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.cache"></a>
    
    

                            </div>
                            <div id="DShieldClient.cache_ttl" class="classattr">
                                <div class="attr variable">
            <span class="name">cache_ttl</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.cache_ttl"></a>
    
    

                            </div>
                            <div id="DShieldClient.enable_caching" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_caching</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.enable_caching"></a>
    
    

                            </div>
                            <div id="DShieldClient.max_cache_size" class="classattr">
                                <div class="attr variable">
            <span class="name">max_cache_size</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.max_cache_size"></a>
    
    

                            </div>
                            <div id="DShieldClient.request_timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">request_timeout</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.request_timeout"></a>
    
    

                            </div>
                            <div id="DShieldClient.enable_performance_logging" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_performance_logging</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.enable_performance_logging"></a>
    
    

                            </div>
                            <div id="DShieldClient.headers" class="classattr">
                                <div class="attr variable">
            <span class="name">headers</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.headers"></a>
    
    

                            </div>
                            <div id="DShieldClient.batch_size" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_size</span>

        
    </div>
    <a class="headerlink" href="#DShieldClient.batch_size"></a>
    
    

                            </div>
                            <div id="DShieldClient.get_circuit_breaker_status" class="classattr">
                                        <input id="DShieldClient.get_circuit_breaker_status-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_circuit_breaker_status</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.get_circuit_breaker_status-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.get_circuit_breaker_status"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.get_circuit_breaker_status-183"><a href="#DShieldClient.get_circuit_breaker_status-183"><span class="linenos">183</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_circuit_breaker_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient.get_circuit_breaker_status-184"><a href="#DShieldClient.get_circuit_breaker_status-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the current status of the DShield API circuit breaker.</span>
</span><span id="DShieldClient.get_circuit_breaker_status-185"><a href="#DShieldClient.get_circuit_breaker_status-185"><span class="linenos">185</span></a>
</span><span id="DShieldClient.get_circuit_breaker_status-186"><a href="#DShieldClient.get_circuit_breaker_status-186"><span class="linenos">186</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient.get_circuit_breaker_status-187"><a href="#DShieldClient.get_circuit_breaker_status-187"><span class="linenos">187</span></a><span class="sd">            Circuit breaker status dictionary or None if not enabled</span>
</span><span id="DShieldClient.get_circuit_breaker_status-188"><a href="#DShieldClient.get_circuit_breaker_status-188"><span class="linenos">188</span></a>
</span><span id="DShieldClient.get_circuit_breaker_status-189"><a href="#DShieldClient.get_circuit_breaker_status-189"><span class="linenos">189</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.get_circuit_breaker_status-190"><a href="#DShieldClient.get_circuit_breaker_status-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="p">:</span>
</span><span id="DShieldClient.get_circuit_breaker_status-191"><a href="#DShieldClient.get_circuit_breaker_status-191"><span class="linenos">191</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="DShieldClient.get_circuit_breaker_status-192"><a href="#DShieldClient.get_circuit_breaker_status-192"><span class="linenos">192</span></a>
</span><span id="DShieldClient.get_circuit_breaker_status-193"><a href="#DShieldClient.get_circuit_breaker_status-193"><span class="linenos">193</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get the current status of the DShield API circuit breaker.</p>

<p>Returns:
    Circuit breaker status dictionary or None if not enabled</p>
</div>


                            </div>
                            <div id="DShieldClient.connect" class="classattr">
                                        <input id="DShieldClient.connect-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">connect</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.connect-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.connect"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.connect-212"><a href="#DShieldClient.connect-212"><span class="linenos">212</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient.connect-213"><a href="#DShieldClient.connect-213"><span class="linenos">213</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize HTTP session.</span>
</span><span id="DShieldClient.connect-214"><a href="#DShieldClient.connect-214"><span class="linenos">214</span></a>
</span><span id="DShieldClient.connect-215"><a href="#DShieldClient.connect-215"><span class="linenos">215</span></a><span class="sd">        Creates an aiohttp.ClientSession for making API requests.</span>
</span><span id="DShieldClient.connect-216"><a href="#DShieldClient.connect-216"><span class="linenos">216</span></a><span class="sd">        Logs session initialization.</span>
</span><span id="DShieldClient.connect-217"><a href="#DShieldClient.connect-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.connect-218"><a href="#DShieldClient.connect-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="DShieldClient.connect-219"><a href="#DShieldClient.connect-219"><span class="linenos">219</span></a>            <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="DShieldClient.connect-220"><a href="#DShieldClient.connect-220"><span class="linenos">220</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
</span><span id="DShieldClient.connect-221"><a href="#DShieldClient.connect-221"><span class="linenos">221</span></a>                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
</span><span id="DShieldClient.connect-222"><a href="#DShieldClient.connect-222"><span class="linenos">222</span></a>                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
</span><span id="DShieldClient.connect-223"><a href="#DShieldClient.connect-223"><span class="linenos">223</span></a>            <span class="p">)</span>
</span><span id="DShieldClient.connect-224"><a href="#DShieldClient.connect-224"><span class="linenos">224</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DShield client session initialized&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize HTTP session.</p>

<p>Creates an aiohttp.ClientSession for making API requests.
Logs session initialization.</p>
</div>


                            </div>
                            <div id="DShieldClient.close" class="classattr">
                                        <input id="DShieldClient.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.close-226"><a href="#DShieldClient.close-226"><span class="linenos">226</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DShieldClient.close-227"><a href="#DShieldClient.close-227"><span class="linenos">227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close HTTP session.</span>
</span><span id="DShieldClient.close-228"><a href="#DShieldClient.close-228"><span class="linenos">228</span></a>
</span><span id="DShieldClient.close-229"><a href="#DShieldClient.close-229"><span class="linenos">229</span></a><span class="sd">        Closes the aiohttp.ClientSession and releases resources.</span>
</span><span id="DShieldClient.close-230"><a href="#DShieldClient.close-230"><span class="linenos">230</span></a><span class="sd">        Logs session closure.</span>
</span><span id="DShieldClient.close-231"><a href="#DShieldClient.close-231"><span class="linenos">231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.close-232"><a href="#DShieldClient.close-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="DShieldClient.close-233"><a href="#DShieldClient.close-233"><span class="linenos">233</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="DShieldClient.close-234"><a href="#DShieldClient.close-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DShieldClient.close-235"><a href="#DShieldClient.close-235"><span class="linenos">235</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DShield client session closed&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Close HTTP session.</p>

<p>Closes the aiohttp.ClientSession and releases resources.
Logs session closure.</p>
</div>


                            </div>
                            <div id="DShieldClient.get_ip_reputation" class="classattr">
                                        <input id="DShieldClient.get_ip_reputation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_ip_reputation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.get_ip_reputation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.get_ip_reputation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.get_ip_reputation-237"><a href="#DShieldClient.get_ip_reputation-237"><span class="linenos">237</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_reputation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient.get_ip_reputation-238"><a href="#DShieldClient.get_ip_reputation-238"><span class="linenos">238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get IP reputation from DShield.</span>
</span><span id="DShieldClient.get_ip_reputation-239"><a href="#DShieldClient.get_ip_reputation-239"><span class="linenos">239</span></a>
</span><span id="DShieldClient.get_ip_reputation-240"><a href="#DShieldClient.get_ip_reputation-240"><span class="linenos">240</span></a><span class="sd">        Looks up the reputation of a given IP address using the DShield API.</span>
</span><span id="DShieldClient.get_ip_reputation-241"><a href="#DShieldClient.get_ip_reputation-241"><span class="linenos">241</span></a><span class="sd">        Utilizes caching and rate limiting for efficiency.</span>
</span><span id="DShieldClient.get_ip_reputation-242"><a href="#DShieldClient.get_ip_reputation-242"><span class="linenos">242</span></a>
</span><span id="DShieldClient.get_ip_reputation-243"><a href="#DShieldClient.get_ip_reputation-243"><span class="linenos">243</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient.get_ip_reputation-244"><a href="#DShieldClient.get_ip_reputation-244"><span class="linenos">244</span></a><span class="sd">            ip_address: The IP address to look up</span>
</span><span id="DShieldClient.get_ip_reputation-245"><a href="#DShieldClient.get_ip_reputation-245"><span class="linenos">245</span></a>
</span><span id="DShieldClient.get_ip_reputation-246"><a href="#DShieldClient.get_ip_reputation-246"><span class="linenos">246</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient.get_ip_reputation-247"><a href="#DShieldClient.get_ip_reputation-247"><span class="linenos">247</span></a><span class="sd">            Dictionary containing reputation data for the IP</span>
</span><span id="DShieldClient.get_ip_reputation-248"><a href="#DShieldClient.get_ip_reputation-248"><span class="linenos">248</span></a>
</span><span id="DShieldClient.get_ip_reputation-249"><a href="#DShieldClient.get_ip_reputation-249"><span class="linenos">249</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.get_ip_reputation-250"><a href="#DShieldClient.get_ip_reputation-250"><span class="linenos">250</span></a>        <span class="c1"># Check cache first</span>
</span><span id="DShieldClient.get_ip_reputation-251"><a href="#DShieldClient.get_ip_reputation-251"><span class="linenos">251</span></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;reputation_</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_ip_reputation-252"><a href="#DShieldClient.get_ip_reputation-252"><span class="linenos">252</span></a>        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-253"><a href="#DShieldClient.get_ip_reputation-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-254"><a href="#DShieldClient.get_ip_reputation-254"><span class="linenos">254</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Returning cached IP reputation&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-255"><a href="#DShieldClient.get_ip_reputation-255"><span class="linenos">255</span></a>            <span class="k">return</span> <span class="n">cached_data</span>
</span><span id="DShieldClient.get_ip_reputation-256"><a href="#DShieldClient.get_ip_reputation-256"><span class="linenos">256</span></a>
</span><span id="DShieldClient.get_ip_reputation-257"><a href="#DShieldClient.get_ip_reputation-257"><span class="linenos">257</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient.get_ip_reputation-258"><a href="#DShieldClient.get_ip_reputation-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_ip_reputation&quot;</span><span class="p">):</span>
</span><span id="DShieldClient.get_ip_reputation-259"><a href="#DShieldClient.get_ip_reputation-259"><span class="linenos">259</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-260"><a href="#DShieldClient.get_ip_reputation-260"><span class="linenos">260</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-261"><a href="#DShieldClient.get_ip_reputation-261"><span class="linenos">261</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-262"><a href="#DShieldClient.get_ip_reputation-262"><span class="linenos">262</span></a>
</span><span id="DShieldClient.get_ip_reputation-263"><a href="#DShieldClient.get_ip_reputation-263"><span class="linenos">263</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient.get_ip_reputation-264"><a href="#DShieldClient.get_ip_reputation-264"><span class="linenos">264</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_reputation-265"><a href="#DShieldClient.get_ip_reputation-265"><span class="linenos">265</span></a>
</span><span id="DShieldClient.get_ip_reputation-266"><a href="#DShieldClient.get_ip_reputation-266"><span class="linenos">266</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-267"><a href="#DShieldClient.get_ip_reputation-267"><span class="linenos">267</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_reputation-268"><a href="#DShieldClient.get_ip_reputation-268"><span class="linenos">268</span></a>
</span><span id="DShieldClient.get_ip_reputation-269"><a href="#DShieldClient.get_ip_reputation-269"><span class="linenos">269</span></a>            <span class="c1"># DShield IP reputation endpoint</span>
</span><span id="DShieldClient.get_ip_reputation-270"><a href="#DShieldClient.get_ip_reputation-270"><span class="linenos">270</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-271"><a href="#DShieldClient.get_ip_reputation-271"><span class="linenos">271</span></a>
</span><span id="DShieldClient.get_ip_reputation-272"><a href="#DShieldClient.get_ip_reputation-272"><span class="linenos">272</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield IP reputation&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-273"><a href="#DShieldClient.get_ip_reputation-273"><span class="linenos">273</span></a>
</span><span id="DShieldClient.get_ip_reputation-274"><a href="#DShieldClient.get_ip_reputation-274"><span class="linenos">274</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-275"><a href="#DShieldClient.get_ip_reputation-275"><span class="linenos">275</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-276"><a href="#DShieldClient.get_ip_reputation-276"><span class="linenos">276</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_reputation-277"><a href="#DShieldClient.get_ip_reputation-277"><span class="linenos">277</span></a>                    <span class="n">reputation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ip_reputation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-278"><a href="#DShieldClient.get_ip_reputation-278"><span class="linenos">278</span></a>
</span><span id="DShieldClient.get_ip_reputation-279"><a href="#DShieldClient.get_ip_reputation-279"><span class="linenos">279</span></a>                    <span class="c1"># Cache the result</span>
</span><span id="DShieldClient.get_ip_reputation-280"><a href="#DShieldClient.get_ip_reputation-280"><span class="linenos">280</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">reputation_data</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-281"><a href="#DShieldClient.get_ip_reputation-281"><span class="linenos">281</span></a>
</span><span id="DShieldClient.get_ip_reputation-282"><a href="#DShieldClient.get_ip_reputation-282"><span class="linenos">282</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_reputation-283"><a href="#DShieldClient.get_ip_reputation-283"><span class="linenos">283</span></a>                        <span class="s2">&quot;IP reputation retrieved successfully&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_reputation-284"><a href="#DShieldClient.get_ip_reputation-284"><span class="linenos">284</span></a>                        <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_reputation-285"><a href="#DShieldClient.get_ip_reputation-285"><span class="linenos">285</span></a>                        <span class="n">reputation_score</span><span class="o">=</span><span class="n">reputation_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reputation_score&quot;</span><span class="p">),</span>
</span><span id="DShieldClient.get_ip_reputation-286"><a href="#DShieldClient.get_ip_reputation-286"><span class="linenos">286</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-287"><a href="#DShieldClient.get_ip_reputation-287"><span class="linenos">287</span></a>
</span><span id="DShieldClient.get_ip_reputation-288"><a href="#DShieldClient.get_ip_reputation-288"><span class="linenos">288</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient.get_ip_reputation-289"><a href="#DShieldClient.get_ip_reputation-289"><span class="linenos">289</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_reputation-290"><a href="#DShieldClient.get_ip_reputation-290"><span class="linenos">290</span></a>
</span><span id="DShieldClient.get_ip_reputation-291"><a href="#DShieldClient.get_ip_reputation-291"><span class="linenos">291</span></a>                    <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="DShieldClient.get_ip_reputation-292"><a href="#DShieldClient.get_ip_reputation-292"><span class="linenos">292</span></a>
</span><span id="DShieldClient.get_ip_reputation-293"><a href="#DShieldClient.get_ip_reputation-293"><span class="linenos">293</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-294"><a href="#DShieldClient.get_ip_reputation-294"><span class="linenos">294</span></a>                    <span class="c1"># IP not found in DShield database</span>
</span><span id="DShieldClient.get_ip_reputation-295"><a href="#DShieldClient.get_ip_reputation-295"><span class="linenos">295</span></a>                    <span class="n">reputation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-296"><a href="#DShieldClient.get_ip_reputation-296"><span class="linenos">296</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">reputation_data</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-297"><a href="#DShieldClient.get_ip_reputation-297"><span class="linenos">297</span></a>                    <span class="k">return</span> <span class="n">reputation_data</span>
</span><span id="DShieldClient.get_ip_reputation-298"><a href="#DShieldClient.get_ip_reputation-298"><span class="linenos">298</span></a>
</span><span id="DShieldClient.get_ip_reputation-299"><a href="#DShieldClient.get_ip_reputation-299"><span class="linenos">299</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_reputation-300"><a href="#DShieldClient.get_ip_reputation-300"><span class="linenos">300</span></a>                    <span class="s2">&quot;DShield API returned non-200 status&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_reputation-301"><a href="#DShieldClient.get_ip_reputation-301"><span class="linenos">301</span></a>                    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_reputation-302"><a href="#DShieldClient.get_ip_reputation-302"><span class="linenos">302</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_reputation-303"><a href="#DShieldClient.get_ip_reputation-303"><span class="linenos">303</span></a>                <span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-304"><a href="#DShieldClient.get_ip_reputation-304"><span class="linenos">304</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-305"><a href="#DShieldClient.get_ip_reputation-305"><span class="linenos">305</span></a>
</span><span id="DShieldClient.get_ip_reputation-306"><a href="#DShieldClient.get_ip_reputation-306"><span class="linenos">306</span></a>        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-307"><a href="#DShieldClient.get_ip_reputation-307"><span class="linenos">307</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_reputation-308"><a href="#DShieldClient.get_ip_reputation-308"><span class="linenos">308</span></a>                <span class="s2">&quot;HTTP error during IP reputation lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-309"><a href="#DShieldClient.get_ip_reputation-309"><span class="linenos">309</span></a>            <span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-310"><a href="#DShieldClient.get_ip_reputation-310"><span class="linenos">310</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient.get_ip_reputation-311"><a href="#DShieldClient.get_ip_reputation-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-312"><a href="#DShieldClient.get_ip_reputation-312"><span class="linenos">312</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-313"><a href="#DShieldClient.get_ip_reputation-313"><span class="linenos">313</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient.get_ip_reputation-314"><a href="#DShieldClient.get_ip_reputation-314"><span class="linenos">314</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_external_service_error</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_reputation-315"><a href="#DShieldClient.get_ip_reputation-315"><span class="linenos">315</span></a>                        <span class="s2">&quot;DShield API&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;HTTP error: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_ip_reputation-316"><a href="#DShieldClient.get_ip_reputation-316"><span class="linenos">316</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-317"><a href="#DShieldClient.get_ip_reputation-317"><span class="linenos">317</span></a>                <span class="p">}</span>
</span><span id="DShieldClient.get_ip_reputation-318"><a href="#DShieldClient.get_ip_reputation-318"><span class="linenos">318</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-319"><a href="#DShieldClient.get_ip_reputation-319"><span class="linenos">319</span></a>
</span><span id="DShieldClient.get_ip_reputation-320"><a href="#DShieldClient.get_ip_reputation-320"><span class="linenos">320</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-321"><a href="#DShieldClient.get_ip_reputation-321"><span class="linenos">321</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_reputation-322"><a href="#DShieldClient.get_ip_reputation-322"><span class="linenos">322</span></a>                <span class="s2">&quot;Unexpected error during IP reputation lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-323"><a href="#DShieldClient.get_ip_reputation-323"><span class="linenos">323</span></a>            <span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-324"><a href="#DShieldClient.get_ip_reputation-324"><span class="linenos">324</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient.get_ip_reputation-325"><a href="#DShieldClient.get_ip_reputation-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-326"><a href="#DShieldClient.get_ip_reputation-326"><span class="linenos">326</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_reputation-327"><a href="#DShieldClient.get_ip_reputation-327"><span class="linenos">327</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient.get_ip_reputation-328"><a href="#DShieldClient.get_ip_reputation-328"><span class="linenos">328</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_reputation-329"><a href="#DShieldClient.get_ip_reputation-329"><span class="linenos">329</span></a>                        <span class="sa">f</span><span class="s2">&quot;IP reputation lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_ip_reputation-330"><a href="#DShieldClient.get_ip_reputation-330"><span class="linenos">330</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.get_ip_reputation-331"><a href="#DShieldClient.get_ip_reputation-331"><span class="linenos">331</span></a>                <span class="p">}</span>
</span><span id="DShieldClient.get_ip_reputation-332"><a href="#DShieldClient.get_ip_reputation-332"><span class="linenos">332</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get IP reputation from DShield.</p>

<p>Looks up the reputation of a given IP address using the DShield API.
Utilizes caching and rate limiting for efficiency.</p>

<p>Args:
    ip_address: The IP address to look up</p>

<p>Returns:
    Dictionary containing reputation data for the IP</p>
</div>


                            </div>
                            <div id="DShieldClient.get_ip_details" class="classattr">
                                        <input id="DShieldClient.get_ip_details-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_ip_details</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.get_ip_details-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.get_ip_details"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.get_ip_details-334"><a href="#DShieldClient.get_ip_details-334"><span class="linenos">334</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient.get_ip_details-335"><a href="#DShieldClient.get_ip_details-335"><span class="linenos">335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get detailed IP information from DShield.</span>
</span><span id="DShieldClient.get_ip_details-336"><a href="#DShieldClient.get_ip_details-336"><span class="linenos">336</span></a>
</span><span id="DShieldClient.get_ip_details-337"><a href="#DShieldClient.get_ip_details-337"><span class="linenos">337</span></a><span class="sd">        Retrieves detailed information for a given IP address from the DShield API.</span>
</span><span id="DShieldClient.get_ip_details-338"><a href="#DShieldClient.get_ip_details-338"><span class="linenos">338</span></a><span class="sd">        Utilizes caching and rate limiting for efficiency.</span>
</span><span id="DShieldClient.get_ip_details-339"><a href="#DShieldClient.get_ip_details-339"><span class="linenos">339</span></a>
</span><span id="DShieldClient.get_ip_details-340"><a href="#DShieldClient.get_ip_details-340"><span class="linenos">340</span></a><span class="sd">        Args:</span>
</span><span id="DShieldClient.get_ip_details-341"><a href="#DShieldClient.get_ip_details-341"><span class="linenos">341</span></a><span class="sd">            ip_address: The IP address to look up</span>
</span><span id="DShieldClient.get_ip_details-342"><a href="#DShieldClient.get_ip_details-342"><span class="linenos">342</span></a>
</span><span id="DShieldClient.get_ip_details-343"><a href="#DShieldClient.get_ip_details-343"><span class="linenos">343</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient.get_ip_details-344"><a href="#DShieldClient.get_ip_details-344"><span class="linenos">344</span></a><span class="sd">            Dictionary containing detailed data for the IP</span>
</span><span id="DShieldClient.get_ip_details-345"><a href="#DShieldClient.get_ip_details-345"><span class="linenos">345</span></a>
</span><span id="DShieldClient.get_ip_details-346"><a href="#DShieldClient.get_ip_details-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.get_ip_details-347"><a href="#DShieldClient.get_ip_details-347"><span class="linenos">347</span></a>        <span class="c1"># Check cache first</span>
</span><span id="DShieldClient.get_ip_details-348"><a href="#DShieldClient.get_ip_details-348"><span class="linenos">348</span></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;details_</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_ip_details-349"><a href="#DShieldClient.get_ip_details-349"><span class="linenos">349</span></a>        <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-350"><a href="#DShieldClient.get_ip_details-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">cached_data</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-351"><a href="#DShieldClient.get_ip_details-351"><span class="linenos">351</span></a>            <span class="k">return</span> <span class="n">cached_data</span>
</span><span id="DShieldClient.get_ip_details-352"><a href="#DShieldClient.get_ip_details-352"><span class="linenos">352</span></a>
</span><span id="DShieldClient.get_ip_details-353"><a href="#DShieldClient.get_ip_details-353"><span class="linenos">353</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient.get_ip_details-354"><a href="#DShieldClient.get_ip_details-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_ip_details&quot;</span><span class="p">):</span>
</span><span id="DShieldClient.get_ip_details-355"><a href="#DShieldClient.get_ip_details-355"><span class="linenos">355</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-356"><a href="#DShieldClient.get_ip_details-356"><span class="linenos">356</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-357"><a href="#DShieldClient.get_ip_details-357"><span class="linenos">357</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-358"><a href="#DShieldClient.get_ip_details-358"><span class="linenos">358</span></a>
</span><span id="DShieldClient.get_ip_details-359"><a href="#DShieldClient.get_ip_details-359"><span class="linenos">359</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient.get_ip_details-360"><a href="#DShieldClient.get_ip_details-360"><span class="linenos">360</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_details-361"><a href="#DShieldClient.get_ip_details-361"><span class="linenos">361</span></a>
</span><span id="DShieldClient.get_ip_details-362"><a href="#DShieldClient.get_ip_details-362"><span class="linenos">362</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-363"><a href="#DShieldClient.get_ip_details-363"><span class="linenos">363</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_details-364"><a href="#DShieldClient.get_ip_details-364"><span class="linenos">364</span></a>
</span><span id="DShieldClient.get_ip_details-365"><a href="#DShieldClient.get_ip_details-365"><span class="linenos">365</span></a>            <span class="c1"># DShield IP details endpoint</span>
</span><span id="DShieldClient.get_ip_details-366"><a href="#DShieldClient.get_ip_details-366"><span class="linenos">366</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ip/</span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s2">/details&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-367"><a href="#DShieldClient.get_ip_details-367"><span class="linenos">367</span></a>
</span><span id="DShieldClient.get_ip_details-368"><a href="#DShieldClient.get_ip_details-368"><span class="linenos">368</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield IP details&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-369"><a href="#DShieldClient.get_ip_details-369"><span class="linenos">369</span></a>
</span><span id="DShieldClient.get_ip_details-370"><a href="#DShieldClient.get_ip_details-370"><span class="linenos">370</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-371"><a href="#DShieldClient.get_ip_details-371"><span class="linenos">371</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-372"><a href="#DShieldClient.get_ip_details-372"><span class="linenos">372</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_details-373"><a href="#DShieldClient.get_ip_details-373"><span class="linenos">373</span></a>                    <span class="n">details_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_ip_details</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-374"><a href="#DShieldClient.get_ip_details-374"><span class="linenos">374</span></a>
</span><span id="DShieldClient.get_ip_details-375"><a href="#DShieldClient.get_ip_details-375"><span class="linenos">375</span></a>                    <span class="c1"># Cache the result</span>
</span><span id="DShieldClient.get_ip_details-376"><a href="#DShieldClient.get_ip_details-376"><span class="linenos">376</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache_data</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">details_data</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-377"><a href="#DShieldClient.get_ip_details-377"><span class="linenos">377</span></a>
</span><span id="DShieldClient.get_ip_details-378"><a href="#DShieldClient.get_ip_details-378"><span class="linenos">378</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient.get_ip_details-379"><a href="#DShieldClient.get_ip_details-379"><span class="linenos">379</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient.get_ip_details-380"><a href="#DShieldClient.get_ip_details-380"><span class="linenos">380</span></a>
</span><span id="DShieldClient.get_ip_details-381"><a href="#DShieldClient.get_ip_details-381"><span class="linenos">381</span></a>                    <span class="k">return</span> <span class="n">details_data</span>
</span><span id="DShieldClient.get_ip_details-382"><a href="#DShieldClient.get_ip_details-382"><span class="linenos">382</span></a>
</span><span id="DShieldClient.get_ip_details-383"><a href="#DShieldClient.get_ip_details-383"><span class="linenos">383</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_details-384"><a href="#DShieldClient.get_ip_details-384"><span class="linenos">384</span></a>                    <span class="s2">&quot;DShield details API returned non-200 status&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_details-385"><a href="#DShieldClient.get_ip_details-385"><span class="linenos">385</span></a>                    <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_details-386"><a href="#DShieldClient.get_ip_details-386"><span class="linenos">386</span></a>                    <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient.get_ip_details-387"><a href="#DShieldClient.get_ip_details-387"><span class="linenos">387</span></a>                <span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-388"><a href="#DShieldClient.get_ip_details-388"><span class="linenos">388</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-389"><a href="#DShieldClient.get_ip_details-389"><span class="linenos">389</span></a>
</span><span id="DShieldClient.get_ip_details-390"><a href="#DShieldClient.get_ip_details-390"><span class="linenos">390</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-391"><a href="#DShieldClient.get_ip_details-391"><span class="linenos">391</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during IP details lookup&quot;</span><span class="p">,</span> <span class="n">ip_address</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient.get_ip_details-392"><a href="#DShieldClient.get_ip_details-392"><span class="linenos">392</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient.get_ip_details-393"><a href="#DShieldClient.get_ip_details-393"><span class="linenos">393</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-394"><a href="#DShieldClient.get_ip_details-394"><span class="linenos">394</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_ip_details-395"><a href="#DShieldClient.get_ip_details-395"><span class="linenos">395</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient.get_ip_details-396"><a href="#DShieldClient.get_ip_details-396"><span class="linenos">396</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient.get_ip_details-397"><a href="#DShieldClient.get_ip_details-397"><span class="linenos">397</span></a>                        <span class="sa">f</span><span class="s2">&quot;IP details lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_ip_details-398"><a href="#DShieldClient.get_ip_details-398"><span class="linenos">398</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.get_ip_details-399"><a href="#DShieldClient.get_ip_details-399"><span class="linenos">399</span></a>                <span class="p">}</span>
</span><span id="DShieldClient.get_ip_details-400"><a href="#DShieldClient.get_ip_details-400"><span class="linenos">400</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_details</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get detailed IP information from DShield.</p>

<p>Retrieves detailed information for a given IP address from the DShield API.
Utilizes caching and rate limiting for efficiency.</p>

<p>Args:
    ip_address: The IP address to look up</p>

<p>Returns:
    Dictionary containing detailed data for the IP</p>
</div>


                            </div>
                            <div id="DShieldClient.get_top_attackers" class="classattr">
                                        <input id="DShieldClient.get_top_attackers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_top_attackers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.get_top_attackers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.get_top_attackers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.get_top_attackers-402"><a href="#DShieldClient.get_top_attackers-402"><span class="linenos">402</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_top_attackers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="DShieldClient.get_top_attackers-403"><a href="#DShieldClient.get_top_attackers-403"><span class="linenos">403</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get top attackers from DShield.&quot;&quot;&quot;</span>
</span><span id="DShieldClient.get_top_attackers-404"><a href="#DShieldClient.get_top_attackers-404"><span class="linenos">404</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient.get_top_attackers-405"><a href="#DShieldClient.get_top_attackers-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_top_attackers&quot;</span><span class="p">):</span>
</span><span id="DShieldClient.get_top_attackers-406"><a href="#DShieldClient.get_top_attackers-406"><span class="linenos">406</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_top_attackers-407"><a href="#DShieldClient.get_top_attackers-407"><span class="linenos">407</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-408"><a href="#DShieldClient.get_top_attackers-408"><span class="linenos">408</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="DShieldClient.get_top_attackers-409"><a href="#DShieldClient.get_top_attackers-409"><span class="linenos">409</span></a>
</span><span id="DShieldClient.get_top_attackers-410"><a href="#DShieldClient.get_top_attackers-410"><span class="linenos">410</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient.get_top_attackers-411"><a href="#DShieldClient.get_top_attackers-411"><span class="linenos">411</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient.get_top_attackers-412"><a href="#DShieldClient.get_top_attackers-412"><span class="linenos">412</span></a>
</span><span id="DShieldClient.get_top_attackers-413"><a href="#DShieldClient.get_top_attackers-413"><span class="linenos">413</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.get_top_attackers-414"><a href="#DShieldClient.get_top_attackers-414"><span class="linenos">414</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient.get_top_attackers-415"><a href="#DShieldClient.get_top_attackers-415"><span class="linenos">415</span></a>
</span><span id="DShieldClient.get_top_attackers-416"><a href="#DShieldClient.get_top_attackers-416"><span class="linenos">416</span></a>            <span class="c1"># DShield top attackers endpoint</span>
</span><span id="DShieldClient.get_top_attackers-417"><a href="#DShieldClient.get_top_attackers-417"><span class="linenos">417</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;topattackers/</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-418"><a href="#DShieldClient.get_top_attackers-418"><span class="linenos">418</span></a>
</span><span id="DShieldClient.get_top_attackers-419"><a href="#DShieldClient.get_top_attackers-419"><span class="linenos">419</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield top attackers&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-420"><a href="#DShieldClient.get_top_attackers-420"><span class="linenos">420</span></a>
</span><span id="DShieldClient.get_top_attackers-421"><a href="#DShieldClient.get_top_attackers-421"><span class="linenos">421</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient.get_top_attackers-422"><a href="#DShieldClient.get_top_attackers-422"><span class="linenos">422</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient.get_top_attackers-423"><a href="#DShieldClient.get_top_attackers-423"><span class="linenos">423</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient.get_top_attackers-424"><a href="#DShieldClient.get_top_attackers-424"><span class="linenos">424</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient.get_top_attackers-425"><a href="#DShieldClient.get_top_attackers-425"><span class="linenos">425</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient.get_top_attackers-426"><a href="#DShieldClient.get_top_attackers-426"><span class="linenos">426</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_top_attackers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-427"><a href="#DShieldClient.get_top_attackers-427"><span class="linenos">427</span></a>
</span><span id="DShieldClient.get_top_attackers-428"><a href="#DShieldClient.get_top_attackers-428"><span class="linenos">428</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient.get_top_attackers-429"><a href="#DShieldClient.get_top_attackers-429"><span class="linenos">429</span></a>                    <span class="s2">&quot;DShield top attackers API returned non-200 status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span>
</span><span id="DShieldClient.get_top_attackers-430"><a href="#DShieldClient.get_top_attackers-430"><span class="linenos">430</span></a>                <span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-431"><a href="#DShieldClient.get_top_attackers-431"><span class="linenos">431</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="DShieldClient.get_top_attackers-432"><a href="#DShieldClient.get_top_attackers-432"><span class="linenos">432</span></a>
</span><span id="DShieldClient.get_top_attackers-433"><a href="#DShieldClient.get_top_attackers-433"><span class="linenos">433</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.get_top_attackers-434"><a href="#DShieldClient.get_top_attackers-434"><span class="linenos">434</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during top attackers lookup&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient.get_top_attackers-435"><a href="#DShieldClient.get_top_attackers-435"><span class="linenos">435</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient.get_top_attackers-436"><a href="#DShieldClient.get_top_attackers-436"><span class="linenos">436</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-437"><a href="#DShieldClient.get_top_attackers-437"><span class="linenos">437</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_top_attackers-438"><a href="#DShieldClient.get_top_attackers-438"><span class="linenos">438</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient.get_top_attackers-439"><a href="#DShieldClient.get_top_attackers-439"><span class="linenos">439</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient.get_top_attackers-440"><a href="#DShieldClient.get_top_attackers-440"><span class="linenos">440</span></a>                        <span class="sa">f</span><span class="s2">&quot;Top attackers lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_top_attackers-441"><a href="#DShieldClient.get_top_attackers-441"><span class="linenos">441</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.get_top_attackers-442"><a href="#DShieldClient.get_top_attackers-442"><span class="linenos">442</span></a>                <span class="p">}</span>
</span><span id="DShieldClient.get_top_attackers-443"><a href="#DShieldClient.get_top_attackers-443"><span class="linenos">443</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Get top attackers from DShield.</p>
</div>


                            </div>
                            <div id="DShieldClient.get_attack_summary" class="classattr">
                                        <input id="DShieldClient.get_attack_summary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">get_attack_summary</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.get_attack_summary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.get_attack_summary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.get_attack_summary-445"><a href="#DShieldClient.get_attack_summary-445"><span class="linenos">445</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_attack_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="DShieldClient.get_attack_summary-446"><a href="#DShieldClient.get_attack_summary-446"><span class="linenos">446</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get attack summary from DShield.&quot;&quot;&quot;</span>
</span><span id="DShieldClient.get_attack_summary-447"><a href="#DShieldClient.get_attack_summary-447"><span class="linenos">447</span></a>        <span class="c1"># Circuit breaker check</span>
</span><span id="DShieldClient.get_attack_summary-448"><a href="#DShieldClient.get_attack_summary-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_circuit_breaker</span><span class="p">(</span><span class="s2">&quot;get_attack_summary&quot;</span><span class="p">):</span>
</span><span id="DShieldClient.get_attack_summary-449"><a href="#DShieldClient.get_attack_summary-449"><span class="linenos">449</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_attack_summary-450"><a href="#DShieldClient.get_attack_summary-450"><span class="linenos">450</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_circuit_breaker_open_error</span><span class="p">(</span><span class="s2">&quot;DShield API&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-451"><a href="#DShieldClient.get_attack_summary-451"><span class="linenos">451</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="DShieldClient.get_attack_summary-452"><a href="#DShieldClient.get_attack_summary-452"><span class="linenos">452</span></a>
</span><span id="DShieldClient.get_attack_summary-453"><a href="#DShieldClient.get_attack_summary-453"><span class="linenos">453</span></a>        <span class="c1"># Rate limiting</span>
</span><span id="DShieldClient.get_attack_summary-454"><a href="#DShieldClient.get_attack_summary-454"><span class="linenos">454</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_rate_limit</span><span class="p">()</span>
</span><span id="DShieldClient.get_attack_summary-455"><a href="#DShieldClient.get_attack_summary-455"><span class="linenos">455</span></a>
</span><span id="DShieldClient.get_attack_summary-456"><a href="#DShieldClient.get_attack_summary-456"><span class="linenos">456</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.get_attack_summary-457"><a href="#DShieldClient.get_attack_summary-457"><span class="linenos">457</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient.get_attack_summary-458"><a href="#DShieldClient.get_attack_summary-458"><span class="linenos">458</span></a>
</span><span id="DShieldClient.get_attack_summary-459"><a href="#DShieldClient.get_attack_summary-459"><span class="linenos">459</span></a>            <span class="c1"># DShield attack summary endpoint</span>
</span><span id="DShieldClient.get_attack_summary-460"><a href="#DShieldClient.get_attack_summary-460"><span class="linenos">460</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;summary/</span><span class="si">{</span><span class="n">hours</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-461"><a href="#DShieldClient.get_attack_summary-461"><span class="linenos">461</span></a>
</span><span id="DShieldClient.get_attack_summary-462"><a href="#DShieldClient.get_attack_summary-462"><span class="linenos">462</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Querying DShield attack summary&quot;</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-463"><a href="#DShieldClient.get_attack_summary-463"><span class="linenos">463</span></a>
</span><span id="DShieldClient.get_attack_summary-464"><a href="#DShieldClient.get_attack_summary-464"><span class="linenos">464</span></a>            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient.get_attack_summary-465"><a href="#DShieldClient.get_attack_summary-465"><span class="linenos">465</span></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="DShieldClient.get_attack_summary-466"><a href="#DShieldClient.get_attack_summary-466"><span class="linenos">466</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="DShieldClient.get_attack_summary-467"><a href="#DShieldClient.get_attack_summary-467"><span class="linenos">467</span></a>                    <span class="c1"># Record success with circuit breaker</span>
</span><span id="DShieldClient.get_attack_summary-468"><a href="#DShieldClient.get_attack_summary-468"><span class="linenos">468</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_success</span><span class="p">()</span>
</span><span id="DShieldClient.get_attack_summary-469"><a href="#DShieldClient.get_attack_summary-469"><span class="linenos">469</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_attack_summary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-470"><a href="#DShieldClient.get_attack_summary-470"><span class="linenos">470</span></a>
</span><span id="DShieldClient.get_attack_summary-471"><a href="#DShieldClient.get_attack_summary-471"><span class="linenos">471</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient.get_attack_summary-472"><a href="#DShieldClient.get_attack_summary-472"><span class="linenos">472</span></a>                    <span class="s2">&quot;DShield summary API returned non-200 status&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span>
</span><span id="DShieldClient.get_attack_summary-473"><a href="#DShieldClient.get_attack_summary-473"><span class="linenos">473</span></a>                <span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-474"><a href="#DShieldClient.get_attack_summary-474"><span class="linenos">474</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span><span id="DShieldClient.get_attack_summary-475"><a href="#DShieldClient.get_attack_summary-475"><span class="linenos">475</span></a>
</span><span id="DShieldClient.get_attack_summary-476"><a href="#DShieldClient.get_attack_summary-476"><span class="linenos">476</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.get_attack_summary-477"><a href="#DShieldClient.get_attack_summary-477"><span class="linenos">477</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error during attack summary lookup&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient.get_attack_summary-478"><a href="#DShieldClient.get_attack_summary-478"><span class="linenos">478</span></a>            <span class="c1"># Record failure with circuit breaker</span>
</span><span id="DShieldClient.get_attack_summary-479"><a href="#DShieldClient.get_attack_summary-479"><span class="linenos">479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_record_circuit_breaker_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-480"><a href="#DShieldClient.get_attack_summary-480"><span class="linenos">480</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="p">:</span>
</span><span id="DShieldClient.get_attack_summary-481"><a href="#DShieldClient.get_attack_summary-481"><span class="linenos">481</span></a>                <span class="k">return</span> <span class="p">{</span>
</span><span id="DShieldClient.get_attack_summary-482"><a href="#DShieldClient.get_attack_summary-482"><span class="linenos">482</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handler</span><span class="o">.</span><span class="n">create_internal_error</span><span class="p">(</span>
</span><span id="DShieldClient.get_attack_summary-483"><a href="#DShieldClient.get_attack_summary-483"><span class="linenos">483</span></a>                        <span class="sa">f</span><span class="s2">&quot;Attack summary lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
</span><span id="DShieldClient.get_attack_summary-484"><a href="#DShieldClient.get_attack_summary-484"><span class="linenos">484</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.get_attack_summary-485"><a href="#DShieldClient.get_attack_summary-485"><span class="linenos">485</span></a>                <span class="p">}</span>
</span><span id="DShieldClient.get_attack_summary-486"><a href="#DShieldClient.get_attack_summary-486"><span class="linenos">486</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_summary</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get attack summary from DShield.</p>
</div>


                            </div>
                            <div id="DShieldClient.enrich_ips_batch" class="classattr">
                                        <input id="DShieldClient.enrich_ips_batch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">enrich_ips_batch</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ip_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.enrich_ips_batch-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.enrich_ips_batch"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.enrich_ips_batch-488"><a href="#DShieldClient.enrich_ips_batch-488"><span class="linenos">488</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">enrich_ips_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="DShieldClient.enrich_ips_batch-489"><a href="#DShieldClient.enrich_ips_batch-489"><span class="linenos">489</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enrich multiple IP addresses with threat intelligence.&quot;&quot;&quot;</span>
</span><span id="DShieldClient.enrich_ips_batch-490"><a href="#DShieldClient.enrich_ips_batch-490"><span class="linenos">490</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="DShieldClient.enrich_ips_batch-491"><a href="#DShieldClient.enrich_ips_batch-491"><span class="linenos">491</span></a>
</span><span id="DShieldClient.enrich_ips_batch-492"><a href="#DShieldClient.enrich_ips_batch-492"><span class="linenos">492</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
</span><span id="DShieldClient.enrich_ips_batch-493"><a href="#DShieldClient.enrich_ips_batch-493"><span class="linenos">493</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="DShieldClient.enrich_ips_batch-494"><a href="#DShieldClient.enrich_ips_batch-494"><span class="linenos">494</span></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">ip_addresses</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
</span><span id="DShieldClient.enrich_ips_batch-495"><a href="#DShieldClient.enrich_ips_batch-495"><span class="linenos">495</span></a>
</span><span id="DShieldClient.enrich_ips_batch-496"><a href="#DShieldClient.enrich_ips_batch-496"><span class="linenos">496</span></a>            <span class="c1"># Process batch concurrently</span>
</span><span id="DShieldClient.enrich_ips_batch-497"><a href="#DShieldClient.enrich_ips_batch-497"><span class="linenos">497</span></a>            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ip_reputation</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span id="DShieldClient.enrich_ips_batch-498"><a href="#DShieldClient.enrich_ips_batch-498"><span class="linenos">498</span></a>            <span class="n">batch_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DShieldClient.enrich_ips_batch-499"><a href="#DShieldClient.enrich_ips_batch-499"><span class="linenos">499</span></a>
</span><span id="DShieldClient.enrich_ips_batch-500"><a href="#DShieldClient.enrich_ips_batch-500"><span class="linenos">500</span></a>            <span class="c1"># Store results</span>
</span><span id="DShieldClient.enrich_ips_batch-501"><a href="#DShieldClient.enrich_ips_batch-501"><span class="linenos">501</span></a>            <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="DShieldClient.enrich_ips_batch-502"><a href="#DShieldClient.enrich_ips_batch-502"><span class="linenos">502</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
</span><span id="DShieldClient.enrich_ips_batch-503"><a href="#DShieldClient.enrich_ips_batch-503"><span class="linenos">503</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to enrich IP&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span><span id="DShieldClient.enrich_ips_batch-504"><a href="#DShieldClient.enrich_ips_batch-504"><span class="linenos">504</span></a>                    <span class="n">results</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_default_reputation</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</span><span id="DShieldClient.enrich_ips_batch-505"><a href="#DShieldClient.enrich_ips_batch-505"><span class="linenos">505</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DShieldClient.enrich_ips_batch-506"><a href="#DShieldClient.enrich_ips_batch-506"><span class="linenos">506</span></a>                    <span class="n">results</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="DShieldClient.enrich_ips_batch-507"><a href="#DShieldClient.enrich_ips_batch-507"><span class="linenos">507</span></a>
</span><span id="DShieldClient.enrich_ips_batch-508"><a href="#DShieldClient.enrich_ips_batch-508"><span class="linenos">508</span></a>            <span class="c1"># Small delay between batches</span>
</span><span id="DShieldClient.enrich_ips_batch-509"><a href="#DShieldClient.enrich_ips_batch-509"><span class="linenos">509</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_addresses</span><span class="p">):</span>
</span><span id="DShieldClient.enrich_ips_batch-510"><a href="#DShieldClient.enrich_ips_batch-510"><span class="linenos">510</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="DShieldClient.enrich_ips_batch-511"><a href="#DShieldClient.enrich_ips_batch-511"><span class="linenos">511</span></a>
</span><span id="DShieldClient.enrich_ips_batch-512"><a href="#DShieldClient.enrich_ips_batch-512"><span class="linenos">512</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Enrich multiple IP addresses with threat intelligence.</p>
</div>


                            </div>
                            <div id="DShieldClient.health_check" class="classattr">
                                        <input id="DShieldClient.health_check-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">health_check</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.health_check-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.health_check"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.health_check-514"><a href="#DShieldClient.health_check-514"><span class="linenos">514</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="DShieldClient.health_check-515"><a href="#DShieldClient.health_check-515"><span class="linenos">515</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check DShield API connectivity and authentication (placeholder).&quot;&quot;&quot;</span>
</span><span id="DShieldClient.health_check-516"><a href="#DShieldClient.health_check-516"><span class="linenos">516</span></a>        <span class="c1"># TODO: Implement actual connectivity check</span>
</span><span id="DShieldClient.health_check-517"><a href="#DShieldClient.health_check-517"><span class="linenos">517</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="DShieldClient.health_check-518"><a href="#DShieldClient.health_check-518"><span class="linenos">518</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Check DShield API connectivity and authentication (placeholder).</p>
</div>


                            </div>
                            <div id="DShieldClient.check_health" class="classattr">
                                        <input id="DShieldClient.check_health-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">check_health</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="DShieldClient.check_health-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DShieldClient.check_health"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DShieldClient.check_health-700"><a href="#DShieldClient.check_health-700"><span class="linenos">700</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_health</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-701"><a href="#DShieldClient.check_health-701"><span class="linenos">701</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check DShield API connectivity and authentication.</span>
</span><span id="DShieldClient.check_health-702"><a href="#DShieldClient.check_health-702"><span class="linenos">702</span></a>
</span><span id="DShieldClient.check_health-703"><a href="#DShieldClient.check_health-703"><span class="linenos">703</span></a><span class="sd">        Returns:</span>
</span><span id="DShieldClient.check_health-704"><a href="#DShieldClient.check_health-704"><span class="linenos">704</span></a><span class="sd">            bool: True if DShield API is healthy and accessible, False otherwise</span>
</span><span id="DShieldClient.check_health-705"><a href="#DShieldClient.check_health-705"><span class="linenos">705</span></a>
</span><span id="DShieldClient.check_health-706"><a href="#DShieldClient.check_health-706"><span class="linenos">706</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DShieldClient.check_health-707"><a href="#DShieldClient.check_health-707"><span class="linenos">707</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-708"><a href="#DShieldClient.check_health-708"><span class="linenos">708</span></a>            <span class="c1"># Check if we have valid configuration</span>
</span><span id="DShieldClient.check_health-709"><a href="#DShieldClient.check_health-709"><span class="linenos">709</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-710"><a href="#DShieldClient.check_health-710"><span class="linenos">710</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API base URL not configured&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.check_health-711"><a href="#DShieldClient.check_health-711"><span class="linenos">711</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient.check_health-712"><a href="#DShieldClient.check_health-712"><span class="linenos">712</span></a>
</span><span id="DShieldClient.check_health-713"><a href="#DShieldClient.check_health-713"><span class="linenos">713</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-714"><a href="#DShieldClient.check_health-714"><span class="linenos">714</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DShield API key not configured - some endpoints may not work&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.check_health-715"><a href="#DShieldClient.check_health-715"><span class="linenos">715</span></a>                <span class="c1"># Continue with health check but note the limitation</span>
</span><span id="DShieldClient.check_health-716"><a href="#DShieldClient.check_health-716"><span class="linenos">716</span></a>
</span><span id="DShieldClient.check_health-717"><a href="#DShieldClient.check_health-717"><span class="linenos">717</span></a>            <span class="c1"># Try to connect and make a simple test request</span>
</span><span id="DShieldClient.check_health-718"><a href="#DShieldClient.check_health-718"><span class="linenos">718</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="DShieldClient.check_health-719"><a href="#DShieldClient.check_health-719"><span class="linenos">719</span></a>
</span><span id="DShieldClient.check_health-720"><a href="#DShieldClient.check_health-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-721"><a href="#DShieldClient.check_health-721"><span class="linenos">721</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to create DShield client session&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.check_health-722"><a href="#DShieldClient.check_health-722"><span class="linenos">722</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient.check_health-723"><a href="#DShieldClient.check_health-723"><span class="linenos">723</span></a>
</span><span id="DShieldClient.check_health-724"><a href="#DShieldClient.check_health-724"><span class="linenos">724</span></a>            <span class="c1"># Make a simple health check request to test connectivity</span>
</span><span id="DShieldClient.check_health-725"><a href="#DShieldClient.check_health-725"><span class="linenos">725</span></a>            <span class="c1"># Use a simple endpoint that doesn&#39;t require authentication</span>
</span><span id="DShieldClient.check_health-726"><a href="#DShieldClient.check_health-726"><span class="linenos">726</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-727"><a href="#DShieldClient.check_health-727"><span class="linenos">727</span></a>                <span class="c1"># Try to access the base URL to test connectivity</span>
</span><span id="DShieldClient.check_health-728"><a href="#DShieldClient.check_health-728"><span class="linenos">728</span></a>                <span class="n">test_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
</span><span id="DShieldClient.check_health-729"><a href="#DShieldClient.check_health-729"><span class="linenos">729</span></a>
</span><span id="DShieldClient.check_health-730"><a href="#DShieldClient.check_health-730"><span class="linenos">730</span></a>                <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">test_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-731"><a href="#DShieldClient.check_health-731"><span class="linenos">731</span></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="DShieldClient.check_health-732"><a href="#DShieldClient.check_health-732"><span class="linenos">732</span></a>                        <span class="mi">200</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-733"><a href="#DShieldClient.check_health-733"><span class="linenos">733</span></a>                        <span class="mi">401</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-734"><a href="#DShieldClient.check_health-734"><span class="linenos">734</span></a>                        <span class="mi">403</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-735"><a href="#DShieldClient.check_health-735"><span class="linenos">735</span></a>                        <span class="mi">404</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-736"><a href="#DShieldClient.check_health-736"><span class="linenos">736</span></a>                    <span class="p">]:</span>  <span class="c1"># 404 means API is reachable but endpoint not found</span>
</span><span id="DShieldClient.check_health-737"><a href="#DShieldClient.check_health-737"><span class="linenos">737</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="DShieldClient.check_health-738"><a href="#DShieldClient.check_health-738"><span class="linenos">738</span></a>                            <span class="s2">&quot;DShield API connectivity test passed&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-739"><a href="#DShieldClient.check_health-739"><span class="linenos">739</span></a>                            <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-740"><a href="#DShieldClient.check_health-740"><span class="linenos">740</span></a>                            <span class="n">url</span><span class="o">=</span><span class="n">test_url</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-741"><a href="#DShieldClient.check_health-741"><span class="linenos">741</span></a>                        <span class="p">)</span>
</span><span id="DShieldClient.check_health-742"><a href="#DShieldClient.check_health-742"><span class="linenos">742</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="DShieldClient.check_health-743"><a href="#DShieldClient.check_health-743"><span class="linenos">743</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DShieldClient.check_health-744"><a href="#DShieldClient.check_health-744"><span class="linenos">744</span></a>                        <span class="s2">&quot;DShield API returned unexpected status&quot;</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-745"><a href="#DShieldClient.check_health-745"><span class="linenos">745</span></a>                        <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-746"><a href="#DShieldClient.check_health-746"><span class="linenos">746</span></a>                        <span class="n">url</span><span class="o">=</span><span class="n">test_url</span><span class="p">,</span>
</span><span id="DShieldClient.check_health-747"><a href="#DShieldClient.check_health-747"><span class="linenos">747</span></a>                    <span class="p">)</span>
</span><span id="DShieldClient.check_health-748"><a href="#DShieldClient.check_health-748"><span class="linenos">748</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient.check_health-749"><a href="#DShieldClient.check_health-749"><span class="linenos">749</span></a>
</span><span id="DShieldClient.check_health-750"><a href="#DShieldClient.check_health-750"><span class="linenos">750</span></a>            <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-751"><a href="#DShieldClient.check_health-751"><span class="linenos">751</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API connectivity test failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient.check_health-752"><a href="#DShieldClient.check_health-752"><span class="linenos">752</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient.check_health-753"><a href="#DShieldClient.check_health-753"><span class="linenos">753</span></a>            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-754"><a href="#DShieldClient.check_health-754"><span class="linenos">754</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API connectivity test timed out&quot;</span><span class="p">)</span>
</span><span id="DShieldClient.check_health-755"><a href="#DShieldClient.check_health-755"><span class="linenos">755</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="DShieldClient.check_health-756"><a href="#DShieldClient.check_health-756"><span class="linenos">756</span></a>
</span><span id="DShieldClient.check_health-757"><a href="#DShieldClient.check_health-757"><span class="linenos">757</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="DShieldClient.check_health-758"><a href="#DShieldClient.check_health-758"><span class="linenos">758</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DShield API health check failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="DShieldClient.check_health-759"><a href="#DShieldClient.check_health-759"><span class="linenos">759</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check DShield API connectivity and authentication.</p>

<p>Returns:
    bool: True if DShield API is healthy and accessible, False otherwise</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>